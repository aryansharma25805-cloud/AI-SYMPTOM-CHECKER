<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>SehatSetuNabha ‚Äî Patient Dashboard</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<!-- Add this in the <head> section -->
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script src="https://media.twiliocdn.com/sdk/js/video/releases/2.22.0/twilio-video.min.js"></script>
<style>

    /* Current problematic code */
@media (max-width:720px){
  .app{grid-template-columns:1fr;grid-template-rows:64px auto 1fr;grid-template-areas:"nav" "side" "main"}
  aside.side{display:flex;gap:8px;overflow-x:auto;padding:12px}
  /* This creates a horizontal scrollable sidebar which is poor UX */
}

/* Improved approach */
@media (max-width:768px) {
  .app {
    grid-template-columns: 1fr;
    grid-template-rows: 64px 1fr;
    grid-template-areas: 
      "nav"
      "main";
  }
  
  aside.side {
    position: fixed;
    left: -100%;
    top: 64px;
    bottom: 0;
    width: 80%;
    z-index: 1000;
    transition: left 0.3s ease;
    overflow-y: auto;
    flex-direction: column;
    padding: 1rem;
  }
  
  aside.side.mobile-open {
    left: 0;
  }
  
  /* Add overlay when menu is open */
  .overlay {
    display: none;
    position: fixed;
    top: 64px;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
    z-index: 999;
  }
  
  .overlay.active {
    display: block;
  }
}
  :root{
    --brand:#2c6d52;         /* deep teal */
    --accent:#53b89a;        /* light teal */
    --bg:#f4f7f6;
    --card:#ffffff;
    --muted:#6b7b70;
    --danger:#d9534f;
    --ok:#2f9b6a;
    --shadow: 0 10px 30px rgba(44,109,82,.08);
    --radius:14px;
    --glass: rgba(255,255,255,0.7);
    --transition: 280ms cubic-bezier(.2,.9,.2,1);
    --max-width:1200px;
  }

  /* Reset & layout */
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:Inter,Segoe UI,system-ui,-apple-system,Arial; background:var(--bg); color:#1f3328;}
  a{color:inherit;text-decoration:none}
  button{font:inherit}

  /* App shell - left sidebar + main */
  .app{
    display:grid;
    grid-template-columns:260px 1fr;
    grid-template-rows:64px 1fr;
    grid-template-areas: "nav nav" "side main";
    min-height:100vh;
  }

  /* NAV */
  header.nav{
    grid-area:nav;
    display:flex; align-items:center; justify-content:space-between;
    padding:0 20px;
    background: linear-gradient(90deg, var(--brand), var(--accent));
    color:#fff;
    box-shadow:0 6px 18px rgba(44,109,82,.22);
    position:sticky; top:0; z-index:20;
  }
  .brand{display:flex;align-items:center;gap:12px}
  .logo{width:42px;height:42px;border-radius:10px;display:grid;place-items:center;background:rgba(255,255,255,0.08);font-weight:800}
  .nav-right{display:flex;align-items:center;gap:12px}
  .chip{background:rgba(255,255,255,0.12);padding:7px 10px;border-radius:999px;font-weight:600}
  .chip{padding:6px 10px;border-radius:999px;background:#ffffff22;border:1px solid #ffffff44;font-size:.9rem}

  /* SIDEBAR */
  aside.side{
    grid-area:side; padding:18px; background:linear-gradient(180deg, #ffffffcc, #ffffff);
    border-right:1px solid #e6efe8; overflow:auto;
  }
  .side h3{color:var(--brand); margin:6px 6px 14px}
  .navlist{display:flex;flex-direction:column;gap:8px}
  .navitem{
    display:flex;align-items:center;gap:10px;padding:12px;border-radius:12px;cursor:pointer;
    transition: all 220ms ease; color: #153323; font-weight:700;
  }
  .navitem:hover{ background:#f1fbf7; transform:translateX(4px) }
  .navitem.active{ background:linear-gradient(90deg, #e9f7f1, #f6fffb); box-shadow:var(--shadow); border-left:4px solid var(--accent) }

  /* MAIN */
  main.main{grid-area:main;padding:20px;overflow:auto; display:flex; justify-content:center}
  .container{width:100%;max-width:var(--max-width);}

  .section{display:none; opacity:0; transform:translateY(6px); transition: all var(--transition); }
  .section.active{display:block; opacity:1; transform:none}

  .title{font-size:1.4rem;color:var(--brand);margin:0 0 12px;font-weight:700}
  .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px;margin-bottom:16px}
  .row{display:flex;gap:16px}
  .col{flex:1;min-width:0}
  .muted{color:var(--muted);font-size:0.95rem}

  /* --- DOCTORS TAB LAYOUT --- */
  /* Top hero (first div) - horizontal scroll of top doctors */
  .doctors-hero{display:flex;gap:14px;overflow-x:auto;padding-bottom:8px;margin-bottom:14px}
  .hero-card{
    min-width:260px;background:linear-gradient(180deg,#fff,#f7fffb);
    border-radius:12px;padding:14px;box-shadow:0 8px 20px rgba(40,120,100,.06);flex-shrink:0;
    transition:transform 220ms ease;
  }
  .hero-card:hover{ transform:translateY(-6px) }
  .hero-card .photo{width:84px;height:84px;border-radius:12px;background:#eaf7f0;display:inline-grid;place-items:center;font-weight:800;color:var(--brand); margin-bottom:10px}
  .rating{display:inline-flex;align-items:center;gap:8px;padding:6px 8px;border-radius:999px;background:#f1fbf7;color:var(--brand);font-weight:700}

  /* Second div: grid with available doctors left and visited/contact right */
  .doctors-grid{display:grid;grid-template-columns:1fr 360px;gap:16px}
  @media (max-width:980px){ .doctors-grid{grid-template-columns:1fr} }

  /* Available doctors list */
  .list-filter{display:flex;gap:8px;align-items:center;margin-bottom:12px}
  .input{padding:10px 12px;border-radius:10px;border:1.6px solid #e6efe8;flex:1}
  .pill{padding:8px 10px;border-radius:999px;border:1px solid #dfeee4;background:#fff;cursor:pointer;font-weight:700}
  .pill.active{background:linear-gradient(90deg,#eaf7f0,#ffffff);border-color:#cfe8de;color:var(--brand)}

  .doctor-row{display:flex;align-items:center;gap:12px;padding:10px;border-radius:10px;border:1px solid #eef6f2;margin-bottom:10px;transition:all 180ms}
  .doctor-row:hover{transform:translateY(-4px);box-shadow:0 10px 20px rgba(40,120,100,.06)}
  .doctor-avatar{width:56px;height:56px;border-radius:10px;background:#eaf7f0;display:grid;place-items:center;font-weight:800;color:var(--brand)}
  .doctor-info{flex:1}
  .status{font-weight:800;padding:6px 10px;border-radius:999px;background:#ecfff7;color:var(--ok)}
  .status.busy{background:#fff0f0;color:var(--danger)}

  .actions{display:flex;gap:8px}
  .btn{padding:8px 12px;border-radius:10px;border:0;background:var(--brand);color:#fff;font-weight:700;cursor:pointer}
  .btn.ghost{background:#f6fbf8;color:var(--brand);border:1px solid #dfeee4}

  /* Visited + Contact card */
  .sidebar-card{position:sticky;top:20px}
  .visited-item{padding:10px;border-radius:10px;border:1px solid #eef6f2;margin-bottom:10px;display:flex;gap:10px;align-items:center}
  .mini-map{height:140px;border-radius:10px;background:linear-gradient(180deg,#e9f7f1,#f7fffb);display:grid;place-items:center;color:var(--muted);font-weight:700}

  /* Profile / Symptom / Pharmacies / Contact content quick styling */
  .profile-grid{display:grid;grid-template-columns:280px 1fr;gap:16px}
  @media (max-width:980px){ .profile-grid{grid-template-columns:1fr} }
  .metric{padding:12px;border-radius:10px;background:#f7fff9;border:1px solid #e7f7ef;text-align:center}

  /* convenience small styles */
  .small{font-size:0.9rem;color:var(--muted)}
  .link{color:var(--brand);font-weight:700;cursor:pointer}
  .drawer{position:fixed;right:-540px;top:84px;width:520px;height:calc(100% - 120px);background:var(--card);box-shadow:-18px 0 40px rgba(0,0,0,.12);transition:right 320ms;z-index:40;border-top-left-radius:14px;overflow:auto;padding:16px}
  .drawer.open{right:20px}
  .drawer .close{background:#f6fbf8;border:1px solid #e6efe8;padding:8px 10px;border-radius:10px;cursor:pointer}
  
  /* Family member details panel */
  .family-member-panel {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 100;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
  }
  
  .family-member-panel.open {
    opacity: 1;
    visibility: visible;
  }
  
  .family-member-content {
    background: white;
    border-radius: var(--radius);
    width: 90%;
    max-width: 500px;
    padding: 20px;
    position: relative;
    transform: translateY(20px);
    transition: transform 0.3s ease;
    box-shadow: var(--shadow);
  }
  
  .family-member-panel.open .family-member-content {
    transform: translateY(0);
  }
  
  .family-member-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 1px solid #e6efe8;
  }
  
  .family-member-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: var(--muted);
  }
  
  .family-member-info {
    display: flex;
    gap: 15px;
    align-items: center;
    margin-bottom: 20px;
  }
  
  .family-member-avatar {
    width: 80px;
    height: 80px;
    border-radius: 12px;
    background: #eaf7f0;
    display: grid;
    place-items: center;
    font-weight: 800;
    color: var(--brand);
    font-size: 1.5rem;
  }
  
  .family-member-details {
    flex: 1;
  }
  
  .family-member-name {
    font-weight: 800;
    font-size: 1.2rem;
    margin-bottom: 5px;
  }
  
  .family-member-relation {
    color: var(--muted);
    margin-bottom: 5px;
  }
  
  .family-member-id {
    color: var(--muted);
    font-size: 0.9rem;
  }
  
  .family-member-medical {
    margin-bottom: 20px;
  }
  
  .family-member-section-title {
    font-weight: 700;
    margin-bottom: 10px;
    color: var(--brand);
  }
  
  .family-member-section {
    margin-bottom: 15px;
    padding-bottom: 15px;
    border-bottom: 1px solid #e6efe8;
  }
  
  .family-member-login-btn {
    width: 100%;
    padding: 12px;
    background: var(--brand);
    color: white;
    border: none;
    border-radius: 10px;
    font-weight: 700;
    cursor: pointer;
    margin-top: 10px;
  }
  
  .family-member-login-btn:hover {
    background: var(--accent);
  }
  
  /* Family member list items */
  .family-member-item {
    padding: 10px;
    border-radius: 8px;
    cursor: pointer;
    transition: background 0.2s ease;
    margin-bottom: 5px;
  }
  
  .family-member-item:hover {
    background: #f1fbf7;
  }
  
  /* Connect doctor modal */
  .connect-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 100;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
  }
  
  .connect-modal.open {
    opacity: 1;
    visibility: visible;
  }
  
  .connect-content {
    background: white;
    border-radius: var(--radius);
    width: 90%;
    max-width: 500px;
    padding: 20px;
    position: relative;
    transform: translateY(20px);
    transition: transform 0.3s ease;
    box-shadow: var(--shadow);
  }
  
  .connect-modal.open .connect-content {
    transform: translateY(0);
  }
  
  .connect-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 1px solid #e6efe8;
  }
  
  .connect-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: var(--muted);
  }
  
  .language-selector {
    display: flex;
    gap: 8px;
    margin-bottom: 15px;
  }
  
  .lang-btn {
    padding: 8px 12px;
    border-radius: 8px;
    border: 1px solid #dfeee4;
    background: #fff;
    cursor: pointer;
    font-weight: 600;
  }
  
  .lang-btn.active {
    background: var(--brand);
    color: white;
    border-color: var(--brand);
  }
  
  .problem-input {
    width: 100%;
    min-height: 150px;
    padding: 12px;
    border-radius: 10px;
    border: 1px solid #e6efe8;
    margin-bottom: 15px;
    font-family: inherit;
    resize: vertical;
  }
  
  /* Voice recording styles */
  .voice-recorder {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 12px;
    margin-top: 10px;
  }
  
  .language-selector-symptom {
    display: flex;
    gap: 8px;
    margin-bottom: 10px;
  }
  
  .recording-indicator {
    display: flex;
    align-items: center;
    gap: 8px;
    color: var(--danger);
    font-weight: 600;
  }
  
  .recording-dot {
    width: 12px;
    height: 12px;
    background-color: var(--danger);
    border-radius: 50%;
    animation: pulse 1.5s infinite;
  }
  
  @keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.4; }
    100% { opacity: 1; }
  }
  
  .translation-status {
    margin-top: 10px;
    padding: 8px 12px;
    background-color: #f1fbf7;
    border-radius: 8px;
    font-size: 0.9rem;
    color: var(--muted);
  }
  
  /* responsive */
  @media (max-width:720px){
    .app{grid-template-columns:1fr;grid-template-rows:64px auto 1fr;grid-template-areas:"nav" "side" "main"}
    aside.side{display:flex;gap:8px;overflow-x:auto;padding:12px}
    .navitem{white-space:nowrap;padding:10px 12px}
    header.nav{padding:0 12px}
    .drawer{width:100%;right:-100%;top:64px;height:calc(100% - 64px);border-radius:0}
    .drawer.open{right:0}
    
    .family-member-content {
      width: 95%;
      padding: 15px;
    }
    
    .family-member-info {
      flex-direction: column;
      text-align: center;
    }
    
    .connect-content {
      width: 95%;
      padding: 15px;
    }
  }

  /* Additional styles for the enhanced profile section */
  .edit-icon {
    position: absolute;
    bottom: 4px;
    right: 4px;
    background: var(--brand);
    color: white;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  }
  
  .editable-field {
    position: relative;
  }
  
  .family-member-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid #f0f0f0;
  }
  
  .family-member-item:last-child {
    border-bottom: none;
  }
  
  .member-actions {
    display: flex;
    gap: 8px;
  }
  
  .icon-btn {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 14px;
    padding: 4px;
  }
  
  .small-btn {
    padding: 4px 8px;
    font-size: 0.8rem;
  }
  /* Enhanced doctors section for mobile */
@media (max-width: 980px) { 
  .doctors-grid {
    grid-template-columns: 1fr;
  }
  
  .doctor-row {
    flex-direction: column;
    text-align: center;
    padding: 16px;
  }
  
  .doctor-info {
    margin: 12px 0;
  }
  
  .actions {
    justify-content: center;
    width: 100%;
  }
  
  .hero-card {
    min-width: 220px;
  }
}

@media (max-width: 640px) {
  .list-filter {
    flex-direction: column;
    gap: 12px;
  }
  
  .hero-card {
    min-width: 200px;
  }
  
  .hero-card .photo {
    width: 64px;
    height: 64px;
    font-size: 0.9rem;
  }
}
/* Enhanced alerts section */
.alerts-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  gap: 16px;
  margin-top: 20px;
}

.alert-card {
  padding: 16px;
  border-left: 4px solid var(--ok);
  background: white;
  border-radius: var(--radius);
  box-shadow: var(--shadow);
}

.alert-card.urgent {
  border-left-color: var(--danger);
}

.alert-card.warning {
  border-left-color: #ff9800;
}

.alert-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
}

.alert-title {
  font-weight: 700;
  font-size: 1.1rem;
}

.alert-badge {
  padding: 4px 8px;
  border-radius: 20px;
  font-size: 0.75rem;
  font-weight: 600;
}

.badge-urgent {
  background: #ffebee;
  color: var(--danger);
}

.badge-warning {
  background: #fff3e0;
  color: #ff9800;
}

.badge-info {
  background: #e3f2fd;
  color: #1976d2;
}

/* Responsive alerts */
@media (max-width: 768px) {
  .alerts-grid {
    grid-template-columns: 1fr;
  }
  
  .alert-actions {
    flex-direction: column;
    gap: 8px;
  }
  
  .alert-actions .btn {
    width: 100%;
    text-align: center;
  }
}

/* Alert items */
.alert-item {
  padding: 16px;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: flex-start;
  gap: 12px;
}

.alert-item:last-child {
  border-bottom: none;
}

.alert-icon {
  font-size: 1.5rem;
  width: 40px;
  height: 40px;
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.alert-content {
  flex: 1;
}

.alert-title {
  font-weight: 600;
  margin-bottom: 4px;
}

.alert-desc {
  font-size: 0.9rem;
  color: var(--muted);
  margin-bottom: 8px;
}

.alert-time {
  font-size: 0.8rem;
  color: var(--muted);
}

.alert-actions {
  display: flex;
  gap: 8px;
}

/* Modal styles */
.family-member-panel {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  padding: 20px;
}

.family-member-content {
  background: white;
  border-radius: 12px;
  width: 100%;
  max-width: 600px;
  overflow: hidden;
}

.family-member-header {
  padding: 16px 20px;
  border-bottom: 1px solid var(--border);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.family-member-close {
  background: none;
  border: none;
  font-size: 1.5rem;
  cursor: pointer;
  color: var(--muted);
}

.hidden {
  display: none;
}

/* Payment method selection */
.payment-methods {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 10px;
  margin-bottom: 20px;
}

.payment-method {
  border: 2px solid var(--border);
  border-radius: 8px;
  padding: 12px;
  text-align: center;
  cursor: pointer;
  transition: all 0.2s;
}

.payment-method.selected {
  border-color: var(--brand);
  background-color: rgba(24, 144, 255, 0.05);
}

.payment-method-icon {
  font-size: 2rem;
  margin-bottom: 8px;
}

/* Consultation interface */
.consultation-tools {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 10px;
}

.consultation-tool-btn {
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 12px;
  border: 1px solid var(--border);
  border-radius: 8px;
  background: white;
  cursor: pointer;
  transition: all 0.2s;
}

.consultation-tool-btn:hover {
  border-color: var(--brand);
  background: rgba(24, 144, 255, 0.05);
}

/* Digital Records Styles */
.record-item {
  padding: 16px;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: flex-start;
  gap: 12px;
  cursor: pointer;
  transition: all 0.2s ease;
}

.record-item:hover {
  background-color: #f9f9f9;
}

.record-item:last-child {
  border-bottom: none;
}

.record-icon {
  font-size: 1.8rem;
  width: 50px;
  height: 50px;
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: #f0f9ff;
  color: #1890ff;
}

.record-content {
  flex: 1;
}

.record-title {
  font-weight: 600;
  margin-bottom: 4px;
}

.record-details {
  font-size: 0.9rem;
  color: var(--muted);
  margin-bottom: 8px;
}

.record-meta {
  display: flex;
  gap: 12px;
  font-size: 0.8rem;
  color: var(--muted);
}

.record-actions {
  display: flex;
  flex-direction: column;
  gap: 8px;
  align-items: flex-end;
}

.record-file-size {
  font-size: 0.8rem;
  color: var(--muted);
}

.record-detail-modal {
  max-width: 800px;
  width: 100%;
}

.record-detail-content {
  max-height: 70vh;
  overflow-y: auto;
}

.record-section {
  margin-bottom: 20px;
}

.record-section-title {
  font-weight: 700;
  margin-bottom: 10px;
  font-size: 1.1rem;
  color: var(--brand);
}

.test-result {
  padding: 10px 0;
  border-bottom: 1px solid #f0f0f0;
}

.test-result:last-child {
  border-bottom: none;
}

.test-name {
  font-weight: 600;
  margin-bottom: 4px;
}

.test-value {
  display: flex;
  justify-content: space-between;
  margin-bottom: 4px;
}

.test-range {
  font-size: 0.85rem;
  color: var(--muted);
}

.test-status {
  font-weight: 600;
  font-size: 0.85rem;
}

.test-status.normal {
  color: var(--ok);
}

.test-status.abnormal {
  color: var(--danger);
}

.test-status.borderline {
  color: #ff9800;
}

.medication-item {
  display: flex;
  justify-content: space-between;
  padding: 8px 0;
  border-bottom: 1px solid #f0f0f0;
}

.medication-item:last-child {
  border-bottom: none;
}

.medication-name {
  font-weight: 600;
}

.medication-dosage {
  font-size: 0.9rem;
  color: var(--muted);
}

.download-progress {
  height: 4px;
  background-color: #f0f0f0;
  border-radius: 2px;
  margin-top: 8px;
  overflow: hidden;
}

.download-progress-bar {
  height: 100%;
  background-color: var(--brand);
  width: 0%;
  transition: width 0.3s ease;
}

/* Chat styles */
.chat-container {
  display: flex;
  flex-direction: column;
  height: 100%;
}

.chat-header {
  padding: 12px 16px;
  border-bottom: 1px solid var(--border);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.chat-title {
  font-weight: 600;
}

.chat-status {
  font-size: 0.8rem;
  color: var(--muted);
}

.chat-messages {
  flex: 1;
  overflow-y: auto;
  padding: 16px;
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.chat-message {
  display: flex;
  max-width: 80%;
}

.chat-message.sent {
  align-self: flex-end;
}

.chat-message.received {
  align-self: flex-start;
}

.chat-bubble {
  padding: 12px 16px;
  border-radius: 18px;
  position: relative;
}

.chat-message.sent .chat-bubble {
  background-color: var(--brand);
  color: white;
  border-bottom-right-radius: 4px;
}

.chat-message.received .chat-bubble {
  background-color: #f1f1f1;
  color: var(--text);
  border-bottom-left-radius: 4px;
}

.chat-message-text {
  word-wrap: break-word;
}

.chat-message-time {
  font-size: 0.7rem;
  color: rgba(0, 0, 0, 0.5);
  margin-top: 4px;
  text-align: right;
}

.chat-message.received .chat-message-time {
  color: rgba(0, 0, 0, 0.4);
}

.chat-input-container {
  padding: 12px 16px;
  border-top: 1px solid var(--border);
  display: flex;
  gap: 8px;
}

.chat-input {
  flex: 1;
  padding: 10px 16px;
  border-radius: 20px;
  border: 1px solid var(--border);
  font-size: 0.95rem;
}

.chat-send-button {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background-color: var(--brand);
  color: white;
  border: none;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
}

.chat-attachment-button {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background-color: white;
  color: var(--muted);
  border: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
}

.chat-typing-indicator {
  display: flex;
  align-items: center;
  padding: 8px 16px;
  background-color: #f1f1f1;
  border-radius: 18px;
  width: fit-content;
}

.chat-typing-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background-color: #999;
  margin: 0 2px;
  animation: typing 1.4s infinite;
}

.chat-typing-dot:nth-child(2) {
  animation-delay: 0.2s;
}

.chat-typing-dot:nth-child(3) {
  animation-delay: 0.4s;
}

@keyframes typing {
  0%, 60%, 100% {
    transform: translateY(0);
  }
  30% {
    transform: translateY(-10px);
  }
}

/* File attachment styles */
.file-attachment {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 12px;
  background-color: #f1f1f1;
  border-radius: 8px;
  margin-top: 8px;
}

.file-icon {
  font-size: 1.2rem;
}

.file-name {
  font-size: 0.9rem;
  font-weight: 500;
}

.file-size {
  font-size: 0.8rem;
  color: var(--muted);
}

.file-download {
  margin-left: auto;
  color: var(--brand);
  cursor: pointer;
}

/* Notification styles */
.notification {
  position: fixed;
  top: 20px;
  right: 20px;
  padding: 16px 20px;
  background-color: white;
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  z-index: 1000;
  display: flex;
  align-items: center;
  gap: 12px;
  max-width: 350px;
  transform: translateX(400px);
  transition: transform 0.3s ease;
}

.notification.show {
  transform: translateX(0);
}

.notification-icon {
  font-size: 1.5rem;
}

.notification-content {
  flex: 1;
}

.notification-title {
  font-weight: 600;
  margin-bottom: 4px;
}

.notification-message {
  font-size: 0.9rem;
  color: var(--muted);
}

.notification-close {
  background: none;
  border: none;
  font-size: 1.2rem;
  cursor: pointer;
  color: var(--muted);
}

.notification.success .notification-icon {
  color: var(--ok);
}

.notification.error .notification-icon {
  color: var(--danger);
}

.notification.warning .notification-icon {
  color: #ff9800;
}

.notification.info .notification-icon {
  color: #1890ff;
}

/* Loading spinner */
.loading-spinner {
  display: inline-block;
  width: 20px;
  height: 20px;
  border: 3px solid rgba(0, 0, 0, 0.1);
  border-radius: 50%;
  border-top-color: var(--brand);
  animation: spin 1s ease-in-out infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* Button with loading state */
.btn-loading {
  position: relative;
  color: transparent;
}

.btn-loading .loading-spinner {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 16px;
  height: 16px;
}

/* Symptom Checker Styles */
.symptom-header {
  margin-bottom: 24px;
}

.symptom-main-container {
  display: grid;
  grid-template-columns: 1fr 1.5fr;
  gap: 24px;
  margin-bottom: 24px;
}

@media (max-width: 980px) {
  .symptom-main-container {
    grid-template-columns: 1fr;
  }
}

.symptom-input-container {
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.recorder-card {
  background: var(--card);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  padding: 24px;
  display: flex;
  flex-direction: column;
  gap: 20px;
}

.live-box {
  min-height: 120px;
  padding: 16px;
  background: var(--bg);
  border-radius: 10px;
  font-size: 1rem;
  line-height: 1.5;
  color: var(--muted);
}

.recording-status {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 16px;
  background: rgba(217, 83, 79, 0.1);
  border-radius: 8px;
  border-left: 4px solid var(--danger);
}

.recording-indicator {
  display: flex;
  align-items: center;
  gap: 8px;
  color: var(--danger);
  font-weight: 600;
}

.recording-dot {
  width: 12px;
  height: 12px;
  background-color: var(--danger);
  border-radius: 50%;
  animation: pulse 1.5s infinite;
}

@keyframes pulse {
  0% { opacity: 1; }
  50% { opacity: 0.4; }
  100% { opacity: 1; }
}

.recording-timer {
  font-family: monospace;
  font-weight: 700;
  color: var(--danger);
}

.mic-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 12px;
  margin: 10px 0;
}

.mic-button {
  width: 100px;
  height: 100px;
  border-radius: 50%;
  background: var(--brand);
  color: white;
  border: none;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 2.5rem;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 6px 16px rgba(44, 109, 82, 0.3);
}

.mic-button:hover {
  transform: scale(1.05);
  box-shadow: 0 8px 20px rgba(44, 109, 82, 0.4);
}

.mic-button:active {
  transform: scale(0.98);
}

.mic-button.recording {
  background: var(--danger);
  animation: pulse-mic 1.5s infinite;
}

@keyframes pulse-mic {
  0% { box-shadow: 0 0 0 0 rgba(217, 83, 79, 0.7); }
  70% { box-shadow: 0 0 0 15px rgba(217, 83, 79, 0); }
  100% { box-shadow: 0 0 0 0 rgba(217, 83, 79, 0); }
}

.mic-label {
  font-weight: 600;
  color: var(--muted);
}

.controls {
  display: flex;
  gap: 12px;
  justify-content: center;
}

.language-selector {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-top: 8px;
}

.language-select {
  padding: 8px 12px;
  border-radius: 8px;
  border: 1px solid var(--border);
  background: white;
  font-family: inherit;
  font-size: 0.95rem;
  min-width: 150px;
}

.voice-options {
  background: var(--card);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  padding: 20px;
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.voice-option {
  display: flex;
  align-items: center;
  gap: 8px;
  font-weight: 600;
  cursor: pointer;
}

.voice-selection {
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
  align-items: center;
}

.voice-select-dropdown {
  padding: 8px 12px;
  border-radius: 8px;
  border: 1px solid var(--border);
  background: white;
  font-family: inherit;
  font-size: 0.95rem;
  min-width: 200px;
  flex: 1;
}

.chat-area {
  background: var(--card);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  padding: 20px;
  display: flex;
  flex-direction: column;
  height: 500px;
}

.chat-messages {
  flex: 1;
  overflow-y: auto;
  margin-bottom: 16px;
  padding-right: 8px;
}

.chat-message {
  margin-bottom: 16px;
  display: flex;
  flex-direction: column;
}

.chat-message.user {
  align-items: flex-end;
}

.chat-message.ai {
  align-items: flex-start;
}

.message-bubble {
  max-width: 80%;
  padding: 12px 16px;
  border-radius: 18px;
  word-wrap: break-word;
}

.chat-message.user .message-bubble {
  background-color: var(--brand);
  color: white;
  border-bottom-right-radius: 4px;
}

.chat-message.ai .message-bubble {
  background-color: #f1f1f1;
  color: var(--text);
  border-bottom-left-radius: 4px;
}

.message-time {
  font-size: 0.75rem;
  color: rgba(0, 0, 0, 0.5);
  margin-top: 4px;
}

.chat-message.ai .message-time {
  color: rgba(0, 0, 0, 0.4);
}

.typing-indicator {
  padding: 16px;
  border-radius: 18px;
  background-color: #f1f1f1;
  color: var(--text);
  width: fit-content;
}

.msg-header {
  display: flex;
  align-items: center;
  gap: 8px;
  font-weight: 600;
  margin-bottom: 8px;
}

.typing-dots {
  display: flex;
  gap: 4px;
}

.typing-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background-color: #999;
  animation: typing 1.4s infinite;
}

.typing-dot:nth-child(2) {
  animation-delay: 0.2s;
}

.typing-dot:nth-child(3) {
  animation-delay: 0.4s;
}

@keyframes typing {
  0%, 60%, 100% {
    transform: translateY(0);
  }
  30% {
    transform: translateY(-10px);
  }
}

.symptom-disclaimer {
  text-align: center;
  padding: 16px;
  color: var(--muted);
  background: rgba(44, 109, 82, 0.05);
  border-radius: 8px;
  margin-top: 20px;
}

.btn.small {
  padding: 6px 12px;
  font-size: 0.9rem;
}

.btn.secondary {
  background: transparent;
  color: var(--brand);
  border: 1px solid var(--brand);
}

.btn.secondary:hover {
  background: rgba(44, 109, 82, 0.05);
}

/* Responsive adjustments */
@media (max-width: 720px) {
  .mic-button {
    width: 80px;
    height: 80px;
    font-size: 2rem;
  }
  
  .controls {
    flex-direction: column;
  }
  
  .voice-selection {
    flex-direction: column;
    align-items: flex-start;
  }
  
  .voice-select-dropdown {
    width: 100%;
  }
}

</style>
</head>
<body>
  <div class="app">
    <!-- NAV -->
    <header class="nav">
      <div class="brand">
        <div class="logo">üíö</div>
        <div>
          <div style="font-weight:800">SehatSetuNabha</div>
          <div style="font-size:12px;opacity:.9">Patient Portal</div>
        </div>
      </div>
      <div class="nav-right">
        <div class="chip">Hi, <strong id="patTopName">Gurpreet</strong></div>
        <span class="chip hide-md">Patient Id: <strong id="phIdTop">Pa-7781ad</strong></span>
        <button class="btn" onclick="toggleSide()">‚ò∞</button>
      </div>
    </header>

    <!-- SIDEBAR -->
    <aside class="side" aria-label="Main navigation">
      <h3>Patient</h3>
      <nav class="navlist" role="tablist">
        <div class="navitem" data-tab="profile" role="tab" aria-selected="false">üë§ <span class="hide-md">Profile</span></div>
        <div class="navitem" data-tab="doctors" role="tab">üßëüèª‚Äç‚öïÔ∏è<span class="hide-md">Doctors</span></div>
        <div class="navitem" data-tab="symptom" role="tab">üîç <span class="hide-md">Sympton Checker</span></div>
        <div class="navitem active" data-tab="alerts" role="tab" aria-selected="true">üîî <span class="hide-md">Alerts & Follow-up</span></div>
        <div class="navitem" data-tab="records" role="tab">üìÅ <span class="hide-md">Digital Records</span></div>
        <div class="navitem" data-tab="pharmacies" role="tab">üíä<span class="hide-md">Pharmacies</span></div>
        <div class="navitem" data-tab="contact" role="tab">üìû<span class="hide-md">Emergency SOS</span></div>
      </nav>
    </aside>

    <!-- MAIN -->
    <main class="main" role="main">
      <div class="container">
        <!-- PROFILE -->
<section id="profile" class="section" aria-labelledby="profile-tab">
  <!-- Title and Edit/Save buttons on the same row -->
  <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
    <h2 class="title" style="margin: 0; flex: 1;">Your Profile</h2>
    <div style="display: flex; gap: 8px;">
      <button id="editProfileBtn" class="btn" onclick="toggleEditMode(true)">Edit Profile</button>
      <button id="saveProfileBtn" class="btn" style="display: none; background-color: var(--brand);" onclick="saveProfileChanges()">Save Changes</button>
      <button id="cancelEditBtn" class="btn" style="display: none;" onclick="toggleEditMode(false)">Cancel</button>
    </div>
  </div>
  <div class="card profile-grid">
            <div>
              <div style="display:flex;gap:12px;align-items:center">
                <!-- Profile image with edit indicator -->
                <div style="position: relative;">
                  <div style="width:110px;height:110px;border-radius:12px;background:#eaf7f0;
                    display:grid;place-items:center;font-weight:800;color:var(--brand);
                    cursor:pointer;overflow:hidden;position:relative"
                    onclick="document.getElementById('fileInput').click()">
        
                    <!-- Default initials -->
                    <span id="profile-initials">GK</span>
                    
                    <!-- Uploaded image preview -->
                    <img id="profile-img" src="" alt="Profile" 
                        style="width:100%;height:100%;object-fit:cover;display:none;border-radius:12px"/>
                  </div>
                  
                  <!-- Edit icon (only shown in edit mode) -->
                  <div id="profileImageEditIcon" class="edit-icon" style="display: none;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                      <path d="M12.146 3.146a.5.5 0 0 1 .708 0l2 2a.5.5 0 0 1 0 .708l-9 9a.5.5 0 0 1-.708 0l-2-2a.5.5 0 0 1 0-.708l9-9z"/>
                      <path d="M12.146 3.146a.5.5 0 0 1 .708 0l2 2a.5.5 0 0 1 0 .708l-9 9a.5.5 0 0 1-.708 0l-2-2a.5.5 0 0 1 0-.708l9-9zM10.5 5.5l.5.5a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708 0l-.5-.5a.5.5 0 0 1 0-.708l7-7a.5.5 0 0 1 .708 0z"/>
                    </svg>
                  </div>
                </div>
        
                <!-- Hidden file input -->
                <input type="file" id="fileInput" accept="image/*" style="display:none" 
                      onchange="previewImage(event)" />
        
                <div>
                  <!-- Editable name field -->
                  <div class="editable-field">
                    <div id="profile-name-display" style="font-weight:800;font-size:1.1rem">Gurpreet Kaur</div>
                    <input id="profile-name-edit" type="text" style="display: none; font-weight:800;font-size:1.1rem; 
                          border: 1px solid var(--border); padding: 4px 8px; border-radius: 4px; width: 100%;" 
                          value="Gurpreet Kaur">
                  </div>
                  
                  <!-- Editable details -->
                  <div class="small editable-field">
                    <span id="profile-details-display">PAT-0001 ‚Ä¢ Age 32 ‚Ä¢ Female ‚Ä¢ Nabha, Punjab</span>
                    <div id="profile-details-edit" style="display: none; margin-top: 8px;">
                      <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <input type="text" id="patient-id-edit" value="PAT-0001" style="width: 100px; border: 1px solid var(--border); padding: 4px 8px; border-radius: 4px;">
                        <input type="number" id="age-edit" value="32" style="width: 60px; border: 1px solid var(--border); padding: 4px 8px; border-radius: 4px;">
                        <select id="gender-edit" style="border: 1px solid var(--border); padding: 4px 8px; border-radius: 4px;">
                          <option value="Female" selected>Female</option>
                          <option value="Male">Male</option>
                          <option value="Other">Other</option>
                        </select>
                        <input type="text" id="location-edit" value="Nabha, Punjab" style="width: 120px; border: 1px solid var(--border); padding: 4px 8px; border-radius: 4px;">
                      </div>
                    </div>
                  </div>
                </div>
              </div>
        
              <!-- Family section with edit options -->
              <div style="margin-top:12px" class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom:8px">
                  <div style="font-weight:800;">Family</div>
                  <button id="addFamilyMemberBtn" class="btn small-btn" style="display: none;" onclick="addFamilyMember()">+ Add Member</button>
                </div>
                
                <div id="family-members-list">
                  <div class="family-member-item" data-member="harjit">
                    <span>Harjit Singh (Husband)</span>
                    <div class="member-actions" style="display: none;">
                      <button class="icon-btn" onclick="editFamilyMember(this.parentElement.parentElement)">‚úèÔ∏è</button>
                      <button class="icon-btn" onclick="removeFamilyMember(this.parentElement.parentElement)">üóëÔ∏è</button>
                    </div>
                  </div>
                  <div class="family-member-item" data-member="simran">
                    <span>Simran Kaur (Daughter)</span>
                    <div class="member-actions" style="display: none;">
                      <button class="icon-btn" onclick="editFamilyMember(this.parentElement.parentElement)">‚úèÔ∏è</button>
                      <button class="icon-btn" onclick="removeFamilyMember(this.parentElement.parentElement)">üóëÔ∏è</button>
                    </div>
                  </div>
                </div>
                
                <!-- Add family member form (hidden by default) -->
                <div id="add-family-form" style="display: none; margin-top: 12px; padding: 12px; background: #f9f9f9; border-radius: 8px;">
                  <div style="display: flex; gap: 8px; flex-wrap: wrap; align-items: center;">
                    <input type="text" id="new-member-name" placeholder="Name" style="flex: 1; border: 1px solid var(--border); padding: 6px 10px; border-radius: 4px;">
                    <input type="text" id="new-member-relation" placeholder="Relation" style="flex: 1; border: 1px solid var(--border); padding: 6px 10px; border-radius: 4px;">
                    <button class="btn small-btn" onclick="saveNewFamilyMember()">Save</button>
                    <button class="btn small-btn" onclick="cancelAddFamilyMember()">Cancel</button>
                  </div>
                </div>
              </div>
        
              <!-- Medical History section with edit options -->
              <div style="margin-top:12px" class="card">
                <div style="font-weight:800;margin-bottom:8px">Medical History</div>
                <div class="editable-field">
                  <div id="medical-history-display" class="small">No chronic conditions recorded ‚Ä¢ Allergies: None</div>
                  <div id="medical-history-edit" style="display: none;">
                    <div style="margin-bottom: 8px;">
                      <label class="small">Chronic Conditions:</label>
                      <textarea id="conditions-edit" style="width: 100%; border: 1px solid var(--border); padding: 6px 10px; border-radius: 4px; resize: vertical; min-height: 60px;">No chronic conditions recorded</textarea>
                    </div>
                    <div>
                      <label class="small">Allergies:</label>
                      <input type="text" id="allergies-edit" value="None" style="width: 100%; border: 1px solid var(--border); padding: 6px 10px; border-radius: 4px;">
                    </div>
                  </div>
                </div>
              </div>
            </div>
        
            <div>
              <!-- Upcoming appointment section -->
              <div class="card">
                <div style="display:flex;gap:12px;align-items:center;justify-content:space-between">
                  <div>
                    <div style="font-weight:800">Upcoming appointment</div>
                    <div class="small">15 Sep 2025 ‚Ä¢ 10:00 AM with Dr. Amanpreet</div>
                  </div>
                  <div><button class="btn" onclick="showAppointmentDetails()">Details</button></div>
                </div>
              </div>
        
              <!-- Recent Blood Report section -->
              <div class="card" style="margin-top:12px">
                <div style="font-weight:800;margin-bottom:8px">Recent Blood Report</div>
                
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
                  <div class="card metric">
                    <div class="small">Total Cholesterol</div>
                    <div style="font-weight:800;font-size:1.1rem">182 mg/dL</div>
                  </div>
                  <div class="card metric">
                    <div class="small">Vitamin D</div>
                    <div style="font-weight:800;font-size:1.1rem">Slight Deficiency</div>
                  </div>
                  <div class="card metric">
                    <div class="small">Hemoglobin</div>
                    <div style="font-weight:800;font-size:1.1rem">13.5 g/dL</div>
                  </div>
                  <div class="card metric">
                    <div class="small">Blood Sugar (Fasting)</div>
                    <div style="font-weight:800;font-size:1.1rem">92 mg/dL</div>
                  </div>
                </div>
              
                <div style="margin-top:12px;text-align:right">
                  <a href="reports/blood_report.pdf" target="_blank" class="btn">View Full Report</a>
                </div>
              </div>
              
              <!-- Recent Prescriptions section -->
              <div class="card" style="margin-top:12px">
                <div style="font-weight:800;margin-bottom:8px">Recent Prescriptions</div>
                <ul style="margin:0 0 0 16px" class="small">
                  <li>Paracetamol 500mg ‚Äî 2025-08-10</li>
                  <li>Salbutamol inhaler ‚Äî 2025-06-18</li>
                </ul>
                <div style="margin-top:10px"><a class="link" onclick="openTab('doctors')">Find doctor again ‚Üí</a></div>
              </div>
            </div>
          </div>
        </section>

        <!-- DOCTORS (single tab with first div + second div below) -->
        <section id="doctors" class="section" aria-labelledby="doctors-tab">
          <h2 class="title">Doctors</h2>

          <!-- FIRST DIV: HERO / TOP DOCTORS (horizontal) -->
          <div class="card">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
              <div style="font-weight:800">Top Doctors</div>
              <div class="small muted">Hand-picked specialists near you</div>
            </div>

            <div class="doctors-hero" id="topDoctorsHero" aria-hidden="false">
              <!-- JS will populate hero cards -->
            </div>
          </div>

          <!-- SECOND DIV: main grid below with available / visited & contact -->
          <div class="doctors-grid">
            <!-- LEFT: Available doctors + search & filters -->
            <div>
              <div class="card">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
                  <div style="font-weight:800">Available Doctors</div>
                  <div class="small muted">Online now ‚Ä¢ click to connect</div>
                </div>

                <div class="list-filter">
                  <input id="docSearch" class="input" placeholder="Search doctors (name, speciality)" oninput="renderAvailable()"/>
                  <div style="display:flex;gap:8px">
                    <button class="pill active" data-filter="all" onclick="setDoctorFilter(this)">All</button>
                    <button class="pill" data-filter="online" onclick="setDoctorFilter(this)">Online</button>
                    <button class="pill" data-filter="special" onclick="setDoctorFilter(this)">Specialists</button>
                  </div>
                </div>

                <div id="availableList">
                  <!-- JS populates available doctors -->
                </div>

              </div>

              <div class="card" style="margin-top:12px">
                <div style="display:flex;justify-content:space-between;align-items:center">
                  <div style="font-weight:800">Clinics Map</div>
                  <div class="small muted">Clinic locations</div>
                </div>
                <div style="height:500px;border-radius:12px;" id="clinicMap">Map placeholder</div>
              </div>
            </div>

            <!-- RIGHT: Visited doctors + contact / last visited -->
            <div>
              <div class="card sidebar-card">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
                  <div style="font-weight:800">Last Visited</div>
                  <div class="small muted">Quick actions</div>
                </div>

                <div style="display:flex;gap:12px;align-items:center;margin-bottom:8px">
                  <div style="width:64px;height:64px;border-radius:8px;background:#eaf7f0;display:grid;place-items:center;font-weight:800;color:var(--brand)">AS</div>
                  <div style="flex:1">
                    <div style="font-weight:800">Dr. Amanpreet Singh</div>
                    <div class="small muted">General Physician ‚Ä¢ DOC-14237</div>
                  </div>
                </div>

                <div style="display:flex;gap:8px;margin-top:8px">
                  <button class="btn" onclick="openConnectModal('DOC-14237', 'Dr. Amanpreet Singh')">Connect</button>
                </div>
              </div>

              <div class="card" style="margin-top:12px">
                <div style="font-weight:800;margin-bottom:10px">Visited Doctors</div>
                <div id="visitedList">
                  <!-- JS populates visited doctors -->
                </div>
              </div>

              <div class="card" style="margin-top:12px">
                <div style="font-weight:800;margin-bottom:8px">Contact & Notifications</div>
                <div class="small muted">If a doctor accepts your request they'll get notified and can call you back when free.</div>
                <div style="margin-top:10px">
                  <button class="btn" onclick="showNotification('info', 'Request Sent', 'Your request has been sent to the selected doctor')">Send Request</button>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- SYMPTOM CHECKER -->
        <!-- SYMPTOM CHECKER -->
<section id="symptom" class="section" aria-labelledby="symptom-tab">
    <div class="symptom-header">
      <h2 class="title"><i class="fas fa-stethoscope"></i> AI Symptom Checker</h2>
      <p class="muted">Describe your symptoms clearly and our AI will help assess possible conditions</p>
    </div>
    
    <div class="symptom-main-container">
      <div class="symptom-input-container">
        <div class="recorder-card">
          <div class="live-box" id="liveBox">
            <div class="placeholder">Describe your symptoms clearly. For example: "I have had a headache and fever since yesterday."</div>
          </div>
          
          <div class="recording-status" id="recordingStatus" style="display: none;">
            <div class="recording-indicator">
              <div class="recording-dot"></div>
              <span>Recording in progress...</span>
            </div>
            <div class="recording-timer" id="recordingTimer">00:00</div>
          </div>
          
          <div class="mic-container">
            <button class="mic-button" id="startBtn">
              <i class="fas fa-microphone"></i>
            </button>
            <div class="mic-label">Tap to speak</div>
          </div>
          
          <div class="controls">
            <button class="btn secondary" id="stopBtn" disabled>
              <i class="fas fa-stop"></i> Stop
            </button>
            <button class="btn secondary" id="clearBtn">
              <i class="fas fa-trash-alt"></i> Clear
            </button>
          </div>
  
          <!-- Language selector -->
          <div class="language-selector">
            <label for="langSelect"><b>Language:</b></label>
            <select id="langSelect" class="language-select">
              <option value="en" selected>English</option>
              <option value="hi">‡§π‡§ø‡§Ç‡§¶‡•Ä (Hindi)</option>
              <option value="pa">‡®™‡©∞‡®ú‡®æ‡®¨‡©Ä (Punjabi)</option>
            </select>
          </div>
        </div>
        
        <div class="voice-options">
          <label class="voice-option">
            <input type="checkbox" id="mascotSpeak" checked/>
            <i class="fas fa-volume-up"></i> Voice Assistant
          </label>
          
          <div class="voice-selection">
            <label for="voiceSelect"><b>Voice:</b></label>
            <select id="voiceSelect" class="voice-select-dropdown"></select>
            <button id="testVoiceBtn" class="btn small">Test Voice</button>
          </div>
        </div>
      </div>
      
      <div class="chat-area" id="chatArea">
        <div class="chat-messages" id="chatMessages"></div>
        <div class="typing-indicator" id="typingIndicator" style="display: none;">
          <div class="msg-header">
            <i class="fas fa-robot"></i><span>Health Assistant</span>
          </div>
          <div class="typing-dots">
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
          </div>
        </div>
      </div>
    </div>
  
    <div class="symptom-disclaimer">
      <small><i class="fas fa-exclamation-circle"></i> Not a substitute for professional medical advice. For emergencies, call emergency services immediately.</small>
    </div>
  </section>

        <!-- ALERTS & FOLLOW-UP -->
        <section id="alerts" class="section active" aria-labelledby="alerts-tab">
          <h2 class="title">Alerts & Follow-up</h2>
          
          <!-- Alert Summary Cards -->
          <div class="row" style="margin-bottom:20px">
            <div class="col">
              <div class="card" style="background:linear-gradient(135deg, #f0f9ff, #e6f7ff);border-left:4px solid #1890ff">
                <div style="display:flex;align-items:center;gap:12px">
                  <div style="font-size:2rem">üíä</div>
                  <div>
                    <div style="font-weight:800;color:#1890ff" id="refillCount">2</div>
                    <div class="small">Medicine Refills</div>
                  </div>
                </div>
              </div>
            </div>
            <div class="col">
              <div class="card" style="background:linear-gradient(135deg, #f6ffed, #fcffe6);border-left:4px solid #52c41a">
                <div style="display:flex;align-items:center;gap:12px">
                  <div style="font-size:2rem">üîÑ</div>
                  <div>
                    <div style="font-weight:800;color:#52c41a" id="followupCount">1</div>
                    <div class="small">Follow-ups</div>
                  </div>
                </div>
              </div>
            </div>
            <div class="col">
              <div class="card" style="background:linear-gradient(135deg, #fff2e8, #fff7e6);border-left:4px solid #fa8c16">
                <div style="display:flex;align-items:center;gap:12px">
                  <div style="font-size:2rem">üìÖ</div>
                  <div>
                    <div style="font-weight:800;color:#fa8c16" id="appointmentCount">1</div>
                    <div class="small">Upcoming</div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Tabs for different alert types -->
          <div class="card">
            <div style="display:flex;gap:8px;border-bottom:1px solid #eef6f2;margin-bottom:16px">
              <button class="pill active" data-alert-type="all" onclick="switchAlertTab(this)">All Alerts</button>
              <button class="pill" data-alert-type="refill" onclick="switchAlertTab(this)">Medicine Refills</button>
              <button class="pill" data-alert-type="followup" onclick="switchAlertTab(this)">Follow-ups</button>
              <button class="pill" data-alert-type="consultation" onclick="switchAlertTab(this)">Consultations</button>
            </div>
            
            <div id="alertsList">
              <!-- Alerts will be populated by JavaScript -->
            </div>
            
            <div id="noAlerts" style="display:none;text-align:center;padding:40px 20px">
              <div style="font-size:3rem;margin-bottom:16px">üéâ</div>
              <div style="font-weight:700;margin-bottom:8px">No pending alerts</div>
              <div class="small muted">You're all caught up!</div>
            </div>
          </div>
          
          <!-- Consultation Management Section (shown when there's an active consultation) -->
          <div id="consultationSection" class="card">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
              <h3 style="margin:0">Active Consultation</h3>
              <div class="small muted" id="consultationStatus">Waiting for doctor to join</div>
            </div>
            
            <div style="display:flex;gap:16px;align-items:center;margin-bottom:20px;padding:16px;background:#f7fff9;border-radius:12px">
              <div style="width:60px;height:60px;border-radius:10px;background:#eaf7f0;display:grid;place-items:center;font-weight:800;color:var(--brand);font-size:1.2rem" id="consultDoctorAvatar">AS</div>
              <div style="flex:1">
                <div style="font-weight:800" id="consultDoctorName">Dr. Amanpreet Singh</div>
                <div class="small muted" id="consultDoctorSpec">General Physician ‚Ä¢ DOC-14237</div>
                <div class="small" id="consultTime">Scheduled: Today, 3:00 PM</div>
              </div>
              <div style="display:flex;gap:8px">
                <button class="btn" id="joinConsultBtn" onclick="joinConsultation('alert-6')">Join Consultation</button>
                <button class="btn ghost" onclick="rescheduleConsultation()">Reschedule</button>
              </div>
            </div>
            
            <!-- Consultation Actions (shown after payment) -->
<div id="consultActions" style="display: none;">
  <div style="font-weight:700;margin-bottom:12px">Consultation Options</div>
  <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(120px, 1fr));gap:12px">
    <button class="btn ghost" onclick="startChat()">
      <div style="font-size:1.5rem">üí¨</div>
      <div>Chat</div>
    </button>
    <button class="btn ghost" onclick="requestCall()">
      <div style="font-size:1.5rem">üìû</div>
      <div>Voice Call</div>
    </button>
    <button class="btn ghost" onclick="requestVideoCall()">
      <div style="font-size:1.5rem">üé•</div>
      <div>Video Call</div>
    </button>
    <button class="btn ghost" onclick="viewPrescription()">
      <div style="font-size:1.5rem">üìù</div>
      <div>Prescription</div>
    </button>
  </div>
</div>

          <!-- Payment Modal -->
          <div id="paymentModal" class="family-member-panel hidden">
            <div class="family-member-content" style="max-width:500px">
              <div class="family-member-header">
                <h3>Consultation Payment</h3>
                <button class="family-member-close" onclick="closePaymentModal()">&times;</button>
              </div>
              <div id="paymentContent" style="padding: 20px;">
                <div style="text-align:center;margin-bottom:20px">
                  <div style="font-size:2.5rem">üí≥</div>
                  <div style="font-weight:700;font-size:1.5rem;margin:10px 0">‚Çπ <span id="consultationFee">500</span></div>
                  <div class="small muted">Consultation fee for <span id="paymentDoctorName">Dr. Amanpreet Singh</span></div>
                </div>
                
                <div style="margin-bottom:20px">
                  <div style="font-weight:700;margin-bottom:8px">Select Payment Method</div>
                  <div class="payment-methods">
                    <div class="payment-method selected" data-method="card" onclick="selectPaymentMethod(this)">
                      <div class="payment-method-icon">üí≥</div>
                      <div>Card</div>
                    </div>
                    <div class="payment-method" data-method="upi" onclick="selectPaymentMethod(this)">
                      <div class="payment-method-icon">üì±</div>
                      <div>UPI</div>
                    </div>
                    <div class="payment-method" data-method="netbanking" onclick="selectPaymentMethod(this)">
                      <div class="payment-method-icon">üè¶</div>
                      <div>Net Banking</div>
                    </div>
                    <div class="payment-method" data-method="wallet" onclick="selectPaymentMethod(this)">
                      <div class="payment-method-icon">üì≤</div>
                      <div>Wallet</div>
                    </div>
                  </div>
                </div>
                
                <div id="cardPaymentForm">
                  <div style="margin-bottom:12px">
                    <div class="small" style="font-weight:600;margin-bottom:4px">Card Number</div>
                    <input type="text" class="input" placeholder="1234 5678 9012 3456" style="width:100%">
                  </div>
                  <div style="display:grid;grid-template-columns:2fr 1fr;gap:12px;margin-bottom:12px">
                    <div>
                      <div class="small" style="font-weight:600;margin-bottom:4px">Expiry Date</div>
                      <input type="text" class="input" placeholder="MM/YY">
                    </div>
                    <div>
                      <div class="small" style="font-weight:600;margin-bottom:4px">CVV</div>
                      <input type="text" class="input" placeholder="123">
                    </div>
                  </div>
                  <div style="margin-bottom:20px">
                    <div class="small" style="font-weight:600;margin-bottom:4px">Cardholder Name</div>
                    <input type="text" class="input" placeholder="Gurpreet Kaur" style="width:100%">
                  </div>
                </div>
                
                <div id="upiPaymentForm" class="hidden">
                  <div style="margin-bottom:12px">
                    <div class="small" style="font-weight:600;margin-bottom:4px">UPI ID</div>
                    <input type="text" class="input" placeholder="gurpreet@upi" style="width:100%">
                  </div>
                </div>
                
                <div id="netbankingPaymentForm" class="hidden">
                  <div style="margin-bottom:12px">
                    <div class="small" style="font-weight:600;margin-bottom:4px">Select Bank</div>
                    <select class="input" style="width:100%">
                      <option value="">Select your bank</option>
                      <option value="sbi">State Bank of India</option>
                      <option value="hdfc">HDFC Bank</option>
                      <option value="icici">ICICI Bank</option>
                      <option value="axis">Axis Bank</option>
                    </select>
                  </div>
                </div>
                
                <div id="walletPaymentForm" class="hidden">
                  <div style="margin-bottom:12px">
                    <div class="small" style="font-weight:600;margin-bottom:4px">Select Wallet</div>
                    <select class="input" style="width:100%">
                      <option value="">Select your wallet</option>
                      <option value="paytm">Paytm</option>
                      <option value="phonepe">PhonePe</option>
                      <option value="gpay">Google Pay</option>
                      <option value="amazonpay">Amazon Pay</option>
                    </select>
                  </div>
                </div>
                
                <button class="btn" style="width:100%" onclick="processPayment()">Pay Now</button>
                
                <div class="small muted" style="text-align:center;margin-top:12px">
                  Your payment is secure and encrypted
                </div>
              </div>
            </div>
          </div>
          
          <!-- Payment Success Modal -->
          <div id="paymentSuccessModal" class="family-member-panel hidden">
            <div class="family-member-content" style="max-width:450px; text-align: center;">
              <div class="family-member-header">
                <h3>Payment Successful</h3>
                <button class="family-member-close" onclick="closePaymentSuccessModal()">&times;</button>
              </div>
              <div style="padding: 30px 20px;">
                <div style="font-size: 4rem; margin-bottom: 20px;">‚úÖ</div>
                <h3 style="margin-bottom: 10px; color: var(--ok);">Payment Completed Successfully</h3>
                <p class="muted" style="margin-bottom: 20px;">Your consultation with Dr. Amanpreet Singh has been confirmed.</p>
                <div style="background: #f7f7f7; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: left;">
                  <p><strong>Consultation ID:</strong> CON-789456</p>
                  <p><strong>Amount Paid:</strong> ‚Çπ500</p>
                  <p><strong>Payment Method:</strong> Credit Card</p>
                  <p><strong>Date:</strong> <span id="paymentDate"></span></p>
                </div>
                <button class="btn" style="width: 100%;" onclick="closePaymentSuccessModal()">Continue to Consultation</button>
              </div>
            </div>
          </div>
          
          <!-- In-Consultation Interface -->
          <div id="consultationInterface" class="family-member-panel hidden">
            <div style="padding:20px;height:100%; width: 100%; max-width: 1200px; background: white; border-radius: 12px;">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
                <h3 style="margin:0">Consultation with <span id="activeDoctorName">Dr. Amanpreet Singh</span></h3>
                <div style="display:flex;gap:8px;align-items:center">
                  <div class="status" id="callStatus">Connected</div>
                  <div id="callTimer">00:00</div>
                  <button class="btn ghost" onclick="toggleAudio()" id="audioBtn">üîá</button>
                  <button class="btn ghost" onclick="toggleVideo()" id="videoBtn">üìπ</button>
                  <button class="btn" style="background:var(--danger)" onclick="endConsultation()">End</button>
                </div>
              </div>
              
              <div style="display:grid;grid-template-columns:3fr 1fr;gap:16px;height:calc(100% - 80px)">
                <div style="background:#1a1a1a;border-radius:12px;position:relative;display:flex;justify-content:center;align-items:center">
                  <div id="videoContainer">
                    <div style="text-align:center;color:white">
                      <div style="font-size:4rem">üë®‚Äç‚öïÔ∏è</div>
                      <div>Dr. Amanpreet Singh</div>
                      <div class="small muted">Video will start shortly</div>
                    </div>
                  </div>
                  <div style="position:absolute;bottom:16px;left:16px;background:rgba(0,0,0,0.5);color:white;padding:8px 12px;border-radius:8px">
                    <div>Gurpreet Kaur</div>
                  </div>
                </div>
                
                <div style="display:flex;flex-direction:column;gap:16px">
                  <div style="background:#f7f7f7;border-radius:12px;padding:12px;flex:1">
                    <div style="font-weight:700;margin-bottom:12px">Chat</div>
                    <div id="chatMessages" style="height:200px;overflow-y:auto;margin-bottom:12px">
                      <!-- Chat messages will appear here -->
                      <div style="margin-bottom: 10px;">
                        <div class="small muted">Dr. Amanpreet Singh joined the consultation</div>
                      </div>
                    </div>
                    <div style="display:flex;gap:8px">
                      <input type="text" id="chatInput" class="input" placeholder="Type a message..." style="flex:1" onkeypress="handleChatKeyPress(event)">
                      <button class="btn" onclick="sendMessage()">Send</button>
                    </div>
                  </div>
                  
                  <div style="background:#f7f7f7;border-radius:12px;padding:12px">
                    <div style="font-weight:700;margin-bottom:12px">Consultation Tools</div>
                    <div class="consultation-tools">
                      <button class="consultation-tool-btn" onclick="shareFile()">
                        <div style="font-size:1.5rem">üìÅ</div>
                        <div>Share File</div>
                      </button>
                      <button class="consultation-tool-btn" onclick="requestPrescription()">
                        <div style="font-size:1.5rem">üìù</div>
                        <div>Prescription</div>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- DIGITAL RECORDS -->
        <section id="records" class="section" aria-labelledby="records-tab">
          <h2 class="title">Your Digital Records</h2>
          
          <!-- Filter and search controls -->
          <div class="card">
            <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">
              <div style="flex:1;min-width:200px">
                <input id="recordsSearch" class="input" placeholder="Search records..." oninput="filterRecords()"/>
              </div>
              <select id="recordTypeFilter" class="input" style="min-width:150px" onchange="filterRecords()">
                <option value="all">All Records</option>
                <option value="prescription">Prescriptions</option>
                <option value="lab">Lab Reports</option>
                <option value="imaging">Imaging Reports</option>
                <option value="doctor_notes">Doctor Notes</option>
              </select>
              <select id="dateFilter" class="input" style="min-width:120px" onchange="filterRecords()">
                <option value="newest">Newest First</option>
                <option value="oldest">Oldest First</option>
              </select>
              <button class="btn ghost" onclick="downloadAllRecords()" title="Download all records as ZIP">
                üì¶ Download All
              </button>
            </div>
          </div>

          <!-- Records list -->
          <div class="card">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
              <div style="font-weight:800">Medical Records</div>
              <div class="small muted" id="recordsCount">3 records found</div>
            </div>
            
            <div id="recordsList">
              <!-- Records will be populated by JavaScript -->
            </div>
            
            <div id="noRecords" style="display:none;text-align:center;padding:40px 20px">
              <div style="font-size:3rem;margin-bottom:16px">üìÅ</div>
              <div style="font-weight:700;margin-bottom:8px">No records found</div>
              <div class="small muted">No medical records match your search criteria</div>
            </div>
          </div>
          
          <!-- Record detail modal (will be shown when a record is clicked) -->
          <div id="recordDetailModal" class="family-member-panel">
            <div class="family-member-content record-detail-modal">
              <div class="family-member-header">
                <h3 id="recordModalTitle">Record Details</h3>
                <button class="family-member-close" onclick="closeRecordModal()">&times;</button>
              </div>
              <div id="recordDetailContent" class="record-detail-content">
                <!-- Content will be populated by JavaScript -->
              </div>
            </div>
          </div>
        </section>

        <!-- PHARMACIES -->
        <section id="pharmacies" class="section" aria-labelledby="pharmacies-tab">
          <h2 class="title">Nearby Pharmacies & Medicine Availability</h2>
          <div class="card">
            <div style="display:flex;gap:12px;align-items:center;margin-bottom:12px">
              <input id="medSearch" class="input" placeholder="Search medicine name..." oninput="renderPharmacies()" />
              <button class="pill" onclick="renderPharmacies()">Search</button>
            </div>
            <div style="height:500px;border-radius:12px;" id="pharmMap">Map & availability placeholder</div>
          </div>
        </section>

        <!-- CONTACT DOCTOR -->
        <section id="contact" class="section" aria-labelledby="contact-tab">
          <h2 class="title">üö® Emergency SOS</h2>
          <div class="card" style="border:2px solid #f66;box-shadow:0 0 10px rgba(255,0,0,0.2)">
            <div style="font-weight:800;margin-bottom:8px;color:#d00">In case of emergency, act quickly</div>
            <div class="small muted">
              Use SOS options below. Your location & profile will be shared with the emergency team automatically.
            </div>
        
            <!-- Emergency Actions -->
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px">
              <button class="btn" style="background:#d00;color:#fff" onclick="requestAmbulance()">üöë Call Ambulance</button>
              <button class="btn ghost" onclick="alertDoctor()">üë®‚Äç‚öïÔ∏è Alert Doctor</button>
              <button class="btn ghost" onclick="notifyFamily()">üë®‚Äçüë©‚Äçüëß Notify Family</button>
              <button class="btn ghost" onclick="shareLocation()">üìç Share Live Location</button>
            </div>
        
            <!-- Additional Help -->
            <div style="margin-top:16px">
              <div style="font-weight:700;margin-bottom:6px">Other SOS Options</div>
              <ul class="small" style="margin:0 0 0 16px">
                <li><a href="#" onclick="openFirstAid()">First Aid Guide</a></li>
                <li><a href="#" onclick="emergencyHotline()">Call 108 / Emergency Helpline</a></li>
                <li><a href="#" onclick="uploadEmergencyDocs()">Upload recent medical reports</a></li>
                <li><a href="#" onclick="setEmergencyContacts()">Manage Emergency Contacts</a></li>
              </ul>
            </div>
          </div>
        </section>
      </div>
    </main>

    <!-- Drawer for doctor details -->
    <aside id="docDrawer" class="drawer" aria-hidden="true">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
        <div style="font-weight:800">Doctor Details</div>
        <button class="close" onclick="closeDrawer()">Close</button>
      </div>
      <div id="drawerContent">
        <!-- populated by JS -->
      </div>
    </aside>
    
    <!-- Family member details panel -->
    <div id="familyMemberPanel" class="family-member-panel">
      <div class="family-member-content">
        <div class="family-member-header">
          <h3>Family Member Details</h3>
          <button class="family-member-close" onclick="closeFamilyMemberPanel()">&times;</button>
        </div>
        <div id="familyMemberDetails">
          <!-- Content will be populated by JavaScript -->
        </div>
      </div>
    </div>
    
    <!-- Connect to doctor modal -->
    <div id="connectModal" class="connect-modal">
      <div class="connect-content">
        <div class="connect-header">
          <h3>Connect with Doctor</h3>
          <button class="connect-close" onclick="closeConnectModal()">&times;</button>
        </div>
        <div id="connectDoctorInfo">
          <!-- Will be populated by JavaScript -->
        </div>
        <div>
          <div style="font-weight:700;margin-bottom:8px">Describe your problem:</div>
          <div class="language-selector">
            <button class="lang-btn active" data-lang="en" onclick="setLanguage(this)">English</button>
            <button class="lang-btn" data-lang="hi" onclick="setLanguage(this)">‡§π‡§ø‡§Ç‡§¶‡•Ä</button>
            <button class="lang-btn" data-lang="pa" onclick="setLanguage(this)">‡®™‡©∞‡®ú‡®æ‡®¨‡©Ä</button>
          </div>
          <textarea id="problemDescription" class="problem-input" placeholder="Please describe your medical problem in detail..."></textarea>
          <button class="btn" style="width:100%" onclick="submitProblem()">Send Request</button>
        </div>
      </div>
    </div>
    
    <!-- Notification container -->
    <div id="notificationContainer"></div>
  </div>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    
    // Get current profile photo source
    const profilePhoto = document.querySelector('.profile-photo-container img');
    const photoSrc = profilePhoto ? profilePhoto.src : '';
    
    /* ---------- Demo data ---------- */
    const topDoctors = [
      {id:'DOC-100', name:'Dr. Arjun Singh', spec:'Cardiologist', rating:4.9, city:'Patiala'},
      {id:'DOC-101', name:'Dr. Meera Kapoor', spec:'Dermatologist', rating:4.8, city:'Chandigarh'},
      {id:'DOC-102', name:'Dr. Rohan Gupta', spec:'General Physician', rating:4.7, city:'Nabha'},
      {id:'DOC-103', name:'Dr. Simran Kaur', spec:'Gynecologist', rating:4.6, city:'Ludhiana'}
    ];
    
    const availableDoctors = [
      {id:'DOC-102', name:'Dr. Rohan Gupta', spec:'General Physician', online:true, phone:'+91-90000-00001', clinic:'Nabha Health Clinic'},
      {id:'DOC-110', name:'Dr. Karan Malhotra', spec:'Endocrinologist', online:true, phone:'+91-90000-00002', clinic:'Sunrise Medical'},
      {id:'DOC-101', name:'Dr. Meera Kapoor', spec:'Dermatologist', online:false, phone:'+91-90000-00003', clinic:'SkinCare Center'},
    ];
    
    const visitedDoctors = [
      {id:'DOC-14237', name:'Dr. Amanpreet Singh', spec:'General Physician', last:'2025-08-15'},
      {id:'DOC-090', name:'Dr. Jaspreet Kaur', spec:'ENT', last:'2025-06-20'}
    ];
    
    const pharmacies = [
      {name:'Nabha Pharmacy', lat:0, lng:0, meds:['Paracetamol','Ibuprofen']},
      {name:'HolyMed Pharmacy', lat:0, lng:0, meds:['Omeprazole','Cetirizine']},
    ];
    
    // Family members data
    const familyMembers = {
      harjit: {
        name: 'Harjit Singh',
        relation: 'Husband',
        id: 'PAT-0002',
        age: 35,
        avatar: 'HS',
        medicalSummary: 'No chronic conditions recorded ‚Ä¢ Allergies: None',
        recentPrescriptions: [
          'Atorvastatin 20mg ‚Äî 2025-07-15',
          'Metformin 500mg ‚Äî 2025-06-20'
        ]
      },
      simran: {
        name: 'Simran Kaur',
        relation: 'Daughter',
        id: 'PAT-0003',
        age: 8,
        avatar: 'SK',
        medicalSummary: 'Asthma (mild) ‚Ä¢ Allergies: Pollen',
        recentPrescriptions: [
          'Salbutamol inhaler ‚Äî 2025-08-05',
          'Montelukast 5mg ‚Äî 2025-07-28'
        ]
      }
    };
    
    // Clinics data for the map
    const clinics = [
      {name:'Nabha Health Clinic', lat:30.3750, lng:76.1500},
      {name:'Sunrise Medical', lat:30.3850, lng:76.1200},
      {name:'SkinCare Center', lat:30.3700, lng:76.1300},
    ];
    
    /* ---------- Demo data for Alerts & Follow-up ---------- */
    const alertsData = {
      refill: [
        {
          id: 'alert-1',
          type: 'refill',
          medicine: 'Paracetamol 500mg',
          remaining: '5 tablets left (3 days supply)',
          date: '2025-09-10',
          status: 'pending',
          urgency: 'high',
          dosage: '1 tablet 3 times daily after meals',
          doctor: {
            id: 'DOC-14237',
            name: 'Dr. Amanpreet Singh',
            contact: '+91-98765-43210'
          },
          pharmacy: {
            name: 'Nabha Medicals',
            address: 'Main Bazaar, Nabha',
            phone: '+91-1652-234567'
          }
        },
        {
          id: 'alert-2',
          type: 'refill',
          medicine: 'Salbutamol Inhaler',
          remaining: 'Less than 10 doses left (5 days supply)',
          date: '2025-09-15',
          status: 'pending',
          urgency: 'medium',
          dosage: '2 puffs every 6 hours as needed',
          doctor: {
            id: 'DOC-090',
            name: 'Dr. Jaspreet Kaur',
            contact: '+91-98765-12345'
          },
          pharmacy: {
            name: 'City Med Pharmacy',
            address: 'Gandhi Road, Nabha',
            phone: '+91-1652-345678'
          }
        },
        {
          id: 'alert-3',
          type: 'refill',
          medicine: 'Atorvastatin 20mg',
          remaining: '10 tablets left (10 days supply)',
          date: '2025-09-18',
          status: 'pending',
          urgency: 'low',
          dosage: '1 tablet at bedtime',
          doctor: {
            id: 'DOC-14237',
            name: 'Dr. Amanpreet Singh',
            contact: '+91-98765-43210'
          },
          pharmacy: {
            name: 'Nabha Medicals',
            address: 'Main Bazaar, Nabha',
            phone: '+91-1652-234567'
          }
        }
      ],
      followup: [
        {
          id: 'alert-4',
          type: 'followup',
          purpose: 'Blood test review - Vitamin D levels',
          date: '2025-09-12',
          time: '11:00 AM',
          status: 'pending',
          doctor: {
            id: 'DOC-14237',
            name: 'Dr. Amanpreet Singh',
            specialization: 'General Physician',
            contact: '+91-98765-43210'
          },
          notes: 'Discuss vitamin D supplementation options based on recent blood report'
        },
        {
          id: 'alert-5',
          type: 'followup',
          purpose: 'Asthma control assessment',
          date: '2025-09-20',
          time: '02:30 PM',
          status: 'pending',
          doctor: {
            id: 'DOC-090',
            name: 'Dr. Jaspreet Kaur',
            specialization: 'ENT Specialist',
            contact: '+91-98765-12345'
          },
          notes: 'Review inhaler technique and asthma control over past month'
        }
      ],
      consultation: [
        {
          id: 'alert-6',
          type: 'consultation',
          purpose: 'Fever and cough follow-up',
          date: '2025-09-05',
          time: '03:00 PM',
          status: 'scheduled',
          duration: 15,
          doctor: {
            id: 'DOC-14237',
            name: 'Dr. Amanpreet Singh',
            specialization: 'General Physician',
            fee: 500,
            contact: '+91-98765-43210',
            rating: 4.7
          },
          paymentStatus: 'pending',
          symptoms: ['Fever', 'Cough', 'Headache'],
          scheduledOn: '2025-09-01'
        },
        {
          id: 'alert-7',
          type: 'consultation',
          purpose: 'Skin allergy consultation',
          date: '2025-09-08',
          time: '10:30 AM',
          status: 'active',
          duration: 20,
          doctor: {
            id: 'DOC-14237',
            name: 'Dr. Amanpreet Singh',
            specialization: '',
            fee: 700,
            contact: '+91-98765-67890',
            rating: 4.8
          },
          paymentStatus: 'completed',
          symptoms: ['Skin rash', 'Itching', 'Redness'],
          scheduledOn: '2025-09-03',
          consultationId: 'CONS-7821'
        }
      ]
    };
    
    // Sample chat messages for active consultation
    const chatMessages = {
      'CONS-7821': [
        {
          id: 1,
          sender: 'doctor',
          name: 'Dr. Meera Kapoor',
          message: 'Hello Gurpreet, how can I help you today?',
          time: '10:32 AM'
        },
        {
          id: 2,
          sender: 'patient',
          name: 'Gurpreet Kaur',
          message: 'Hello Doctor, I have developed a skin rash on my arms and neck since yesterday.',
          time: '10:33 AM'
        },
        {
          id: 3,
          sender: 'doctor',
          name: 'Dr. Meera Kapoor',
          message: 'Could you describe the rash? Is it itchy? Any redness or swelling?',
          time: '10:34 AM'
        },
        {
          id: 4,
          sender: 'patient',
          name: 'Gurpreet Kaur',
          message: 'Yes, it\'s very itchy with red patches. No swelling though.',
          time: '10:35 AM'
        }
      ]
    };
    
    // Sample payment methods
    const paymentMethods = [
      {
        id: 'card',
        name: 'Credit/Debit Card',
        icon: 'üí≥',
        description: 'Pay securely with your card'
      },
      {
        id: 'upi',
        name: 'UPI',
        icon: 'üì±',
        description: 'Pay using any UPI app'
      },
      {
        id: 'netbanking',
        name: 'Net Banking',
        icon: 'üè¶',
        description: 'Transfer directly from your bank'
      },
      {
        id: 'wallet',
        name: 'Wallet',
        icon: 'üì≤',
        description: 'Pay using PhonePe, PayTM or other wallets'
      }
    ];
    
    // Medical records data
    const medicalRecords = [
      {
        id: 'REC-001',
        type: 'prescription',
        date: '2025-08-10',
        title: 'Prescription - Dr. Amanpreet Singh',
        doctor: {
          id: 'DOC-14237',
          name: 'Dr. Amanpreet Singh',
          specialization: 'General Physician'
        },
        medications: [
          { name: 'Paracetamol', dosage: '500mg', frequency: '3 times daily', duration: '5 days' },
          { name: 'Ibuprofen', dosage: '400mg', frequency: 'As needed for pain', duration: '' }
        ],
        instructions: 'Take after meals. Complete full course of antibiotics.',
        fileUrl: 'reports/prescription_20250810.pdf',
        fileSize: '1.2MB'
      },
      {
        id: 'REC-002',
        type: 'lab',
        date: '2025-07-15',
        title: 'Blood Test Report',
        doctor: {
          id: 'DOC-14237',
          name: 'Dr. Amanpreet Singh',
          specialization: 'General Physician'
        },
        lab: 'Nabha Diagnostic Center',
        tests: [
          { name: 'Hemoglobin', result: '13.5 g/dL', normalRange: '12.0-15.5 g/dL', status: 'normal' },
          { name: 'Blood Sugar (Fasting)', result: '92 mg/dL', normalRange: '70-100 mg/dL', status: 'normal' },
          { name: 'Total Cholesterol', result: '182 mg/dL', normalRange: '<200 mg/dL', status: 'normal' },
          { name: 'Vitamin D', result: '18 ng/mL', normalRange: '30-100 ng/mL', status: 'abnormal' }
        ],
        summary: 'Most parameters within normal limits. Vitamin D deficiency noted. Supplementation recommended.',
        fileUrl: 'reports/blood_test_20250715.pdf',
        fileSize: '2.4MB'
      },
      {
        id: 'REC-003',
        type: 'prescription',
        date: '2025-06-18',
        title: 'Prescription - Dr. Jaspreet Kaur',
        doctor: {
          id: 'DOC-090',
          name: 'Dr. Jaspreet Kaur',
          specialization: 'ENT Specialist'
        },
        medications: [
          { name: 'Salbutamol Inhaler', dosage: '100mcg/dose', frequency: '2 puffs as needed', duration: '' },
          { name: 'Cetirizine', dosage: '10mg', frequency: 'Once daily', duration: '10 days' }
        ],
        instructions: 'Use inhaler before physical activity. Avoid known allergens.',
        fileUrl: 'reports/prescription_20250618.pdf',
        fileSize: '0.9MB'
      },
      {
        id: 'REC-004',
        type: 'imaging',
        date: '2025-05-22',
        title: 'Chest X-Ray',
        doctor: {
          id: 'DOC-14237',
          name: 'Dr. Amanpreet Singh',
          specialization: 'General Physician'
        },
        lab: 'Nabha Imaging Center',
        findings: 'Clear lung fields. No evidence of pneumonia, pleural effusion, or pneumothorax. Cardiac silhouette is normal.',
        impression: 'Normal chest X-ray.',
        fileUrl: 'reports/chest_xray_20250522.jpg',
        fileSize: '3.7MB'
      },
      {
        id: 'REC-005',
        type: 'doctor_notes',
        date: '2025-04-10',
        title: 'Consultation Notes - Dr. Amanpreet Singh',
        doctor: {
          id: 'DOC-14237',
          name: 'Dr. Amanpreet Singh',
          specialization: 'General Physician'
        },
        notes: 'Patient presents with persistent headaches for 2 weeks. No fever, nausea, or visual disturbances. Blood pressure within normal limits. Advised to maintain headache diary and return if symptoms worsen. Differential diagnosis includes tension headache and migraine.',
        recommendations: 'Reduce stress, maintain regular sleep schedule, over-the-counter pain relief as needed.',
        fileUrl: 'reports/consultation_notes_20250410.pdf',
        fileSize: '0.5MB'
      }
    ];
    
    // Track active consultation
    let activeConsultation = null;
    let callTimerInterval = null;
    let callSeconds = 0;
    let isAudioMuted = false;
    let isVideoOff = false;
    // Track the consultation the user is trying to join
    let targetConsultationId = null;
    
    // Twilio Video variables
    let twilioRoom = null;
    let twilioLocalTracks = null;
    let twilioToken = null;
    
    // Polling intervals
    let chatPollingInterval = null;
    let statusPollingInterval = null;
    
    /* ---------- Authentication Helper ---------- */
    function getAuthToken() {
      return localStorage.getItem('authToken') || '';
    }
    
    /* ---------- API Helper Functions ---------- */
    async function apiRequest(endpoint, options = {}) {
      const defaultOptions = {
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${getAuthToken()}`
        }
      };
    
      const config = { ...defaultOptions, ...options };
    
      try {
        const response = await fetch(endpoint, config);
        
        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.message || `API Error: ${response.status}`);
        }
        
        return await response.json();
      } catch (error) {
        console.error('API Request Failed:', error);
        showNotification('error', 'API Error', error.message);
        throw error;
      }
    }
    
    /* ---------- Tab switching ---------- */
    const tabNodes = document.querySelectorAll('.navitem');
    const sections = document.querySelectorAll('.section');
    tabNodes.forEach(node=>{
      node.addEventListener('click', () => {
        tabNodes.forEach(n=>n.classList.remove('active'));
        node.classList.add('active');
        const tab = node.dataset.tab;
        sections.forEach(s=>{ s.classList.remove('active'); s.setAttribute('aria-hidden','true') });
        const target = document.getElementById(tab);
        if(target){ target.classList.add('active'); target.removeAttribute('aria-hidden') }
        // small UX: if switching to doctors, re-render lists
        if(tab === 'doctors') { renderTopDoctors(); renderAvailable(); renderVisited(); }
        if(tab === 'pharmacies') { renderPharmacies(); }
        if(tab === 'alerts') { initAlerts(); }
        if(tab === 'records') { initRecords(); }
      });
    });
    
    /* ---------- Family member panel ---------- */
    function openFamilyMemberPanel(memberId) {
      const member = familyMembers[memberId];
      if (!member) return;
      
      const panel = document.getElementById('familyMemberPanel');
      const content = document.getElementById('familyMemberDetails');
      
      content.innerHTML = `
        <div class="family-member-info">
          <div class="family-member-avatar">${member.avatar}</div>
          <div class="family-member-details">
            <div class="family-member-name">${member.name}</div>
            <div class="family-member-relation">${member.relation} ‚Ä¢ Age ${member.age}</div>
            <div class="family-member-id">${member.id} ‚Ä¢ Nabha, Punjab</div>
          </div>
        </div>
        
        <div class="family-member-section">
          <div class="family-member-section-title">Medical Summary</div>
          <div class="small">${member.medicalSummary}</div>
        </div>
        
        <div class="family-member-section">
          <div class="family-member-section-title">Recent Prescriptions</div>
          <ul class="small" style="margin:0 0 0 16px">
            ${member.recentPrescriptions.map(p => `<li>${p}</li>`).join('')}
          </ul>
        </div>
        
        <button class="family-member-login-btn" onclick="loginAsFamilyMember('${memberId}')">
          Login to ${member.name}'s Profile
        </button>
      `;
      
      panel.classList.add('open');
      document.body.style.overflow = 'hidden'; // Prevent scrolling when panel is open
    }
    
    // Function to show appointment details in a modal
    function showAppointmentDetails() {
      // Find the active consultation (the one that is 'scheduled')
      const consultation = alertsData.consultation.find(c => c.status === 'scheduled');
      
      if (!consultation) {
        showNotification('warning', 'No Appointment', 'No upcoming appointment found.');
        return;
      }
    
      // Create the modal content
      const modal = document.createElement('div');
      modal.className = 'family-member-panel open';
      modal.id = 'appointment-details-modal';
      modal.innerHTML = `
        <div class="family-member-content" style="max-width: 500px;">
          <div class="family-member-header">
            <h3>Appointment Details</h3>
            <button class="family-member-close" onclick="closeAppointmentDetails()">&times;</button>
          </div>
          <div style="padding: 20px;">
            <div style="margin-bottom: 16px; padding: 16px; background: #f7fff9; border-radius: 8px;">
              <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                <div style="width: 56px; height: 56px; border-radius: 8px; background: #eaf7f0; display: grid; place-items: center; font-weight: 800; color: var(--brand);">
                  ${consultation.doctor.name.split(' ').map(n => n[0]).join('').substring(0, 2)}
                </div>
                <div>
                  <div style="font-weight: 800; font-size: 1.1rem;">${consultation.doctor.name}</div>
                  <div class="small muted">${consultation.doctor.specialization}</div>
                </div>
              </div>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
                <div>
                  <div class="small" style="font-weight: 700;">Date & Time</div>
                  <div class="small">${formatDate(consultation.date)} at ${consultation.time}</div>
                </div>
                <div>
                  <div class="small" style="font-weight: 700;">Duration</div>
                  <div class="small">${consultation.duration} minutes</div>
                </div>
              </div>
              <div style="margin-bottom: 12px;">
                <div class="small" style="font-weight: 700;">Purpose</div>
                <div class="small">${consultation.purpose}</div>
              </div>
              <div>
                <div class="small" style="font-weight: 700;">Fee</div>
                <div class="small">‚Çπ${consultation.doctor.fee}</div>
              </div>
            </div>
    
            <div style="margin-bottom: 16px;">
              <div class="small" style="font-weight: 700; margin-bottom: 8px;">Symptoms</div>
              <div class="small">${consultation.symptoms.join(', ')}</div>
            </div>
    
            <div style="display: flex; gap: 8px; margin-top: 20px;">
              <!-- Updated: Pass the consultation ID to joinConsultation -->
              <button class="btn" onclick="joinConsultation('${consultation.id}')">Join Consultation</button>          
              <button class="btn ghost" onclick="rescheduleConsultation()">Reschedule</button>
              <button class="btn ghost" onclick="closeAppointmentDetails()">Close</button>
            </div>
          </div>
        </div>
      `;
    
      // Append modal to body and prevent scrolling
      document.body.appendChild(modal);
      document.body.style.overflow = 'hidden';
    
      // Close modal if clicked outside
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          closeAppointmentDetails();
        }
      });
    }
    
    // Function to close the appointment details modal
    function closeAppointmentDetails() {
      const modal = document.getElementById('appointment-details-modal');
      if (modal) {
        modal.remove();
        document.body.style.overflow = '';
      }
    }
    function closeFamilyMemberPanel() {
      const panel = document.getElementById('familyMemberPanel');
      panel.classList.remove('open');
      document.body.style.overflow = ''; // Re-enable scrolling
    }
    
    function loginAsFamilyMember(memberId) {
      const member = familyMembers[memberId];
      showNotification('info', 'Login', `Logging in as ${member.name}...`);
      closeFamilyMemberPanel();
      // In a real app, this would redirect to the family member's profile
    }
    
    // Add click handlers to family member items
    document.querySelectorAll('.family-member-item').forEach(item => {
      item.addEventListener('click', () => {
        const memberId = item.dataset.member;
        openFamilyMemberPanel(memberId);
      });
    });
    
    // Close panel when clicking outside content
    document.getElementById('familyMemberPanel').addEventListener('click', (e) => {
      if (e.target === document.getElementById('familyMemberPanel')) {
        closeFamilyMemberPanel();
      }
    });
    
    /* ---------- Render hero (top doctors) ---------- */
    function renderTopDoctors(){
      const container = document.getElementById('topDoctorsHero');
      container.innerHTML = '';
      topDoctors.forEach(d=>{
        const card = document.createElement('div');
        card.className='hero-card';
        card.innerHTML = `
          <div class="photo">${d.name.split(' ').map(w=>w[0]).slice(0,2).join('')}</div>
          <div style="font-weight:800">${d.name}</div>
          <div class="small muted">${d.spec} ‚Ä¢ ${d.city}</div>
          <div style="margin-top:10px;display:flex;justify-content:space-between;align-items:center">
            <div class="rating">‚òÖ ${d.rating.toFixed(1)}</div>
            <div><button class="btn ghost" onclick="openDoctor('${d.id}')">View</button></div>
          </div>
        `;
        container.appendChild(card);
      });
    }
    
    /* ---------- Available doctors ---------- */
    let activeDoctorFilter = 'all';
    function setDoctorFilter(el){
      document.querySelectorAll('.pill').forEach(p=>p.classList.remove('active'));
      el.classList.add('active');
      activeDoctorFilter = el.dataset.filter;
      renderAvailable();
    }
    
    function renderAvailable(){
      const q = document.getElementById('docSearch').value.trim().toLowerCase();
      const list = document.getElementById('availableList');
      list.innerHTML = '';
      const filtered = availableDoctors.filter(d=>{
        if(activeDoctorFilter === 'online') {
          // Check localStorage for the doctor's current availability
          const doctorAvailability = localStorage.getItem(`doctor_${d.id}_availability`);
          const isAvailable = doctorAvailability ? JSON.parse(doctorAvailability) : true; // default to true if not set
          if (!isAvailable) return false;
        }
        if(q && !(d.name.toLowerCase().includes(q) || d.spec.toLowerCase().includes(q))) return false;
        return true;
      });
      if(filtered.length === 0){
        list.innerHTML = '<div class="small muted">No doctors match your search.</div>';
        return;
      }
      filtered.forEach(d=>{
        const row = document.createElement('div');
        row.className='doctor-row';
        // --- NEW: Get real-time availability from localStorage ---
        const doctorAvailability = localStorage.getItem(`doctor_${d.id}_availability`);
        const isAvailable = doctorAvailability ? JSON.parse(doctorAvailability) : true;
        // --- END NEW ---
        row.innerHTML = `
          <div class="doctor-avatar">${d.name.split(' ').map(w=>w[0]).slice(0,2).join('')}</div>
          <div class="doctor-info">
            <div style="font-weight:800">${d.name}</div>
            <div class="small muted">${d.spec} ‚Ä¢ ${d.clinic}</div>
          </div>
          <div style="display:flex;flex-direction:column;align-items:flex-end;gap:8px">
            <div class="status ${isAvailable ? '' : 'busy'}">${isAvailable ? 'Available' : 'Busy'}</div>
            <div class="actions">
              <button class="btn" onclick="openConnectModal('${d.id}', '${d.name}')">Connect</button>
              <button class="btn ghost" onclick="openDoctor('${d.id}')">Details</button>
            </div>
          </div>
        `;
        list.appendChild(row);
      });
    }
    
    /* ---------- Visited doctors ---------- */
    function renderVisited(){
      const container = document.getElementById('visitedList');
      container.innerHTML = '';
      visitedDoctors.forEach(v=>{
        const el = document.createElement('div');
        el.className='visited-item';
        el.innerHTML = `
          <div style="width:48px;height:48px;border-radius:8px;background:#eaf7f0;display:grid;place-items:center;font-weight:700;color:var(--brand)">${v.name.split(' ').map(w=>w[0]).slice(0,2).join('')}</div>
          <div style="flex:1">
            <div style="font-weight:800">${v.name}</div>
            <div class="small muted">${v.spec} ‚Ä¢ last: ${v.last}</div>
          </div>
          <div style="display:flex;flex-direction:column;gap:8px">
            <button class="btn ghost" onclick="openDoctor('${v.id}')">View</button>
            <button class="btn" onclick="openConnectModal('${v.id}', '${v.name}')">Connect</button>
          </div>
        `;
        container.appendChild(el);
      });
    }
    
    /* - Doctor/Patient drawer - */
    const drawer = document.getElementById('docDrawer');
    function openDoctor(id) {
      // Check if this is a patient (based on alertsData)
      const patient = alertsData.consultation.find(c => c.id === id) || 
                      alertsData.followup.find(f => f.id === id);
    
      if (patient) {
        // This is a patient ‚Äî set patientId on drawer
        drawer.dataset.patientId = patient.id; // or patient.patientId if you have a separate field
    
        // Populate drawer with patient info
        const content = document.getElementById('drawerContent');
        content.innerHTML = `
          <div style="display:flex;gap:12px;align-items:center;margin-bottom:10px">
            <div style="width:80px;height:80px;border-radius:12px;background:#eaf7f0;display:grid;place-items:center;font-weight:800;color:var(--brand)">
              ${patient.doctor.name.split(' ').map(w => w[0]).slice(0, 2).join('')}
            </div>
            <div>
              <div style="font-weight:900">${patient.doctor.name}</div>
              <div class="small muted">${patient.doctor.specialization}</div>
              <div class="small muted">Patient ID: ${id}</div>
            </div>
          </div>
          <div style="margin-bottom:12px">
            <strong>Appointment</strong>
            <div class="small muted">${formatDate(patient.date)} at ${patient.time}</div>
          </div>
          <div style="margin-bottom:12px">
            <strong>Purpose</strong>
            <div class="small muted">${patient.purpose}</div>
          </div>
          <div style="display:flex;gap:8px">
            <button class="btn" onclick="openConnectModal('${patient.doctor.id}', '${patient.doctor.name}')">Connect</button>
          </div>
        `;
      } else {
        // This is a doctor ‚Äî clear patientId and show doctor info
        delete drawer.dataset.patientId;
    
        // find doctor in any list
        const doc = [...topDoctors, ...availableDoctors, ...visitedDoctors].find(x => x.id === id) || { id, name: 'Unknown', spec: '‚Äî' };
        const content = document.getElementById('drawerContent');
        content.innerHTML = `
          <div style="display:flex;gap:12px;align-items:center;margin-bottom:10px">
            <div style="width:80px;height:80px;border-radius:12px;background:#eaf7f0;display:grid;place-items:center;font-weight:800;color:var(--brand)">
              ${doc.name ? doc.name.split(' ').map(w => w[0]).slice(0, 2).join('') : 'DR'}
            </div>
            <div>
              <div style="font-weight:900">${doc.name}</div>
              <div class="small muted">${doc.spec || 'Specialist'}</div>
              <div class="small muted">ID: ${doc.id}</div>
            </div>
          </div>
          <div style="margin-bottom:12px"><strong>Clinic</strong><div class="small muted">${doc.clinic || 'Main Clinic, Nabha'}</div></div>
          <div style="margin-bottom:12px"><strong>About</strong><div class="small muted">Experienced ${doc.spec || 'physician'} with patient-first approach. Accepts teleconsults and in-person appointments.</div></div>
          <div style="display:flex;gap:8px"><button class="btn" onclick="openConnectModal('${doc.id}', '${doc.name}')">Connect</button></div>
        `;
      }
    
      drawer.classList.add('open');
      drawer.setAttribute('aria-hidden', 'false');
    }
    // Function to refresh the patient drawer with updated data
    function refreshPatientDrawer(updatedPatientId) {
      const drawer = document.getElementById('docDrawer');
      if (!drawer || !drawer.classList.contains('open')) {
        return; // Drawer is not open
      }
    
      // Get the patient ID from the drawer
      const currentPatientId = drawer.dataset.patientId;
      if (!currentPatientId || currentPatientId !== updatedPatientId) {
        return; // Not the same patient
      }
    
      // Find the updated consultation
      const consultation = alertsData.consultation.find(c => c.id === updatedPatientId);
      if (consultation) {
        // Re-open the drawer with updated data
        openDoctor(updatedPatientId); // This will refresh the content
        showNotification('info', 'Drawer Updated', 'Patient appointment time updated.');
      }
    }
    
    function closeDrawer(){ drawer.classList.remove('open'); drawer.setAttribute('aria-hidden','true'); }
    
    /* ---------- Connect to doctor modal ---------- */
    let currentLanguage = 'en';
    let currentDoctorId = '';
    let currentDoctorName = '';
    
    function openConnectModal(doctorId, doctorName) {
      currentDoctorId = doctorId;
      currentDoctorName = doctorName;
      
      const modal = document.getElementById('connectModal');
      const doctorInfo = document.getElementById('connectDoctorInfo');
      
      doctorInfo.innerHTML = `
        <div style="display:flex;gap:12px;align-items:center;margin-bottom:15px">
          <div style="width:60px;height:60px;border-radius:10px;background:#eaf7f0;display:grid;place-items:center;font-weight:800;color:var(--brand)">
            ${doctorName.split(' ').map(w=>w[0]).slice(0,2).join('')}
          </div>
          <div>
            <div style="font-weight:800">${doctorName}</div>
            <div class="small muted">ID: ${doctorId}</div>
          </div>
        </div>
      `;
      
      // Reset language and text
      document.querySelectorAll('.lang-btn').forEach(btn => btn.classList.remove('active'));
      document.querySelector('.lang-btn[data-lang="en"]').classList.add('active');
      currentLanguage = 'en';
      document.getElementById('problemDescription').value = '';
      document.getElementById('problemDescription').placeholder = 'Please describe your medical problem in detail...';
      
      modal.classList.add('open');
      document.body.style.overflow = 'hidden';
    }
    
    function closeConnectModal() {
      const modal = document.getElementById('connectModal');
      modal.classList.remove('open');
      document.body.style.overflow = '';
    }
    
    function setLanguage(button) {
      document.querySelectorAll('.lang-btn').forEach(btn => btn.classList.remove('active'));
      button.classList.add('active');
      currentLanguage = button.dataset.lang;
      
      // Update placeholder based on language
      const textarea = document.getElementById('problemDescription');
      if (currentLanguage === 'hi') {
        textarea.placeholder = '‡§ï‡•É‡§™‡§Ø‡§æ ‡§Ö‡§™‡§®‡•Ä ‡§ö‡§ø‡§ï‡§ø‡§§‡•ç‡§∏‡§æ ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ ‡§ï‡§æ ‡§µ‡§ø‡§∏‡•ç‡§§‡§æ‡§∞ ‡§∏‡•á ‡§µ‡§∞‡•ç‡§£‡§® ‡§ï‡§∞‡•á‡§Ç...';
      } else if (currentLanguage === 'pa') {
        textarea.placeholder = '‡®ï‡®ø‡®∞‡®™‡®æ ‡®ï‡®∞‡®ï‡©á ‡®Ü‡®™‡®£‡©Ä ‡®Æ‡©à‡®°‡©Ä‡®ï‡®≤ ‡®∏‡®Æ‡©±‡®∏‡®ø‡®Ü ‡®¶‡®æ ‡®µ‡®ø‡®∏‡®§‡®æ‡®∞ ‡®®‡®æ‡®≤ ‡®µ‡®∞‡®£‡®® ‡®ï‡®∞‡©ã...';
      } else {
        textarea.placeholder = 'Please describe your medical problem in detail...';
      }
    }
    
    function submitProblem() {
  const problemText = document.getElementById('problemDescription').value.trim();
  if (!problemText) {
    showNotification('warning', 'Validation', 'Please describe your problem before submitting');
    return;
  }
  
  // Get patient profile data from localStorage
  const patientProfile = JSON.parse(localStorage.getItem('patientProfileData') || '{}');
  const patientId = patientProfile.patientId || 'PAT-001';
  
  // Create a connection request with the structure doctor portal expects
  const request = {
    id: patientId, // Use patient ID instead of random request ID
    patientId: patientId,
    patientName: patientProfile.name || 'Gurpreet Kaur',
    age: patientProfile.age || 32,
    gender: patientProfile.gender || 'female',
    status: "pending",
    cc: problemText, // chief complaint
    complaint: problemText,
    prescription: "",
    vitals: {pulse: 0, spo2: 0, temp: ""},
    hx: [],
    meds: [],
    lastVisit: "",
    reports: [],
    blockchain: { verified: false, hash: "" },
    isAppointmentRequest: true,
    doctorId: currentDoctorId,
    doctorName: currentDoctorName,
    problem: problemText,
    language: currentLanguage,
    timestamp: Date.now()
  };
  
  // Store in localStorage for doctor to receive with the correct key format
  localStorage.setItem(`nabhacare_appointment_request_${patientId}`, JSON.stringify(request));
  
  // Also store in patient's localStorage for tracking
  const patientRequests = JSON.parse(localStorage.getItem('patientAppointmentRequests') || '[]');
  patientRequests.push({
    id: patientId,
    doctorId: currentDoctorId,
    doctorName: currentDoctorName,
    problem: problemText,
    status: 'pending',
    timestamp: Date.now()
  });
  localStorage.setItem('patientAppointmentRequests', JSON.stringify(patientRequests));
  
  // Show notification to patient
  showNotification('success', 'Request Sent', `Your request has been sent to ${currentDoctorName}. They will contact you soon.`);
  closeConnectModal();
}
    
    // Close modal when clicking outside content
    document.getElementById('connectModal').addEventListener('click', (e) => {
      if (e.target === document.getElementById('connectModal')) {
        closeConnectModal();
      }
    });
    
    /* ---------- Voice-enabled Symptom Checker ---------- */
    let recognition = null;
    let isRecording = false;
    let recordingLanguage = 'en';
    
    function setRecordingLanguage(button) {
      document.querySelectorAll('.language-selector-symptom .lang-btn').forEach(btn => btn.classList.remove('active'));
      button.classList.add('active');
      recordingLanguage = button.dataset.lang;
    }
    
    function startVoiceRecording() {
      // Show the voice recorder interface
      document.getElementById('voiceRecorder').style.display = 'flex';
      document.getElementById('voiceSymptom').style.display = 'none';
      
      // Check if browser supports speech recognition
      if (!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) {
        showNotification('error', 'Not Supported', 'Voice recognition is not supported in this browser.');
        return;
      }
      
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SpeechRecognition();
      
      // Set language based on selection
      if (recordingLanguage === 'hi') {
        recognition.lang = 'hi-IN'; // Hindi (India)
      } else if (recordingLanguage === 'pa') {
        recognition.lang = 'pa-IN'; // Punjabi (India)
      } else {
        recognition.lang = 'en-IN'; // English (India)
      }
      
      recognition.continuous = false;
      recognition.interimResults = true;
      
      recognition.onstart = function() {
        isRecording = true;
        document.getElementById('recordingStatus').style.display = 'flex';
        document.getElementById('stopRecordingBtn').style.display = 'block';
        showNotification('info', 'Recording', 'Recording started... Speak now');
      };
      
      recognition.onresult = function(event) {
        let interimTranscript = '';
        let finalTranscript = '';
        
        for (let i = event.resultIndex; i < event.results.length; i++) {
          const transcript = event.results[i][0].transcript;
          if (event.results[i].isFinal) {
            finalTranscript += transcript;
          } else {
            interimTranscript += transcript;
          }
        }
        
        // Update textarea with interim results
        document.getElementById('symptomText').value = finalTranscript + interimTranscript;
      };
      
      recognition.onerror = function(event) {
        console.error('Speech recognition error', event.error);
        showNotification('error', 'Error', `Speech recognition error: ${event.error}`);
        stopVoiceRecording();
      };
      
      recognition.onend = function() {
        if (isRecording) {
          // If recording ended unexpectedly, try to restart
          try {
            recognition.start();
          } catch (e) {
            stopVoiceRecording();
          }
        }
      };
      
      try {
        recognition.start();
      } catch (e) {
        showNotification('error', 'Error', `Error starting voice recognition: ${e.message}`);
      }
    }
    
    function stopVoiceRecording() {
      if (recognition && isRecording) {
        recognition.stop();
        isRecording = false;
        document.getElementById('recordingStatus').style.display = 'none';
        document.getElementById('stopRecordingBtn').style.display = 'none';
        
        // Show translation status
        document.getElementById('translationStatus').style.display = 'block';
        
        // If not English, simulate translation (in a real app, this would call a translation API)
        if (recordingLanguage !== 'en') {
          setTimeout(() => {
            translateSymptomsToEnglish();
          }, 1500);
        } else {
          // If already English, just run the symptom analysis
          setTimeout(() => {
            document.getElementById('translationStatus').style.display = 'none';
            runSymptom();
            cancelRecording();
          }, 1000);
        }
      }
    }
    
    function cancelRecording() {
      if (recognition && isRecording) {
        recognition.stop();
      }
      isRecording = false;
      document.getElementById('voiceRecorder').style.display = 'none';
      document.getElementById('voiceSymptom').style.display = 'block';
      document.getElementById('recordingStatus').style.display = 'none';
      document.getElementById('stopRecordingBtn').style.display = 'none';
      document.getElementById('translationStatus').style.display = 'none';
    }
    
    function translateSymptomsToEnglish() {
      const symptomText = document.getElementById('symptomText').value;
      
      // In a real application, this would call a translation API
      // For demo purposes, we'll simulate translation with some predefined examples
      
      let translatedText = '';
      
      if (recordingLanguage === 'hi') {
        // Simulate Hindi to English translation
        if (symptomText.includes('‡§¨‡•Å‡§ñ‡§æ‡§∞') || symptomText.includes('‡§§‡§æ‡§™')) {
          translatedText = 'I have fever and headache since morning.';
        } else if (symptomText.includes('‡§ñ‡§æ‡§Ç‡§∏‡•Ä') || symptomText.includes('‡§ú‡•Å‡§ñ‡§æ‡§Æ')) {
          translatedText = 'I have cough and cold with chest congestion.';
        } else if (symptomText.includes('‡§™‡•á‡§ü') || symptomText.includes('‡§¶‡§∞‡•ç‡§¶')) {
          translatedText = 'Stomach pain and loose motions since yesterday.';
        } else {
          // Generic translation simulation
          translatedText = 'I am experiencing ' + symptomText + '. This started a few days ago.';
        }
      } else if (recordingLanguage === 'pa') {
        // Simulate Punjabi to English translation
        if (symptomText.includes('‡®¨‡©Å‡®ñ‡®æ‡®∞') || symptomText.includes('‡®§‡®æ‡®™')) {
          translatedText = 'I have high fever and body aches.';
        } else if (symptomText.includes('‡®ñ‡®æ‡®Ç‡®∏‡©Ä') || symptomText.includes('‡®ú‡©Å‡®ï‡®æ‡®Æ')) {
          translatedText = 'Dry cough and running nose for three days.';
        } else if (symptomText.includes('‡®™‡©á‡®ü') || symptomText.includes('‡®¶‡®∞‡®¶')) {
          translatedText = 'Severe stomach pain with vomiting.';
        } else {
          // Generic translation simulation
          translatedText = 'I have been feeling ' + symptomText + ' for some time now.';
        }
      }
      
      // Update the textarea with the translated text
      document.getElementById('symptomText').value = translatedText;
      
      // Hide translation status and run symptom analysis
      document.getElementById('translationStatus').style.display = 'none';
      runSymptom();
      cancelRecording();
      
      showNotification('success', 'Translation', 'Symptoms translated to English successfully');
    }
    
    /* ---------- Symptom analyzer demo ---------- */
    function runSymptom(){
      const txt = document.getElementById('symptomText').value.trim();
      if(!txt){ 
        showNotification('warning', 'Validation', 'Please describe your symptoms'); 
        return; 
      }
      const res = document.getElementById('symptomResult');
      const outcome = document.getElementById('symptomOutcome');
      // extremely simple demo rules
      const t = txt.toLowerCase();
      if(t.includes('fever')) outcome.textContent = 'Like signs of fever. Suggest paracetamol 500mg, rest & hydrate. If temp > 102¬∞F, book consult.';
      else if(t.includes('cough')) outcome.textContent = 'Cough symptoms‚Äîkeep hydrated. If shortness of breath, seek immediate care.';
      else outcome.textContent = 'Not enough info ‚Äî recommend a short consult. You can request a chat or video from the Doctors tab.';
      res.style.display='block';
      res.scrollIntoView({behavior:'smooth'});
    }
    
    /* ---------- Pharmacies rendering demo ---------- */
    let map, userMarker, pharmacyMarkers = [];
    
    function initPharmacyMap() {
      const box = document.getElementById('pharmMap');
      box.innerHTML = ''; // Clear placeholder
    
      // Initialize map centered roughly in Nabha
      map = L.map('pharmMap').setView([30.3800, 76.1140], 13); 
    
      // Add OSM tiles
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '¬© OpenStreetMap'
      }).addTo(map);
    
      // Ask for user location
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(pos => {
          const lat = pos.coords.latitude;
          const lng = pos.coords.longitude;
          map.setView([lat, lng], 15);
    
          userMarker = L.marker([lat,lng], {title:"You are here"}).addTo(map)
            .bindPopup("You are here").openPopup();
    
          // Render pharmacies near user
          renderPharmaciesOnMap(lat, lng);
        }, err => {
          showNotification('warning', 'Location', "Location permission denied. Showing default view.");
          renderPharmaciesOnMap(30.3800, 76.1140);
        });
      } else {
        showNotification('warning', 'Location', "Geolocation not supported. Showing default view.");
        renderPharmaciesOnMap(30.3800, 76.1140);
      }
    }
    
    function renderPharmaciesOnMap(lat, lng) {
      // Clear previous markers
      pharmacyMarkers.forEach(m => map.removeLayer(m));
      pharmacyMarkers = [];
    
      const q = document.getElementById('medSearch').value.trim().toLowerCase();
    
      pharmacies.forEach(p => {
        // Fake randomize lat/lng nearby for demo
        const plat = lat + (Math.random()-0.5)/500;
        const plng = lng + (Math.random()-0.5)/500;
    
        // Check medicine filter
        const hasMed = !q || p.meds.join(' ').toLowerCase().includes(q);
    
        const marker = L.marker([plat, plng], {title: p.name}).addTo(map);
        marker.bindPopup(`
          <div style="font-weight:800">${p.name}</div>
          <div class="small">Medicines: ${hasMed ? p.meds.join(', ') : 'Not available'}</div>
        `);
        pharmacyMarkers.push(marker);
      });
    }
    
    // Update map when searching for a medicine
    document.getElementById('medSearch').addEventListener('input', () => {
      if(map && userMarker){
        const pos = userMarker.getLatLng();
        renderPharmaciesOnMap(pos.lat, pos.lng);
      }
    });
    
    // Initialize map on tab open
    document.querySelector('.navitem[data-tab="pharmacies"]').addEventListener('click', () => {
      setTimeout(initPharmacyMap, 300); // Delay to ensure tab is visible
    });
    
    /* ---------- Notification utility ---------- */
    function showNotification(type, title, message) {
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.innerHTML = `
        <div class="notification-icon">
          ${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è'}
        </div>
        <div class="notification-content">
          <div class="notification-title">${title}</div>
          <div class="notification-message">${message}</div>
        </div>
        <button class="notification-close">&times;</button>
      `;
      
      document.getElementById('notificationContainer').appendChild(notification);
      
      // Show notification
      setTimeout(() => notification.classList.add('show'), 10);
      
      // Auto hide after 5 seconds
      const hideTimeout = setTimeout(() => {
        hideNotification(notification);
      }, 5000);
      
      // Close button
      notification.querySelector('.notification-close').addEventListener('click', () => {
        clearTimeout(hideTimeout);
        hideNotification(notification);
      });
    }
    
    function hideNotification(notification) {
      notification.classList.remove('show');
      setTimeout(() => notification.remove(), 300);
    }
    
    /* ---------- Toast utility (deprecated in favor of notifications) ---------- */
    function toast(msg){
      showNotification('info', 'Notification', msg);
    }
    
    /* ---------- Init default render ---------- */
    renderTopDoctors();
    renderAvailable();
    renderVisited();
    
    /* small helper to open tab from links */
    function openTab(tabId){
      document.querySelectorAll('.navitem').forEach(n=>n.classList.remove('active'));
      const node = document.querySelector(`.navitem[data-tab="${tabId}"]`);
      if(node) node.classList.add('active');
      sections.forEach(s=>s.classList.remove('active'));
      const target = document.getElementById(tabId);
      if(target) target.classList.add('active');
    }
    
    let clinicMap, userClinicMarker, clinicMarkers = [];
    
    function initClinicMap() {
      const box = document.getElementById('clinicMap');
      box.innerHTML = ''; // Clear old content
    
      // Initialize map with rough center
      clinicMap = L.map('clinicMap').setView([30.3800, 76.1140], 13);
    
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '¬© OpenStreetMap'
      }).addTo(clinicMap);
    
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(pos => {
          const lat = pos.coords.latitude;
          const lng = pos.coords.longitude;
          clinicMap.setView([lat, lng], 15);
    
          userClinicMarker = L.marker([lat,lng], {title:"You are here"}).addTo(clinicMap)
            .bindPopup("You are here").openPopup();
    
          renderClinicsOnMap(lat, lng);
        }, err => {
          showNotification('warning', 'Location', "Location permission denied. Showing default view.");
          renderClinicsOnMap(30.3800, 76.1140);
        });
      } else {
        showNotification('warning', 'Location', "Geolocation not supported. Showing default view.");
        renderClinicsOnMap(30.3800, 76.1140);
      }
    }
    
    function renderClinicsOnMap(lat, lng) {
      clinicMarkers.forEach(m => clinicMap.removeLayer(m));
      clinicMarkers = [];
    
      clinics.forEach(c => {
        const clat = lat + (Math.random()-0.5)/500; // demo nearby
        const clng = lng + (Math.random()-0.5)/500;
    
        const marker = L.marker([clat, clng], {title: c.name}).addTo(clinicMap);
    
        // Calculate distance & travel time (approx, using straight line for demo)
        const distance = getDistanceFromLatLonInKm(lat, lng, clat, clng).toFixed(2);
        const travelTime = (distance/40*60).toFixed(0); // assuming avg 40 km/h
    
        marker.bindPopup(`
          <div style="font-weight:800">${c.name}</div>
          <div class="small">Distance: ${distance} km</div>
          <div class="small">Estimated travel time: ${travelTime} min</div>
        `);
    
        clinicMarkers.push(marker);
      });
    }
    
    // Haversine formula for distance calculation
    function getDistanceFromLatLonInKm(lat1,lon1,lat2,lon2) {
      const R = 6371; // km
      const dLat = deg2rad(lat2-lat1);
      const dLon = deg2rad(lon2-lon1);
      const a = 
        Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * 
        Math.sin(dLon/2) * Math.sin(dLon/2)
        ; 
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
      return R * c;
    }
    
    function deg2rad(deg) { return deg * (Math.PI/180); }
    
    // Initialize map when doctor tab opens
    document.querySelector('.navitem[data-tab="doctors"]').addEventListener('click', () => {
      setTimeout(initClinicMap, 300); // wait for tab render
    });
    
    function previewImage(event) {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          const imgSrc = e.target.result; // Get the original data URL
          
          // Create a temporary image to get dimensions
          const tempImg = new Image();
          tempImg.onload = function() {
            // Create a canvas to resize/compress the image
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // Set max dimensions (e.g., 200x200 pixels)
            const maxSize = 200;
            let width = tempImg.width;
            let height = tempImg.height;
            
            if (width > height) {
              if (width > maxSize) {
                height = Math.round((height * maxSize) / width);
                width = maxSize;
              }
            } else {
              if (height > maxSize) {
                width = Math.round((width * maxSize) / height);
                height = maxSize;
              }
            }
            
            canvas.width = width;
            canvas.height = height;
            
            // Draw image on canvas (this resizes it)
            ctx.drawImage(tempImg, 0, 0, width, height);
            
            // Get compressed data URL (lower quality = smaller size)
            const compressedSrc = canvas.toDataURL('image/jpeg', 0.7); // 70% quality
            
            // Update the display
            document.getElementById("profile-img").src = compressedSrc;
            document.getElementById("profile-img").style.display = "block";
            document.getElementById("profile-initials").style.display = "none";
            
            // Save the COMPRESSED image to localStorage
            const profileData = JSON.parse(localStorage.getItem('patientProfileData') || '{}');
            profileData.profilePhoto = compressedSrc;
            localStorage.setItem('patientProfileData', JSON.stringify(profileData));
          };
          tempImg.src = imgSrc;
        };
        reader.readAsDataURL(file);
      }
    }
    
    //patient emergency sos
    function requestAmbulance() {
      showNotification('success', 'Ambulance', "Ambulance request sent. Nearby service alerted.");
      // Call your API: POST /api/sos/ambulance
    }
    
    function alertDoctor() {
      showNotification('success', 'Doctor', "Doctor notified of emergency.");
      // API: POST /api/sos/doctor
    }
    
    function notifyFamily() {
      showNotification('success', 'Family', "Family members have been notified.");
      // API: Notify emergency contacts
    }
    
    function shareLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition((pos) => {
          showNotification('success', 'Location', "Live location shared with emergency team.");
          console.log("Lat:", pos.coords.latitude, "Lng:", pos.coords.longitude);
          // Send to backend API
        });
      } else {
        showNotification('error', 'Location', "Location not supported on this device.");
      }
    }
    
    function openFirstAid() {
      showNotification('info', 'First Aid', "Opening first aid guide...");
    }
    
    function emergencyHotline() {
      window.location.href = "tel:108";
    }
    
    function uploadEmergencyDocs() {
      showNotification('info', 'Upload', "Upload reports for emergency team...");
    }
    
    function setEmergencyContacts() {
      showNotification('info', 'Contacts', "Manage your emergency contacts...");
    }
    
    // Toggle between view and edit modes
    function toggleEditMode(editMode) {
        const editBtn = document.getElementById('editProfileBtn');
        const saveBtn = document.getElementById('saveProfileBtn');
        const cancelBtn = document.getElementById('cancelEditBtn');
        const addFamilyBtn = document.getElementById('addFamilyMemberBtn');
        const editIcon = document.getElementById('profileImageEditIcon');
        
        if (editMode) {
          // Switch to edit mode
          editBtn.style.display = 'none';
          saveBtn.style.display = 'block';
          cancelBtn.style.display = 'block';
          addFamilyBtn.style.display = 'block';
          editIcon.style.display = 'block';
          
          // Show all edit fields
          document.querySelectorAll('.editable-field').forEach(field => {
            const display = field.querySelector('[id$="-display"]');
            const edit = field.querySelector('[id$="-edit"]');
            
            if (display && edit) {
              display.style.display = 'none';
              edit.style.display = 'block';
            }
          });
          
          // Show family member actions
          document.querySelectorAll('.member-actions').forEach(action => {
            action.style.display = 'flex';
          });
        } else {
          // Switch to view mode
          editBtn.style.display = 'block';
          saveBtn.style.display = 'none';
          cancelBtn.style.display = 'none';
          addFamilyBtn.style.display = 'none';
          editIcon.style.display = 'none';
          
          // Hide all edit fields
          document.querySelectorAll('.editable-field').forEach(field => {
            const display = field.querySelector('[id$="-display"]');
            const edit = field.querySelector('[id$="-edit"]');
            
            if (display && edit) {
              display.style.display = 'block';
              edit.style.display = 'none';
            }
          });
          
          // Hide family member actions and add form
          document.querySelectorAll('.member-actions').forEach(action => {
            action.style.display = 'none';
          });
          document.getElementById('add-family-form').style.display = 'none';
        }
      }
      
    // Save profile changes
    function saveProfileChanges() {
      // Update name
      const newName = document.getElementById('profile-name-edit').value;
      document.getElementById('profile-name-display').textContent = newName;
      // Update details
      const patientId = document.getElementById('patient-id-edit').value;
      const age = document.getElementById('age-edit').value;
      const gender = document.getElementById('gender-edit').value;
      const location = document.getElementById('location-edit').value;
      document.getElementById('profile-details-display').textContent = 
        `${patientId} ‚Ä¢ Age ${age} ‚Ä¢ ${gender} ‚Ä¢ ${location}`;
      // Update medical history
      const conditions = document.getElementById('conditions-edit').value;
      const allergies = document.getElementById('allergies-edit').value;
      document.getElementById('medical-history-display').textContent = 
        `${conditions} ‚Ä¢ Allergies: ${allergies}`;
      
      // ‚úÖ Get current profile photo from the img element
      const profileImgElement = document.getElementById("profile-img");
      const photoSrc = (profileImgElement && profileImgElement.style.display !== "none") ? profileImgElement.src : '';
    
      // Save data to localStorage - ‚úÖ NOW INCLUDES profilePhoto
      const profileData = {
        name: newName,
        patientId: patientId,
        age: age,
        gender: gender,
        location: location,
        medicalHistory: {
          conditions: conditions,
          allergies: allergies
        },
        profilePhoto: photoSrc // ‚úÖ This line was missing before
      };
      localStorage.setItem('patientProfileData', JSON.stringify(profileData));
      // Exit edit mode
      toggleEditMode(false);
      // Show success message
      showNotification('success', 'Profile', 'Profile updated successfully');
    }
    // Load profile data from localStorage
    function loadProfileData() {
      const savedData = localStorage.getItem('patientProfileData');
      if (savedData) {
        try {
          const profileData = JSON.parse(savedData);
          // Update display elements
          document.getElementById('profile-name-display').textContent = profileData.name;
          document.getElementById('profile-details-display').textContent = 
            `${profileData.patientId} ‚Ä¢ Age ${profileData.age} ‚Ä¢ ${profileData.gender} ‚Ä¢ ${profileData.location}`;
          document.getElementById('medical-history-display').textContent = 
            `${profileData.medicalHistory.conditions} ‚Ä¢ Allergies: ${profileData.medicalHistory.allergies}`;
          // Update edit fields (so if user clicks Edit again, they see the latest data)
          document.getElementById('profile-name-edit').value = profileData.name;
          document.getElementById('patient-id-edit').value = profileData.patientId;
          document.getElementById('age-edit').value = profileData.age;
          document.getElementById('gender-edit').value = profileData.gender;
          document.getElementById('location-edit').value = profileData.location;
          document.getElementById('conditions-edit').value = profileData.medicalHistory.conditions;
          document.getElementById('allergies-edit').value = profileData.medicalHistory.allergies;
    
          // --- NEW: Restore profile photo if it exists ---
          if (profileData.profilePhoto) {
            document.getElementById("profile-img").src = profileData.profilePhoto;
            document.getElementById("profile-img").style.display = "block";
            document.getElementById("profile-initials").style.display = "none";
          }
          // --- END NEW ---
    
        } catch (e) {
          console.error('Error loading profile data from localStorage:', e);
        }
      }
    }
    
      // Family member functions
      function addFamilyMember() {
        document.getElementById('add-family-form').style.display = 'block';
      }
      
      function cancelAddFamilyMember() {
        document.getElementById('add-family-form').style.display = 'none';
        document.getElementById('new-member-name').value = '';
        document.getElementById('new-member-relation').value = '';
      }
      
      function saveNewFamilyMember() {
        const name = document.getElementById('new-member-name').value;
        const relation = document.getElementById('new-member-relation').value;
        
        if (name && relation) {
          const newMember = document.createElement('div');
          newMember.className = 'family-member-item';
          newMember.innerHTML = `
            <span>${name} (${relation})</span>
            <div class="member-actions" style="display: flex;">
              <button class="icon-btn" onclick="editFamilyMember(this.parentElement.parentElement)">‚úèÔ∏è</button>
              <button class="icon-btn" onclick="removeFamilyMember(this.parentElement.parentElement)">üóëÔ∏è</button>
            </div>
          `;
          
          document.getElementById('family-members-list').appendChild(newMember);
          cancelAddFamilyMember();
          showNotification('success', 'Family', 'Family member added');
        }
      }
      
      function editFamilyMember(memberElement) {
        const text = memberElement.querySelector('span').textContent;
        const regex = /(.+) \((.+)\)/;
        const match = text.match(regex);
        
        if (match) {
          const name = match[1];
          const relation = match[2];
          
          memberElement.innerHTML = `
            <div style="display: flex; gap: 8px; flex: 1;">
              <input type="text" value="${name}" style="flex: 1; border: 1px solid var(--border); padding: 4px 8px; border-radius: 4px;">
              <input type="text" value="${relation}" style="flex: 1; border: 1px solid var(--border); padding: 4px 8px; border-radius: 4px;">
            </div>
            <div class="member-actions" style="display: flex;">
              <button class="icon-btn" onclick="saveFamilyMemberEdit(this.parentElement.parentElement)">üíæ</button>
              <button class="icon-btn" onclick="cancelFamilyMemberEdit(this.parentElement.parentElement, '${name}', '${relation}')">‚ùå</button>
            </div>
          `;
        }
      }
      
      function saveFamilyMemberEdit(memberElement) {
        const inputs = memberElement.querySelectorAll('input');
        const name = inputs[0].value;
        const relation = inputs[1].value;
        
        if (name && relation) {
          memberElement.innerHTML = `
            <span>${name} (${relation})</span>
            <div class="member-actions" style="display: flex;">
              <button class="icon-btn" onclick="editFamilyMember(this.parentElement.parentElement)">‚úèÔ∏è</button>
              <button class="icon-btn" onclick="removeFamilyMember(this.parentElement.parentElement)">üóëÔ∏è</button>
            </div>
          `;
          showNotification('success', 'Family', 'Family member updated');
        }
      }
      
      function cancelFamilyMemberEdit(memberElement, originalName, originalRelation) {
        memberElement.innerHTML = `
          <span>${originalName} (${originalRelation})</span>
          <div class="member-actions" style="display: flex;">
            <button class="icon-btn" onclick="editFamilyMember(this.parentElement.parentElement)">‚úèÔ∏è</button>
            <button class="icon-btn" onclick="removeFamilyMember(this.parentElement.parentElement)">üóëÔ∏è</button>
          </div>
        `;
      }
      
      function removeFamilyMember(memberElement) {
        if (confirm('Are you sure you want to remove this family member?')) {
          memberElement.remove();
          showNotification('success', 'Family', 'Family member removed');
        }
      }
    
    /* ---------- Alert Section Functions ---------- */
    
    // Initialize alerts section
    function initAlerts() {
      renderAlerts();
      updateAlertCounts();
      checkActiveConsultation();
      
      // Set current date for payment success modal
      const now = new Date();
      document.getElementById('paymentDate').textContent = now.toLocaleDateString() + ' ' + now.toLocaleTimeString();
      
      // Add event listener for sending messages
      const chatInput = document.getElementById('chatInput');
      if (chatInput) {
        chatInput.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            sendMessage();
          }
        });
      }
    }
    
    // Update alert counts in the summary cards
    function updateAlertCounts() {
      document.getElementById('refillCount').textContent = alertsData.refill.filter(a => a.status === 'pending').length;
      document.getElementById('followupCount').textContent = alertsData.followup.filter(a => a.status === 'pending').length;
      document.getElementById('appointmentCount').textContent = alertsData.consultation.filter(a => a.status === 'scheduled' || a.status === 'active').length;
    }
    
    // Switch between alert tabs
    function switchAlertTab(button) {
      document.querySelectorAll('.pill[data-alert-type]').forEach(pill => pill.classList.remove('active'));
      button.classList.add('active');
      renderAlerts();
    }
    
    // Render alerts based on selected tab
    // Update the alerts rendering logic in renderAlerts function
alertsToShow.forEach(alert => {
  const alertEl = document.createElement('div');
  alertEl.className = 'alert-item';
  
  // Add urgency class for styling
  if (alert.urgency) {
    alertEl.classList.add(`urgency-${alert.urgency}`);
  }
  
  let icon = 'üîî';
  let actionButton = '';
  let statusBadge = '';
  
  if (alert.type === 'refill') {
    icon = 'üíä';
    actionButton = `
      <button class="btn" onclick="requestRefill('${alert.id}')">Request Refill</button>
      <button class="btn ghost" onclick="contactPharmacy('${alert.id}')">Contact Pharmacy</button>
    `;
    
    // Add urgency indicator
    statusBadge = `<div class="status ${alert.urgency === 'high' ? 'busy' : ''}">${alert.urgency} priority</div>`;
  } else if (alert.type === 'followup') {
    icon = 'üîÑ';
    actionButton = `
      <button class="btn" onclick="scheduleFollowup('${alert.id}')">Schedule</button>
      <button class="btn ghost" onclick="reschedule('${alert.id}')">Reschedule</button>
    `;
  } else if (alert.type === 'consultation') {
    icon = 'üìÖ';
    if (alert.status === 'scheduled' && alert.paymentStatus === 'pending') {
      actionButton = `<button class="btn" onclick="openPaymentModal('${alert.id}')">Pay & Confirm</button>`;
      statusBadge = `<div class="status">Payment pending</div>`;
    } else if (alert.status === 'scheduled' && alert.paymentStatus === 'completed') {
      actionButton = `<button class="btn" onclick="viewConsultation('${alert.id}')">View Details</button>`;
      statusBadge = `<div class="status">Confirmed</div>`;
    } else if (alert.status === 'active') {
      // Only show reschedule for active consultations (after payment)
      actionButton = `
        <button class="btn" onclick="joinConsultation('${alert.id}')">Join Now</button>
        <button class="btn ghost" onclick="rescheduleConsultation('${alert.id}')">Reschedule</button>
      `;
      statusBadge = `<div class="status">Active</div>`;
    }
  }
  
  alertEl.innerHTML = `
    <div class="alert-icon" style="background: #1890ff20; color: #1890ff">
      ${icon}
    </div>
    <div class="alert-content">
      <div class="alert-title">${alert.type === 'refill' ? alert.medicine : alert.purpose}</div>
      <div class="alert-desc">${alert.type === 'refill' ? alert.remaining : alert.doctor.name}</div>
      <div class="alert-time">${formatDate(alert.date)}${alert.time ? ' ‚Ä¢ ' + alert.time : ''}</div>
      ${alert.type === 'refill' && alert.dosage ? `<div class="small muted">${alert.dosage}</div>` : ''}
    </div>
    <div class="alert-actions">
      ${statusBadge}
      ${actionButton}
      <button class="btn ghost" onclick="dismissAlert('${alert.id}')">Dismiss</button>
    </div>
  `;
  
  alertsList.appendChild(alertEl);
});

// Function to handle appointment acceptance from doctor
function handleAppointmentAcceptance(data) {
  // Create a new consultation alert
  const newConsultation = {
    id: data.consultationId || 'alert-' + Date.now(),
    type: 'consultation',
    purpose: data.purpose || 'General Consultation',
    date: data.scheduledDate,
    time: data.scheduledTime,
    status: 'scheduled',
    duration: data.scheduledDuration || 15,
    doctor: {
      id: data.doctorId,
      name: data.doctorName,
      specialization: data.doctorSpecialization || 'General Physician',
      fee: data.doctorFee || 500,
      contact: data.doctorContact || '+91-98765-43210',
      rating: data.doctorRating || 4.7
    },
    paymentStatus: 'pending',
    symptoms: data.symptoms || [],
    scheduledOn: new Date().toISOString().split('T')[0]
  };
  
  // Add to alerts data
  alertsData.consultation.push(newConsultation);
  
  // Save to localStorage
  localStorage.setItem('alertsData', JSON.stringify(alertsData));
  
  // Refresh alerts
  renderAlerts();
  updateAlertCounts();
  
  // Show notification
  showNotification('success', 'Appointment Confirmed', 
    `Your appointment with ${data.doctorName} has been confirmed for ${data.scheduledDate} at ${data.scheduledTime}.`);
}


    
    // Enhanced checkActiveConsultation function
    function checkActiveConsultation() {
      const consultationSection = document.getElementById('consultationSection');
      const activeConsult = alertsData.consultation.find(c => c.status === 'active');
      if (activeConsult) {
        activeConsultation = activeConsult;
        consultationSection.style.display = 'block';
        document.getElementById('consultDoctorAvatar').textContent = 
          activeConsult.doctor.name.split(' ').map(n => n[0]).join('').substring(0, 2);
        document.getElementById('consultDoctorName').textContent = activeConsult.doctor.name;
        document.getElementById('consultDoctorSpec').textContent = 
          `${activeConsult.doctor.specialization} ‚Ä¢ ${activeConsult.doctor.id}`;
        document.getElementById('consultTime').textContent = 
          `Scheduled: ${formatDate(activeConsult.date)}${activeConsult.time ? ', ' + activeConsult.time : ''}`;
        if (activeConsult.paymentStatus === 'completed') {
          document.getElementById('consultationStatus').textContent = 'Ready to join';
          document.getElementById('joinConsultBtn').textContent = 'Join Consultation';
          document.getElementById('consultActions').style.display = 'block';
        } else {
          document.getElementById('consultationStatus').textContent = 'Payment pending';
          document.getElementById('joinConsultBtn').textContent = 'Complete Payment';
          document.getElementById('consultActions').style.display = 'none';
        }
      } else {
        consultationSection.style.display = 'none';
      }
    }
    
    // Request medicine refill
    function requestRefill(alertId) {
      const alert = [...alertsData.refill, ...alertsData.followup, ...alertsData.consultation]
        .find(a => a.id === alertId);
      
      if (alert) {
        showNotification('success', 'Refill', `Refill request sent to ${alert.doctor.name}`);
        // In a real app, this would send a request to the doctor/pharmacy
      }
    }
    
    // Contact pharmacy
    function contactPharmacy(alertId) {
      const alert = alertsData.refill.find(a => a.id === alertId);
      if (alert) {
        showNotification('info', 'Pharmacy', `Calling ${alert.pharmacy.name} at ${alert.pharmacy.phone}`);
        // In a real app, this would initiate a call or show contact options
      }
    }
    
    // Schedule follow-up
    function scheduleFollowup(alertId) {
      const alert = [...alertsData.refill, ...alertsData.followup, ...alertsData.consultation]
        .find(a => a.id === alertId);
      
      if (alert) {
        // Show calendar interface for scheduling
        showSchedulingModal(alert);
      }
    }
    
    // Reschedule appointment
    function reschedule(alertId) {
      const alert = [...alertsData.followup, ...alertsData.consultation].find(a => a.id === alertId);
      if (alert) {
        // Show calendar interface with available slots
        const availableSlots = [
          '2025-09-13 at 10:00 AM',
          '2025-09-13 at 02:00 PM',
          '2025-09-14 at 11:30 AM',
          '2025-09-15 at 09:00 AM'
        ];
        
        let slotsHtml = availableSlots.map(slot => `
          <div style="padding:8px;border:1px solid #eef6f2;border-radius:8px;margin-bottom:8px;cursor:pointer" onclick="selectTimeSlot('${alertId}', '${slot}')">
            ${slot}
          </div>
        `).join('');
        
        const modal = document.getElementById('recordDetailModal');
        const content = document.getElementById('recordDetailContent');
        const title = document.getElementById('recordModalTitle');
        
        title.textContent = 'Reschedule Appointment';
        content.innerHTML = `
          <div style="margin-bottom:16px">
            <div style="font-weight:700">Current appointment:</div>
            <div>${formatDate(alert.date)}${alert.time ? ' at ' + alert.time : ''} with ${alert.doctor.name}</div>
          </div>
          <div style="margin-bottom:16px">
            <div style="font-weight:700">Available time slots:</div>
            <div style="margin-top:8px">
              ${slotsHtml}
            </div>
          </div>
          <button class="btn" onclick="closeRecordModal()">Cancel</button>
        `;
        
        modal.classList.add('open');
        document.body.style.overflow = 'hidden';
      }
    }
    
    // Select time slot function
    // Enhanced selectTimeSlot function for rescheduling
function selectTimeSlot(alertId, slot) {
  const reason = document.getElementById('rescheduleReason')?.value || 'Patient requested reschedule';
  
  // Find the consultation
  const consultation = alertsData.consultation.find(a => a.id === alertId);
  if (consultation) {
    // Create reschedule request
    const rescheduleRequest = {
      id: 'reschedule-' + Date.now(),
      consultationId: consultation.id,
      patientId: consultation.id,
      patientName: document.getElementById('patTopName')?.textContent || 'Patient',
      doctorId: consultation.doctor.id,
      doctorName: consultation.doctor.name,
      currentDate: consultation.date,
      currentTime: consultation.time,
      requestedDate: slot.split(' at ')[0],
      requestedTime: slot.split(' at ')[1],
      reason: reason,
      status: 'pending',
      timestamp: Date.now()
    };
    
    // Store in localStorage for doctor to receive
    localStorage.setItem('rescheduleRequest', JSON.stringify(rescheduleRequest));
    localStorage.setItem('newRescheduleRequest', JSON.stringify(rescheduleRequest));
    
    closeRecordModal();
    closeAppointmentDetails();
    showNotification('info', 'Request Sent', 'Your reschedule request has been sent to the doctor.');
  }
}
    // Show scheduling modal
    // Show calendar-based scheduling modal with boxed dates
    function showSchedulingModal(alert) {
      const today = new Date();
      const days = [];
      for (let i = 0; i < 7; i++) {
        const date = new Date(today);
        date.setDate(today.getDate() + i);
        days.push(date);
      }
    
      const timeSlots = ['09:00 AM', '10:30 AM', '12:00 PM', '02:00 PM', '04:00 PM', '06:00 PM'];
    
      // Generate boxed date buttons
      let daysHtml = days.map(day => {
        const dateStr = day.toISOString().split('T')[0]; // "YYYY-MM-DD"
        const weekday = day.toLocaleDateString(undefined, { weekday: 'short' }); // e.g. "Mon"
        const monthDay = day.toLocaleDateString(undefined, { month: 'short', day: 'numeric' }); // e.g. "Sep 5"
    
        return `
          <div class="date-box" data-date="${dateStr}" onclick="selectCalendarDay(this, '${alert.id}')">
            <div class="weekday">${weekday}</div>
            <div class="month-day">${monthDay}</div>
          </div>
        `;
      }).join('');
    
      // Create modal
      const modal = document.createElement('div');
      modal.className = 'family-member-panel open';
      modal.id = 'reschedule-modal';
      modal.innerHTML = `
        <div class="family-member-content" style="max-width: 500px;">
          <div class="family-member-header">
            <h3>Reschedule Appointment</h3>
            <button class="family-member-close" onclick="closeRescheduleModal()">&times;</button>
          </div>
          <div style="padding: 20px;">
            <div style="margin-bottom:16px">
              <div style="font-weight:700">Current appointment:</div>
              <div>${formatDate(alert.date)} at ${alert.time} with ${alert.doctor.name}</div>
            </div>
    
            <div style="margin-bottom:16px; font-weight:700">Choose a new date:</div>
            <div class="calendar-days" style="
              display: grid;
              grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
              gap: 12px;
              margin-bottom: 24px;
            ">
              ${daysHtml}
            </div>
    
            <div id="timeSlotsContainer" style="display:none; margin-bottom:20px;">
              <div style="font-weight:700; margin-bottom:8px">Choose a time:</div>
              <div id="timeSlotsList" style="
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
                gap: 8px;
                margin-bottom: 16px;
              ">
                <!-- Time slots will be inserted here -->
              </div>
            </div>
    
            <button class="btn" onclick="closeRescheduleModal()">Cancel</button>
          </div>
        </div>
      `;
    
      // Add CSS for date boxes
      const style = document.createElement('style');
      style.textContent = `
        .date-box {
          padding: 12px 8px;
          border: 2px solid #e0e0e0;
          border-radius: 12px;
          text-align: center;
          cursor: pointer;
          background: #fff;
          transition: all 0.2s ease;
          font-size: 0.9rem;
        }
        .date-box:hover {
          transform: translateY(-2px);
          box-shadow: 0 4px 8px rgba(0,0,0,0.1);
          border-color: #a0d8b3;
        }
        .date-box.selected {
          border-color: var(--brand);
          background: #f0f9ff;
          box-shadow: 0 4px 8px rgba(40,120,100,0.15);
        }
        .date-box .weekday {
          font-weight: 700;
          color: #333;
        }
        .date-box .month-day {
          font-size: 0.9rem;
          color: var(--muted);
        }
      `;
      document.head.appendChild(style);
    
      // Append modal to body
      document.body.appendChild(modal);
      document.body.style.overflow = 'hidden';
    
      // Close modal if clicked outside
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          closeRescheduleModal();
        }
      });
    }
    
    // Close the reschedule modal
    function closeRescheduleModal() {
      const modal = document.getElementById('reschedule-modal');
      if (modal) {
        modal.remove();
        document.body.style.overflow = '';
      }
    }
    
    // When user selects a day, show available time slots
    function selectCalendarDay(dayElement, alertId) {
      // Remove 'selected' class from all date boxes
      document.querySelectorAll('.date-box').forEach(el => {
        el.classList.remove('selected');
        el.style.transform = '';
        el.style.boxShadow = '';
      });
    
      // Add 'selected' class to clicked day
      dayElement.classList.add('selected');
    
      // Get selected date
      const selectedDate = dayElement.dataset.date;
    
      // Show time slots container
      const timeSlotsContainer = document.getElementById('timeSlotsContainer');
      const timeSlotsList = document.getElementById('timeSlotsList');
      timeSlotsContainer.style.display = 'block';
    
      const timeSlots = ['09:00 AM', '10:30 AM', '12:00 PM', '02:00 PM', '04:00 PM', '06:00 PM'];
    
      // Style time slots as boxes too
      timeSlotsList.innerHTML = timeSlots.map(slot => `
        <div class="time-slot-box" onclick="confirmReschedule('${alertId}', '${selectedDate}', '${slot}')">
          ${slot}
        </div>
      `).join('');
    
      // Add CSS for time slot boxes
      const style = document.createElement('style');
      style.textContent = `
        .time-slot-box {
          padding: 10px;
          border: 2px solid #e0e0e0;
          border-radius: 8px;
          text-align: center;
          cursor: pointer;
          background: #fff;
          font-weight: 600;
          font-size: 0.9rem;
          transition: all 0.2s ease;
        }
        .time-slot-box:hover {
          transform: translateY(-2px);
          box-shadow: 0 4px 8px rgba(0,0,0,0.1);
          border-color: var(--brand);
          background: #f0f9ff;
        }
      `;
      document.head.appendChild(style);
    }
    
    function confirmReschedule(alertId, newDate, newTime) {
      const consultation = alertsData.consultation.find(a => a.id === alertId);
      if (!consultation) return;
    
      const request = {
        id: 'req-' + Date.now(),
        consultationId: consultation.id,
        patientId: consultation.id,
        patientName: document.getElementById('patTopName')?.textContent || 'Patient',
        doctorId: consultation.doctor.id,
        currentDate: consultation.date,
        currentTime: consultation.time,
        requestedDate: newDate,
        requestedTime: newTime,
        status: 'pending',
        timestamp: Date.now()
      };
    
      // Store in localStorage for doctor to receive
      localStorage.setItem('rescheduleRequest', JSON.stringify(request));
      localStorage.setItem('newRescheduleRequest', JSON.stringify(request)); // üëà This triggers the event
    
      closeRescheduleModal();
      closeAppointmentDetails();
      showNotification('info', 'Request Sent', 'Your reschedule request has been sent to the doctor.');
    }
    
    // Listen for consultation updates from doctor portal
    window.addEventListener('storage', function(e) {
      if (e.key === 'consultationUpdated' && e.newValue) {
        const update = JSON.parse(e.newValue);
    
        // Find the consultation
        const consultation = alertsData.consultation.find(c => c.id === update.id);
        if (consultation) {
          // Update data
          consultation.date = update.date;
          consultation.time = update.time;
    
          // Refresh UI
          renderAlerts();
          updateUpcomingAppointmentInProfile();
    
          // Notify patient
          showNotification('success', 'Appointment Updated', 'Your appointment has been rescheduled by the doctor.');
        }
      }
    });
    
    function updateUpcomingAppointmentInProfile() {
      const scheduledConsultation = alertsData.consultation.find(c => c.status === 'scheduled');
      if (scheduledConsultation) {
        const profileAppointmentDiv = document.querySelector('#profile .card:first-child');
        if (profileAppointmentDiv) {
          profileAppointmentDiv.innerHTML = `
            <div style="display:flex;gap:12px;align-items:center;justify-content:space-between">
              <div>
                <div style="font-weight:800">Upcoming appointment</div>
                <div class="small">${formatDate(scheduledConsultation.date)} ‚Ä¢ ${scheduledConsultation.time} with ${scheduledConsultation.doctor.name}</div>
              </div>
              <div><button class="btn" onclick="showAppointmentDetails()">Details</button></div>
            </div>
          `;
        }
      }
    }
    // Confirm appointment
    function confirmAppointment(alertId, slot) {
      showNotification('success', 'Scheduled', `Appointment scheduled for ${slot}`);
      closeRecordModal();
      
      // Update the alert with new time (in a real app, this would call an API)
      const alert = [...alertsData.followup].find(a => a.id === alertId);
      if (alert) {
        const [date, , time] = slot.split(' ');
        alert.date = date;
        alert.time = time + ' ' + (slot.includes('AM') ? 'AM' : 'PM');
        alert.status = 'scheduled';
        
        // Refresh the UI
        renderAlerts();
        updateAlertCounts();
      }
    }
    
    // Enhanced openPaymentModal function
    function openPaymentModal(alertId) {
      const alert = alertsData.consultation.find(a => a.id === alertId);
      if (alert) {
        // --- NEW: Set the target consultation ID ---
        targetConsultationId = alertId;
        // --- END NEW ---
        console.log("Setting up payment for consultation:", alertId);
        
        // Populate payment details
        document.getElementById('consultationFee').textContent = alert.doctor.fee;
        document.getElementById('paymentDoctorName').textContent = alert.doctor.name;
        
        // Populate payment methods
        const paymentMethodsContainer = document.querySelector('.payment-methods');
        if (paymentMethodsContainer) {
          paymentMethodsContainer.innerHTML = '';
          paymentMethods.forEach(method => {
            const button = document.createElement('div');
            button.className = 'payment-method';
            button.dataset.method = method.id;
            button.innerHTML = `
              <div class="payment-method-icon">${method.icon}</div>
              <div>${method.name}</div>
            `;
            button.onclick = function() { selectPaymentMethod(this); };
            paymentMethodsContainer.appendChild(button);
          });
          
          // Select first payment method by default
          if (paymentMethodsContainer.firstChild) {
            paymentMethodsContainer.firstChild.classList.add('selected');
            selectPaymentMethod(paymentMethodsContainer.firstChild);
          }
        }
        
        const modal = document.getElementById('paymentModal');
        modal.classList.remove('hidden');
        modal.classList.add('open');
        document.body.style.overflow = 'hidden';
        console.log("Payment modal should now be visible");
      } else {
        console.error("Consultation not found for ID:", alertId);
        showNotification('error', 'Error', 'Consultation details not found.');
      }
    }
    
    // Enhanced closePaymentModal function
    function closePaymentModal() {
      const modal = document.getElementById('paymentModal');
      modal.classList.add('hidden');
      modal.classList.remove('open');
      document.body.style.overflow = '';
      document.getElementById('consultActions').style.display = 'none';
      cleanupResources();
    }
    
    // Enhanced closePaymentSuccessModal function
    function closePaymentSuccessModal() {
      const modal = document.getElementById('paymentSuccessModal');
      modal.classList.add('hidden');
      modal.classList.remove('open');
      document.body.style.overflow = '';
      cleanupResources();
    }
    
    // Select payment method
    function selectPaymentMethod(button) {
      // Remove selected class from all methods
      document.querySelectorAll('.payment-method').forEach(method => {
        method.classList.remove('selected');
      });
      
      // Add selected class to clicked method
      button.classList.add('selected');
      
      const method = button.dataset.method;
      
      // Show the appropriate form
      document.getElementById('cardPaymentForm').classList.add('hidden');
      document.getElementById('upiPaymentForm').classList.add('hidden');
      document.getElementById('netbankingPaymentForm').classList.add('hidden');
      document.getElementById('walletPaymentForm').classList.add('hidden');
      
      document.getElementById(`${method}PaymentForm`).classList.remove('hidden');
    }
    
    // Enhanced processPayment function
    function processPayment() {
        const payButton = event.target;
        const consultation = alertsData.consultation.find(c => c.id === targetConsultationId);
        if (!consultation) {
            showNotification('error', 'Error', 'Consultation not found.');
            return;
        }
    
        // Add loading state
        payButton.classList.add('btn-loading');
        payButton.innerHTML = '<span class="loading-spinner"></span>';
    
        // --- DIRECTLY OPEN RAZORPAY CHECKOUT (Test Mode) ---
        const options = {
            key: "rzp_test_RDrYTwDy9w9Ysm", // üëâ REPLACE THIS WITH YOUR TEST KEY
            amount: consultation.doctor.fee * 100, // Amount in paise
            currency: "INR",
            name: "SehatSetuNabha",
            description: "Consultation Fee",
            // --- NO order_id NEEDED IN TEST MODE ---
            handler: function (response) {
                // --- MOCK SUCCESS ---
                showNotification('success', 'Payment', 'Payment successful!');
                closePaymentModal();
                
                // Update consultation status
                consultation.paymentStatus = 'completed';
                consultation.status = 'active';
                localStorage.setItem('alertsData', JSON.stringify(alertsData));
    
                // Refresh UI
                checkActiveConsultation();
                renderAlerts();
                updateAlertCounts();
                
                // Show payment success modal
                document.getElementById('paymentSuccessModal').classList.remove('hidden');
    
                // Start consultation after a short delay
                setTimeout(() => {
                    if (activeConsultation && activeConsultation.id === targetConsultationId) {
                        startConsultation();
                        document.getElementById('paymentSuccessModal').classList.add('hidden');
                    }
                }, 2000);
    
                targetConsultationId = null;
                // Revert button state
                payButton.classList.remove('btn-loading');
                payButton.textContent = 'Pay Now';
            },
            modal: {
                ondismiss: function() {
                    showNotification('info', 'Cancelled', 'Payment cancelled.');
                    payButton.classList.remove('btn-loading');
                    payButton.textContent = 'Pay Now';
                }
            },
            theme: {
                color: "#2c6d52"
            }
        };
    
        const rzp = new Razorpay(options);
        rzp.open();
    }
    
    // Function to simulate entering a video consultation room
    function enterVideoRoom() {
      showNotification('success', 'Connecting', 'Connecting to video consultation room...');
      
      // In a real application, this would integrate with a WebRTC solution
      // For demonstration, we'll simulate the connection process
      
      setTimeout(() => {
        // Show the consultation interface
        const consultationInterface = document.getElementById('consultationInterface');
        consultationInterface.classList.remove('hidden');
        consultationInterface.classList.add('open');
        document.body.style.overflow = 'hidden';
        
        // Update the video container with a simulated video feed
        const videoContainer = document.getElementById('videoContainer');
        videoContainer.innerHTML = `
          <div style="text-align:center;color:white;height:100%;display:flex;flex-direction:column;justify-content:center;align-items:center">
            <div style="font-size:3rem;margin-bottom:16px">üë®‚Äç‚öïÔ∏è</div>
            <div>Dr. ${activeConsultation.doctor.name}</div>
            <div class="small muted">Video connected</div>
          </div>
        `;
        
        // Show a notification that the video has started
        showNotification('success', 'Connected', 'Video consultation started successfully');
        
        // Start the call timer
        callSeconds = 0;
        if (callTimerInterval) clearInterval(callTimerInterval);
        callTimerInterval = setInterval(updateCallTimer, 1000);
        
        // Simulate doctor joining after 2 seconds
        setTimeout(() => {
          const newMessage = {
            id: chatMessages[activeConsultation.consultationId].length + 1,
            sender: 'doctor',
            name: activeConsultation.doctor.name,
            message: 'I can see you now. How are you feeling today?',
            time: 'Now'
          };
          chatMessages[activeConsultation.consultationId].push(newMessage);
          
          const chatContainer = document.getElementById('chatMessages');
          const messageHtml = `
            <div style="margin-bottom:12px;display:flex;">
              <div style="max-width:70%;background:#f5f5f5;padding:8px 12px;border-radius:12px">
                <div style="font-weight:600;margin-bottom:4px">${newMessage.name}</div>
                <div>${newMessage.message}</div>
                <div class="small muted" style="text-align:right">${newMessage.time}</div>
              </div>
            </div>
          `;
          chatContainer.innerHTML += messageHtml;
          chatContainer.scrollTop = chatContainer.scrollHeight;
        }, 2000);
      }, 1500);
    }
    
    // Enhanced joinConsultation function
    function joinConsultation(consultationId) {
      // If no ID is provided, use the global activeConsultation (for backward compatibility)
      let consultation = activeConsultation;
      // If an ID is provided, find the consultation by ID
      if (consultationId) {
        consultation = alertsData.consultation.find(c => c.id === consultationId);
        // Set the target consultation ID for payment
        targetConsultationId = consultationId;
      }
      
      // If no consultation is found, show an error
      if (!consultation) {
        showNotification('error', 'Error', 'Consultation not found.');
        return;
      }
      
      // Check payment status
      if (consultation.paymentStatus !== 'completed') {
        // Open payment modal if not paid
        console.log("Opening payment modal for consultation:", consultationId);
        openPaymentModal(consultationId);
        return;
      }
      
      // Set this consultation as the active one
      activeConsultation = consultation;
      
      // Notify doctor that patient is joining
      localStorage.setItem('patientJoinedConsultation', JSON.stringify({
        consultationId: consultation.consultationId || consultation.id,
        patientId: consultation.id,
        timestamp: Date.now()
      }));
      
      // Start the consultation
      startConsultation();
    }
    
    // Enhanced startConsultation function with Twilio integration
    async function startConsultation() {
      // --- Double-check payment status ---
      if (!activeConsultation || activeConsultation.paymentStatus !== 'completed') {
        showNotification('warning', 'Payment Required', 'Please complete payment to start the consultation.');
        if (activeConsultation) {
          openPaymentModal(activeConsultation.id);
        }
        return;
      }
      // --- END ---
    
      const consultationInterface = document.getElementById('consultationInterface');
      consultationInterface.classList.remove('hidden');
      consultationInterface.classList.add('open');
      document.body.style.overflow = 'hidden';
      document.getElementById('activeDoctorName').textContent = activeConsultation.doctor.name;
    
      // Load chat messages
      const chatContainer = document.getElementById('chatMessages');
      if (chatMessages[activeConsultation.consultationId]) {
        const messagesHtml = chatMessages[activeConsultation.consultationId].map(msg => `
          <div style="margin-bottom:12px;display:flex;flex-direction:${msg.sender === 'patient' ? 'row-reverse' : 'row'}">
            <div style="max-width:70%;background:${msg.sender === 'patient' ? '#e3f2fd' : '#f5f5f5'};padding:8px 12px;border-radius:12px">
              <div style="font-weight:600;margin-bottom:4px">${msg.name}</div>
              <div>${msg.message}</div>
              <div class="small muted" style="text-align:right">${msg.time}</div>
            </div>
          </div>
        `).join('');
        chatContainer.innerHTML = messagesHtml;
        chatContainer.scrollTop = chatContainer.scrollHeight;
      }
    
      // Start call timer
      callSeconds = 0;
      if (callTimerInterval) clearInterval(callTimerInterval);
      callTimerInterval = setInterval(updateCallTimer, 1000);
    
      // Initialize Twilio Video connection
      await connectToTwilioRoom();
      
      // Start polling for updates
      startPollingForUpdates(activeConsultation.consultationId);
      
      // Simulate doctor joining and sending a welcome message after 3 seconds
      setTimeout(() => {
        const newMessage = {
          id: chatMessages[activeConsultation.consultationId].length + 1,
          sender: 'doctor',
          name: activeConsultation.doctor.name,
          message: 'Thank you for joining. I can see and hear you clearly. How can I help you today?',
          time: 'Now'
        };
        chatMessages[activeConsultation.consultationId].push(newMessage);
        const messageHtml = `
          <div style="margin-bottom:12px;display:flex;">
            <div style="max-width:70%;background:#f5f5f5;padding:8px 12px;border-radius:12px">
              <div style="font-weight:600;margin-bottom:4px">${newMessage.name}</div>
              <div>${newMessage.message}</div>
              <div class="small muted" style="text-align:right">${newMessage.time}</div>
            </div>
          </div>
        `;
        chatContainer.innerHTML += messageHtml;
        chatContainer.scrollTop = chatContainer.scrollHeight;
      }, 3000);
    }
    
    // Connect to Twilio Video room
    async function connectToTwilioRoom() {
      try {
        // Get real Twilio token from backend
        const consultationId = activeConsultation.consultationId || activeConsultation.id;
        twilioToken = await getTwilioToken(consultationId);
        
        // Connect to the Twilio room
        const roomName = `consultation-${consultationId}`;
        
        // Create local tracks
        twilioLocalTracks = await Twilio.Video.createLocalTracks({
          audio: true,
          video: { width: 640, height: 480 }
        });
        
        // Connect to the room
        twilioRoom = await Twilio.Video.connect(twilioToken, {
          name: roomName,
          tracks: twilioLocalTracks
        });
        
        // Attach local tracks to the DOM
        const localVideo = document.getElementById('localVideo');
        if (localVideo) {
          twilioLocalTracks.forEach(track => {
            if (track.kind === 'video') {
              localVideo.appendChild(track.attach());
            }
          });
        }
        
        // Handle participant connection
        twilioRoom.on('participantConnected', participant => {
          showNotification('success', 'Connected', `Dr. ${activeConsultation.doctor.name} has joined the consultation`);
          
          participant.on('trackSubscribed', track => {
            const remoteVideo = document.getElementById('remoteVideo');
            if (remoteVideo) {
              remoteVideo.appendChild(track.attach());
            }
          });
        });
        
        // Handle participant disconnection
        twilioRoom.on('participantDisconnected', participant => {
          showNotification('info', 'Disconnected', `Dr. ${activeConsultation.doctor.name} has left the consultation`);
        });
        
        showNotification('success', 'Connection', 'Connected to video consultation room');
        
      } catch (error) {
        console.error('Error connecting to Twilio room:', error);
        showNotification('error', 'Connection', 'Failed to connect to video consultation. Please check your camera and microphone permissions.');
      }
    }
    
    // Get Twilio token from backend
    async function getTwilioToken(consultationId) {
      try {
        const response = await apiRequest(`/api/consultations/${consultationId}/join`, {
          method: 'POST'
        });
        
        return response.token;
      } catch (error) {
        console.error('Error getting Twilio token:', error);
        showNotification('error', 'Authentication', 'Failed to authenticate for video consultation');
        throw error;
      }
    }
    
    // Update call timer
    function updateCallTimer() {
      callSeconds++;
      const minutes = Math.floor(callSeconds / 60);
      const seconds = callSeconds % 60;
      document.getElementById('callTimer').textContent = 
        `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }
    
    // Toggle audio with Twilio
    function toggleAudio() {
      if (twilioLocalTracks) {
        const audioTrack = twilioLocalTracks.find(track => track.kind === 'audio');
        if (audioTrack) {
          audioTrack.enable(!audioTrack.isEnabled);
          isAudioMuted = !audioTrack.isEnabled;
          document.getElementById('audioBtn').textContent = isAudioMuted ? 'üîä' : 'üîá';
          showNotification('info', 'Audio', isAudioMuted ? 'Audio muted' : 'Audio enabled');
        }
      }
    }
    
    // Toggle video with Twilio
    function toggleVideo() {
      if (twilioLocalTracks) {
        const videoTrack = twilioLocalTracks.find(track => track.kind === 'video');
        if (videoTrack) {
          videoTrack.enable(!videoTrack.isEnabled);
          isVideoOff = !videoTrack.isEnabled;
          document.getElementById('videoBtn').textContent = isVideoOff ? 'üì∑' : 'üìπ';
          showNotification('info', 'Video', isVideoOff ? 'Video stopped' : 'Video enabled');
        }
      }
    }
    
    // Enhanced endConsultation function with Twilio cleanup
    async function endConsultation() {
      if (callTimerInterval) clearInterval(callTimerInterval);
      
      // Stop polling
      stopPollingForUpdates();
      
      // Disconnect from Twilio room
      if (twilioRoom) {
        twilioRoom.disconnect();
        twilioRoom = null;
      }
      
      // Stop local tracks
      if (twilioLocalTracks) {
        twilioLocalTracks.forEach(track => track.stop());
        twilioLocalTracks = null;
      }
      
      // Call backend to end consultation
      if (activeConsultation) {
        try {
          await apiRequest(`/api/consultations/${activeConsultation.consultationId}/end`, {
            method: 'POST'
          });
          
          // Update consultation status locally
          activeConsultation.status = 'completed';
          
          showNotification('success', 'Consultation', 'Consultation ended successfully');
        } catch (error) {
          console.error('Error ending consultation:', error);
          showNotification('error', 'Error', 'Failed to end consultation properly');
        }
        
        activeConsultation = null;
      }
      
      // Close consultation interface
      const consultationInterface = document.getElementById('consultationInterface');
      consultationInterface.classList.add('hidden');
      consultationInterface.classList.remove('open');
      document.body.style.overflow = '';
      
      // Refresh UI
      checkActiveConsultation();
      renderAlerts();
      updateAlertCounts();
      
      cleanupResources();
    }
    
    // Send message in chat
    async function sendMessage() {
      const input = document.getElementById('chatInput');
      const message = input.value.trim();
      
      if (message) {
        // Send message to backend
        try {
          await apiRequest(`/api/consultations/${activeConsultation.consultationId}/chat`, {
            method: 'POST',
            body: JSON.stringify({ message })
          });
          
          // Add message to local chat
          const newMessage = {
            id: chatMessages[activeConsultation.consultationId].length + 1,
            sender: 'patient',
            name: 'Gurpreet Kaur',
            message: message,
            time: 'Now'
          };
          
          chatMessages[activeConsultation.consultationId].push(newMessage);
          
          const chatContainer = document.getElementById('chatMessages');
          const messageHtml = `
            <div style="margin-bottom:12px;display:flex;flex-direction:row-reverse">
              <div style="max-width:70%;background:#e3f2fd;padding:8px 12px;border-radius:12px">
                <div style="font-weight:600;margin-bottom:4px">${newMessage.name}</div>
                <div>${newMessage.message}</div>
                <div class="small muted" style="text-align:right">${newMessage.time}</div>
              </div>
            </div>
          `;
          
          chatContainer.innerHTML += messageHtml;
          chatContainer.scrollTop = chatContainer.scrollHeight;
          
          // Clear input
          input.value = '';
          
          // Show typing indicator
          showTypingIndicator();
          
        } catch (error) {
          console.error('Error sending message:', error);
          showNotification('error', 'Chat', 'Failed to send message');
        }
      }
    }
    
    // Handle chat input key press
    function handleChatKeyPress(event) {
      if (event.key === 'Enter') {
        sendMessage();
      }
    }
    
    // Show typing indicator
    function showTypingIndicator() {
      const chatContainer = document.getElementById('chatMessages');
      const typingHtml = `
        <div id="typingIndicator" style="margin-bottom:12px;display:flex;">
          <div class="chat-typing-indicator">
            <div class="chat-typing-dot"></div>
            <div class="chat-typing-dot"></div>
            <div class="chat-typing-dot"></div>
            <span style="margin-left:8px;">Dr. ${activeConsultation.doctor.name.split(' ')[1]} is typing...</span>
          </div>
        </div>
      `;
      
      chatContainer.innerHTML += typingHtml;
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }
    
    // Hide typing indicator
    function hideTypingIndicator() {
      const typingIndicator = document.getElementById('typingIndicator');
      if (typingIndicator) {
        typingIndicator.remove();
      }
    }
    
    // Enhanced startVideoCall function
    function startVideoCall() {
      if (!activeConsultation || activeConsultation.paymentStatus !== 'completed') {
        showNotification('warning', 'Payment Required', 'Please complete payment to start the video call.');
        if (activeConsultation) {
          openPaymentModal(activeConsultation.id);
        }
        return;
      }
      
      // Enter the video room
      enterVideoRoom();
    }
    
    // Enhanced startChat function
    function startChat() {
      if (!activeConsultation || activeConsultation.paymentStatus !== 'completed') {
        showNotification('warning', 'Payment Required', 'Please complete payment to start the chat.');
        if (activeConsultation) {
          openPaymentModal(activeConsultation.id);
        }
        return;
      }
      
      showNotification('info', 'Chat', 'Chat interface opened');
      // In a real app, this would open the chat interface
    }
    
    // Enhanced requestCall function
    function requestCall() {
      if (!activeConsultation || activeConsultation.paymentStatus !== 'completed') {
        showNotification('warning', 'Payment Required', 'Please complete payment to start the voice call.');
        if (activeConsultation) {
          openPaymentModal(activeConsultation.id);
        }
        return;
      }
      
      showNotification('info', 'Call', 'Voice call requested');
      // In a real app, this would initiate a voice call
    }
    
    // Enhanced viewPrescription function
    function viewPrescription() {
      if (!activeConsultation || activeConsultation.paymentStatus !== 'completed') {
        showNotification('warning', 'Payment Required', 'Please complete payment to view the prescription.');
        if (activeConsultation) {
          openPaymentModal(activeConsultation.id);
        }
        return;
      }
      
      showNotification('info', 'Prescription', 'Opening prescription');
      // In a real app, this would show the prescription
    }
    
    // Enhanced rescheduleConsultation function
    // Updated reschedule function - only works for active consultations
function rescheduleConsultation(alertId) {
  const alert = alertsData.consultation.find(a => a.id === alertId);
  if (!alert) {
    showNotification('warning', 'Error', 'No active consultation to reschedule.');
    return;
  }
  
  // Only allow rescheduling for active consultations (after payment)
  if (alert.status !== 'active') {
    showNotification('warning', 'Cannot Reschedule', 'Rescheduling is only available for active consultations after payment.');
    return;
  }
  
  // Show reschedule modal for active consultation
  showRescheduleModal(alert);
}
    
    // Dismiss alert
    function dismissAlert(alertId) {
      // Find alert in any category and mark as dismissed
      let alert = alertsData.refill.find(a => a.id === alertId);
      if (alert) {
        alert.status = 'dismissed';
      } else {
        alert = alertsData.followup.find(a => a.id === alertId);
        if (alert) alert.status = 'dismissed';
        else {
          alert = alertsData.consultation.find(a => a.id === alertId);
          if (alert) alert.status = 'dismissed';
        }
      }
      
      showNotification('success', 'Dismissed', 'Alert dismissed');
      renderAlerts();
      updateAlertCounts();
    }
    
    // View consultation details
    function viewConsultation(alertId) {
      const alert = alertsData.consultation.find(a => a.id === alertId);
      
      if (alert) {
        const modal = document.getElementById('recordDetailModal');
        const content = document.getElementById('recordDetailContent');
        const title = document.getElementById('recordModalTitle');
        
        title.textContent = 'Consultation Details';
        
        content.innerHTML = `
          <div style="margin-bottom:20px">
            <div style="display:flex;gap:16px;align-items:center">
              <div style="width:60px;height:60px;border-radius:10px;background:#eaf7f0;display:grid;place-items:center;font-weight:800;color:var(--brand);font-size:1.2rem">
                ${alert.doctor.name.split(' ').map(n => n[0]).join('').substring(0, 2)}
              </div>
              <div>
                <div style="font-weight:800">${alert.doctor.name}</div>
                <div class="small muted">${alert.doctor.specialization} ‚Ä¢ ${alert.doctor.id}</div>
                <div class="small">Rating: ${alert.doctor.rating}/5</div>
              </div>
            </div>
          </div>
          
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px">
            <div>
              <div style="font-weight:700;margin-bottom:4px">Date & Time</div>
              <div class="small">${formatDate(alert.date)} at ${alert.time}</div>
            </div>
            <div>
              <div style="font-weight:700;margin-bottom:4px">Duration</div>
              <div class="small">${alert.duration} minutes</div>
            </div>
            <div>
              <div style="font-weight:700;margin-bottom:4px">Purpose</div>
              <div class="small">${alert.purpose}</div>
            </div>
            <div>
              <div style="font-weight:700;margin-bottom:4px">Fee</div>
              <div class="small">‚Çπ${alert.doctor.fee}</div>
            </div>
          </div>
          
          <div style="margin-bottom:20px">
            <div style="font-weight:700;margin-bottom:4px">Symptoms</div>
            <div class="small">${alert.symptoms.join(', ')}</div>
          </div>
          
          <div style="margin-bottom:20px">
            <div style="font-weight:700;margin-bottom:4px">Status</div>
            <div class="status">${alert.status} ‚Ä¢ ${alert.paymentStatus}</div>
          </div>
          
          <div style="display:flex;gap:8px">
            <button class="btn" onclick="joinConsultation()">Join Consultation</button>
            <button class="btn ghost" onclick="rescheduleConsultation()">Reschedule</button>
            <button class="btn ghost" onclick="closeRecordModal()">Close</button>
          </div>
        `;
        
        modal.classList.add('open');
        document.body.style.overflow = 'hidden';
      }
    }
    
    // Close record modal
    function closeRecordModal() {
      const modal = document.getElementById('recordDetailModal');
      if (modal) {
        modal.classList.remove('open');
        document.body.style.overflow = '';
      }
    }
    
    // Close modals when clicking outside
    document.getElementById('paymentModal').addEventListener('click', (e) => {
      if (e.target === document.getElementById('paymentModal')) {
        closePaymentModal();
      }
    });
    
    document.getElementById('paymentSuccessModal').addEventListener('click', (e) => {
      if (e.target === document.getElementById('paymentSuccessModal')) {
        closePaymentSuccessModal();
      }
    });
    
    document.getElementById('consultationInterface').addEventListener('click', (e) => {
      if (e.target === document.getElementById('consultationInterface')) {
        // Don't close on outside click for consultation interface
      }
    });
    
    document.getElementById('recordDetailModal').addEventListener('click', (e) => {
      if (e.target === document.getElementById('recordDetailModal')) {
        closeRecordModal();
      }
    });
    
    // Format date as "Sep 5, 2025"
    function formatDate(dateString) {
      const options = { year: 'numeric', month: 'short', day: 'numeric' };
      return new Date(dateString).toLocaleDateString(undefined, options);
    }
    
    /* ---------- Digital Records Functions ---------- */
    
    // Initialize records section
    function initRecords() {
      renderRecords();
      // Check if offline access is supported
      if ('serviceWorker' in navigator && 'caches' in window) {
        enableOfflineAccess();
      }
    }
    
    // Render records based on filters
    function renderRecords() {
      const searchTerm = document.getElementById('recordsSearch').value.toLowerCase();
      const typeFilter = document.getElementById('recordTypeFilter').value;
      const dateOrder = document.getElementById('dateFilter').value;
      
      let filteredRecords = medicalRecords.filter(record => {
        // Type filter
        if (typeFilter !== 'all' && record.type !== typeFilter) return false;
        
        // Search filter
        if (searchTerm && !(
          record.title.toLowerCase().includes(searchTerm) ||
          record.doctor.name.toLowerCase().includes(searchTerm) ||
          (record.lab && record.lab.toLowerCase().includes(searchTerm)) ||
          (record.medications && record.medications.some(m => m.name.toLowerCase().includes(searchTerm))) ||
          (record.tests && record.tests.some(t => t.name.toLowerCase().includes(searchTerm)))
        )) return false;
        
        return true;
      });
      
      // Date ordering
      filteredRecords.sort((a, b) => {
        return dateOrder === 'newest' ? 
          new Date(b.date) - new Date(a.date) : 
          new Date(a.date) - new Date(b.date);
      });
      
      const recordsList = document.getElementById('recordsList');
      const noRecords = document.getElementById('noRecords');
      const recordsCount = document.getElementById('recordsCount');
      
      recordsList.innerHTML = '';
      recordsCount.textContent = `${filteredRecords.length} records found`;
      
      if (filteredRecords.length === 0) {
        noRecords.style.display = 'block';
        return;
      }
      
      noRecords.style.display = 'none';
      
      filteredRecords.forEach(record => {
        const recordEl = document.createElement('div');
        recordEl.className = 'record-item';
        recordEl.onclick = () => openRecordDetail(record.id);
        
        // Determine icon based on record type
        let icon = 'üìÑ';
        if (record.type === 'prescription') icon = 'üíä';
        else if (record.type === 'lab') icon = 'üß™';
        else if (record.type === 'imaging') icon = 'üñºÔ∏è';
        
        recordEl.innerHTML = `
          <div class="record-icon">
            ${icon}
          </div>
          <div class="record-content">
            <div class="record-title">${record.title}</div>
            <div class="record-details">${formatDate(record.date)} ‚Ä¢ ${record.doctor.name} (${record.doctor.specialization})</div>
            ${record.lab ? `<div class="record-details">${record.lab}</div>` : ''}
          </div>
          <div class="record-actions">
            <div class="record-file-size">${record.fileSize}</div>
            <div class="actions">
              <button class="btn ghost" onclick="event.stopPropagation();downloadRecord('${record.id}')">Download</button>
              <button class="btn" onclick="event.stopPropagation();openRecordDetail('${record.id}')">View</button>
            </div>
          </div>
        `;
        
        recordsList.appendChild(recordEl);
      });
    }
    
    // Filter records based on search and filter criteria
    function filterRecords() {
      renderRecords();
    }
    
    // Open record detail modal
    function openRecordDetail(recordId) {
      const record = medicalRecords.find(r => r.id === recordId);
      if (!record) return;
      
      const modal = document.getElementById('recordDetailModal');
      const content = document.getElementById('recordDetailContent');
      const title = document.getElementById('recordModalTitle');
      
      title.textContent = record.title;
      
      let detailsHtml = `
        <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:20px">
          <div>
            <div style="font-weight:700;margin-bottom:4px">Date</div>
            <div class="small">${formatDate(record.date)}</div>
          </div>
          <div>
            <div style="font-weight:700;margin-bottom:4px">Doctor</div>
            <div class="small">${record.doctor.name} (${record.doctor.specialization})</div>
            <div class="small">ID: ${record.doctor.id}</div>
          </div>
        </div>
      `;
      
      if (record.lab) {
        detailsHtml += `
          <div style="margin-bottom:20px">
            <div style="font-weight:700;margin-bottom:4px">Laboratory</div>
            <div class="small">${record.lab}</div>
          </div>
        `;
      }
      
      if (record.medications && record.medications.length > 0) {
        detailsHtml += `
          <div style="margin-bottom:20px">
            <div style="font-weight:700;margin-bottom:8px">Medications</div>
            <div style="background:#f8faf9;border-radius:8px;padding:12px">
              ${record.medications.map(med => `
                <div class="medication-item">
                  <div>
                    <div class="medication-name">${med.name} ${med.dosage}</div>
                    <div class="medication-dosage">${med.frequency} ${med.duration ? 'for ' + med.duration : ''}</div>
                  </div>
                </div>
              `).join('')}
            </div>
          </div>
        `;
      }
      
      if (record.instructions) {
        detailsHtml += `
          <div style="margin-bottom:20px">
            <div style="font-weight:700;margin-bottom:4px">Instructions</div>
            <div class="small">${record.instructions}</div>
          </div>
        `;
      }
      
      if (record.tests && record.tests.length > 0) {
        detailsHtml += `
          <div style="margin-bottom:20px">
            <div style="font-weight:700;margin-bottom:8px">Test Results</div>
            <div style="background:#f8faf9;border-radius:8px;padding:12px">
              ${record.tests.map(test => `
                <div class="test-result">
                  <div class="test-name">${test.name}</div>
                  <div class="test-value">
                    <div>${test.result}</div>
                    <div class="test-status ${test.status}">${test.status === 'normal' ? 'Normal' : test.status === 'abnormal' ? 'Abnormal' : 'Borderline'}</div>
                  </div>
                  <div class="test-range">Normal range: ${test.normalRange}</div>
                </div>
              `).join('')}
            </div>
          </div>
        `;
      }
      
      if (record.findings) {
        detailsHtml += `
          <div style="margin-bottom:20px">
            <div style="font-weight:700;margin-bottom:4px">Findings</div>
            <div class="small">${record.findings}</div>
          </div>
        `;
      }
      
      if (record.impression) {
        detailsHtml += `
          <div style="margin-bottom:20px">
            <div style="font-weight:700;margin-bottom:4px">Impression</div>
            <div class="small">${record.impression}</div>
          </div>
        `;
      }
      
      if (record.summary) {
        detailsHtml += `
          <div style="margin-bottom:20px">
            <div style="font-weight:700;margin-bottom:4px">Summary</div>
            <div class="small">${record.summary}</div>
          </div>
        `;
      }
      
      if (record.notes) {
        detailsHtml += `
          <div style="margin-bottom:20px">
            <div style="font-weight:700;margin-bottom:4px">Notes</div>
            <div class="small">${record.notes}</div>
          </div>
        `;
      }
      
      if (record.recommendations) {
        detailsHtml += `
          <div style="margin-bottom:20px">
            <div style="font-weight:700;margin-bottom:4px">Recommendations</div>
            <div class="small">${record.recommendations}</div>
          </div>
        `;
      }
      
      detailsHtml += `
        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:20px;padding-top:20px;border-top:1px solid #eef6f2">
          <div class="small muted">File size: ${record.fileSize}</div>
          <div>
            <button class="btn ghost" onclick="downloadRecord('${record.id}')">Download</button>
            <button class="btn" onclick="closeRecordModal()">Close</button>
          </div>
        </div>
      `;
      
      content.innerHTML = detailsHtml;
      modal.classList.add('open');
      document.body.style.overflow = 'hidden';
    }
    
    // Download individual record
    function downloadRecord(recordId) {
      const record = medicalRecords.find(r => r.id === recordId);
      if (!record) return;
      
      showNotification('info', 'Download', `Downloading ${record.title}...`);
      
      // Create a download progress indicator
      const downloadProgress = document.createElement('div');
      downloadProgress.className = 'download-progress';
      downloadProgress.innerHTML = '<div class="download-progress-bar"></div>';
      
      // In a real application, this would trigger the actual file download
      // For demo purposes, we'll simulate it with progress
      const progressBar = downloadProgress.querySelector('.download-progress-bar');
      let progress = 0;
      
      const progressInterval = setInterval(() => {
        progress += 10;
        progressBar.style.width = `${progress}%`;
        
        if (progress >= 100) {
          clearInterval(progressInterval);
          setTimeout(() => {
            showNotification('success', 'Download', `${record.title} downloaded successfully`);
          }, 500);
        }
      }, 200);
      
      // Simulate download
      const a = document.createElement('a');
      a.href = record.fileUrl;
      a.download = `${record.title.replace(/\s+/g, '_')}_${record.date}.pdf`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }
    
    // Enable offline access for medical records
    function enableOfflineAccess() {
      // In a real application, this would register a service worker
      // and cache medical records for offline access
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/sw.js').then(registration => {
          console.log('ServiceWorker registration successful with scope: ', registration.scope);
        }).catch(error => {
          console.log('ServiceWorker registration failed: ', error);
        });
      }
      
      // Cache medical records for offline access
      if ('caches' in window) {
        caches.open('medical-records-v1').then(cache => {
          // In a real app, we would cache the actual record files
          // For demo purposes, we'll just log the action
          console.log('Caching medical records for offline access');
        });
      }
    }
    
    // Toggle sidebar visibility on mobile
    function toggleSide() {
      const side = document.querySelector('.side');
      side.classList.toggle('mobile-open');
    }
    
    // Download all records as ZIP
    function downloadAllRecords() {
      showNotification('info', 'Download', 'Preparing all records for download...');
      
      // Simulate preparing a ZIP file with all records
      setTimeout(() => {
        // Create a temporary link element to trigger download
        const link = document.createElement('a');
        
        // In a real application, this would be a real ZIP file URL
        // For demo purposes, we'll use a placeholder
        link.href = '#';
        link.download = 'NabhaCare_Medical_Records_' + new Date().toISOString().split('T')[0] + '.zip';
        
        // Simulate download progress
        let progress = 0;
        const progressInterval = setInterval(() => {
          progress += 10;
          if (progress >= 100) {
            clearInterval(progressInterval);
            showNotification('success', 'Download', 'All records have been downloaded successfully');
          }
        }, 200);
        
        // In a real app with JSZip library:
        /*
        const zip = new JSZip();
        
        // Add each record to the ZIP
        medicalRecords.forEach(record => {
          // In a real app, we would fetch and add the actual file content
          // For demo purposes, we'll add a placeholder
          zip.file(record.title.replace(/\s+/g, '_') + '.pdf', 'Placeholder content for ' + record.title);
        });
        
        // Generate the ZIP file
        zip.generateAsync({type: 'blob'}).then(content => {
          // Create a download link
          const url = URL.createObjectURL(content);
          link.href = url;
          link.click();
          
          // Clean up
          setTimeout(() => {
            URL.revokeObjectURL(url);
          }, 100);
          
          showNotification('success', 'Download', 'All records have been downloaded successfully');
        });
        */
        
        showNotification('success', 'Download', 'All records have been packaged and download started');
      }, 2000);
    }
    
    // Add CSS for mobile sidebar toggle
    const style = document.createElement('style');
    style.textContent = `
      .side.mobile-open {
        transform: translateX(0);
      }
      
      @media (max-width:720px) {
        .side {
          transform: translateX(-100%);
          transition: transform 0.3s ease;
        }
      }
    `;
    document.head.appendChild(style);
    
    // Initialize the app when DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
      // Initialize with the alerts tab active
      initAlerts();
      
      // --- NEW: Load saved profile data ---
      loadProfileData();
      updateUpcomingAppointmentInProfile();
      // --- END NEW ---
    
      // Add keyboard navigation
      document.addEventListener('keydown', function(e) {
        // ESC key to close modals
        if (e.key === 'Escape') {
          // Close any open modals
          const openModals = document.querySelectorAll('.family-member-panel.open, .connect-modal.open');
          openModals.forEach(modal => {
            modal.classList.remove('open');
            document.body.style.overflow = '';
          });

            // Listen for appointment acceptance
  window.addEventListener('storage', function(event) {
    if (event.key === 'appointmentAccepted') {
      const data = JSON.parse(event.newValue);
      handleAppointmentAcceptance(data);
    }
  });
          // Close drawer if open
          const drawer = document.getElementById('docDrawer');
          if (drawer.classList.contains('open')) {
            closeDrawer();
          }
        }
      });  
      // Add touch swipe support for mobile
      let touchStartX = 0;
      let touchEndX = 0;
      
      document.addEventListener('touchstart', function(e) {
        touchStartX = e.changedTouches[0].screenX;
      });
      
      document.addEventListener('touchend', function(e) {
        touchEndX = e.changedTouches[0].screenX;
        handleSwipe();
      });
      
      function handleSwipe() {
        // Swipe right to open sidebar on mobile
        if (touchEndX > touchStartX + 50 && window.innerWidth <= 720) {
          document.querySelector('.side').classList.add('mobile-open');
        }
        // Swipe left to close sidebar on mobile
        if (touchEndX < touchStartX - 50 && window.innerWidth <= 720) {
          document.querySelector('.side').classList.remove('mobile-open');
        }
      }
    });
    
    // Add a function to check for app updates
    function checkForUpdates() {
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.ready.then(registration => {
          registration.update().then(() => {
            console.log('Service worker updated');
          });
        });
      }
    }
    
    // Check for updates every hour
    setInterval(checkForUpdates, 3600000);
    
    // Add a function to handle network status changes
    function handleNetworkStatus() {
      const statusIndicator = document.createElement('div');
      statusIndicator.id = 'network-status';
      statusIndicator.style.position = 'fixed';
      statusIndicator.style.bottom = '10px';
      statusIndicator.style.right = '10px';
      statusIndicator.style.padding = '5px 10px';
      statusIndicator.style.borderRadius = '5px';
      statusIndicator.style.fontSize = '12px';
      statusIndicator.style.zIndex = '9999';
      statusIndicator.style.display = 'none';
      document.body.appendChild(statusIndicator);
      
      window.addEventListener('online', function() {
        statusIndicator.textContent = 'Back online';
        statusIndicator.style.backgroundColor = '#4CAF50';
        statusIndicator.style.color = 'white';
        statusIndicator.style.display = 'block';
        
        setTimeout(() => {
          statusIndicator.style.display = 'none';
        }, 3000);
      });
      
      window.addEventListener('offline', function() {
        statusIndicator.textContent = 'Offline mode';
        statusIndicator.style.backgroundColor = '#F44336';
        statusIndicator.style.color = 'white';
        statusIndicator.style.display = 'block';
      });
    }
    
    // Initialize network status handler
    handleNetworkStatus();
    
    // Add a function to sync data when back online
    function syncData() {
      window.addEventListener('online', function() {
        // In a real app, this would sync any data created while offline
        showNotification('info', 'Sync', 'Syncing data with server...');
        
        // Simulate sync process
        setTimeout(() => {
          showNotification('success', 'Sync', 'Data synced successfully');
        }, 2000);
      });
    }
    
    // Initialize data sync
    syncData();
    
    // Add a function to export patient data
    function exportPatientData() {
      showNotification('info', 'Export', 'Preparing your data for export...');
      
      // In a real app, this would collect all patient data and format it
      // For demo purposes, we'll simulate the process
      setTimeout(() => {
        const patientData = {
          profile: {
            name: document.getElementById('profile-name-display').textContent,
            details: document.getElementById('profile-details-display').textContent,
            medicalHistory: document.getElementById('medical-history-display').textContent
          },
          alerts: alertsData,
          records: medicalRecords
        };
        
        // Create a download link for the JSON data
        const dataStr = JSON.stringify(patientData, null, 2);
        const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
        
        const exportFileDefaultName = 'NabhaCare_Patient_Data_' + new Date().toISOString().split('T')[0] + '.json';
        
        const linkElement = document.createElement('a');
        linkElement.setAttribute('href', dataUri);
        linkElement.setAttribute('download', exportFileDefaultName);
        linkElement.click();
        
        showNotification('success', 'Export', 'Your data has been exported successfully');
      }, 1500);
    }
    
    // Add export button to profile section, placing it before the Edit Profile button
    const editProfileBtn = document.getElementById('editProfileBtn');
    const exportButton = document.createElement('button');
    exportButton.className = 'btn ghost';
    exportButton.textContent = 'Export Data';
    exportButton.style.marginRight = '8px'; // Add a small gap between Export and Edit
    exportButton.onclick = exportPatientData;
    if (editProfileBtn) {
        editProfileBtn.parentNode.insertBefore(exportButton, editProfileBtn);
    }
    // Add a function to handle appointment reminders
    function setupAppointmentReminders() {
      // In a real app, this would set up notifications for upcoming appointments
      // For demo purposes, we'll just log the action
      console.log('Setting up appointment reminders');
      
      // Check for appointments in the next 24 hours
      const tomorrow = new Date();
      tomorrow.setDate(tomorrow.getDate() + 1);
      
      alertsData.consultation.forEach(consultation => {
        const appointmentDate = new Date(consultation.date);
        if (appointmentDate <= tomorrow && consultation.status === 'scheduled') {
          // Show reminder notification
          showNotification('info', 'Reminder', `You have an appointment with ${consultation.doctor.name} tomorrow at ${consultation.time}`);
        }
      });
    }
    
    // Set up appointment reminders
    setupAppointmentReminders();
    
    // Add a function to handle medication reminders
    function setupMedicationReminders() {
      // In a real app, this would set up notifications for medication refills
      // For demo purposes, we'll just log the action
      console.log('Setting up medication reminders');
      
      // Check for medications that need refills soon
      alertsData.refill.forEach(refill => {
        if (refill.status === 'pending' && refill.urgency === 'high') {
          // Show reminder notification
          showNotification('warning', 'Medication Reminder', `Your ${refill.medicine} is running low. ${refill.remaining}`);
        }
      });
    }
    
    // Set up medication reminders
    setupMedicationReminders();
    
    // Add a function to handle dark mode toggle
    function setupDarkMode() {
      // Create dark mode toggle button
      const darkModeToggle = document.createElement('button');
      darkModeToggle.className = 'btn ghost';
      darkModeToggle.textContent = 'üåô';
      darkModeToggle.style.marginLeft = '10px';
      darkModeToggle.title = 'Toggle dark mode';
      darkModeToggle.onclick = toggleDarkMode;
      
      // Add to navigation
      const navRight = document.querySelector('.nav-right');
      navRight.appendChild(darkModeToggle);
      
      // Check for saved dark mode preference
      const isDarkMode = localStorage.getItem('darkMode') === 'true';
      if (isDarkMode) {
        document.body.classList.add('dark-mode');
        darkModeToggle.textContent = '‚òÄÔ∏è';
      }
    }
    
    // Toggle dark mode
    function toggleDarkMode() {
      document.body.classList.toggle('dark-mode');
      const isDarkMode = document.body.classList.contains('dark-mode');
      localStorage.setItem('darkMode', isDarkMode);
      
      // Update toggle button text
      const darkModeToggle = document.querySelector('.nav-right .btn.ghost:last-child');
      darkModeToggle.textContent = isDarkMode ? '‚òÄÔ∏è' : 'üåô';
    }
    
    // Set up dark mode
    setupDarkMode();
    
    // Add dark mode CSS
    const darkModeStyle = document.createElement('style');
    darkModeStyle.textContent = `
      body.dark-mode {
        background-color: #1a1a1a;
        color: #e0e0e0;
        
      }
      
      body.dark-mode .card {
        background-color: #2d2d2d;
        color: #e0e0e0;
      }
      
      body.dark-mode .nav {
        background: linear-gradient(90deg, #1a4d3a, #2a6d5a);
      }
      
      body.dark-mode .side {
        background: linear-gradient(180deg, #2d2d2dcc, #2d2d2d);
      }
      
      body.dark-mode .input {
        background-color: #3d3d3d;
        border-color: #4d4d4d;
        color: #e0e0e0;
      }
      
      body.dark-mode .btn {
        background-color: #2a6d5a;
        color: white;
      }
      
      body.dark-mode .btn.ghost {
        background-color: #3d3d3d;
        color: #2a6d5a;
        border-color: #4d4d4d;
      }
      
      body.dark-mode .navitem {
        color: #e0e0e0;
      }
      
      body.dark-mode .navitem:hover {
        background: #2d4d3d;
      }
      
      body.dark-mode .navitem.active {
        background: linear-gradient(90deg, #2d4d3d, #3d5d4d);
      }
      
      body.dark-mode .muted {
        color: #a0a0a0;
      }
      
      body.dark-mode .family-member-content,
      body.dark-mode .connect-content {
        background-color: #2d2d2d;
        color: #e0e0e0;
      }
      
      body.dark-mode .record-detail-content {
        background-color: #2d2d2d;
        color: #e0e0e0;
      }
    `;
    document.head.appendChild(darkModeStyle);
    
    // Add a function to handle accessibility improvements
    function improveAccessibility() {
      // Add aria-labels to interactive elements that don't have them
      document.querySelectorAll('button:not([aria-label])').forEach(button => {
        if (!button.getAttribute('aria-label') && button.textContent.trim()) {
          button.setAttribute('aria-label', button.textContent.trim());
        }
      });
      
      // Add skip to content link for keyboard users
      const skipLink = document.createElement('a');
      skipLink.href = '#main';
      skipLink.textContent = 'Skip to main content';
      skipLink.className = 'skip-link';
      skipLink.style.position = 'absolute';
      skipLink.style.top = '-40px';
      skipLink.style.left = '0';
      skipLink.style.background = '#2c6d52';
      skipLink.style.color = 'white';
      skipLink.style.padding = '8px';
      skipLink.style.zIndex = '100';
      skipLink.style.textDecoration = 'none';
      
      skipLink.addEventListener('focus', function() {
        skipLink.style.top = '0';
      });
      
      skipLink.addEventListener('blur', function() {
        skipLink.style.top = '-40px';
      });
      
      document.body.insertBefore(skipLink, document.body.firstChild);
    }
    
    // Improve accessibility
    improveAccessibility();
    
    // Add a function to handle print functionality
    function setupPrintFunctionality() {
      // Add print buttons to record detail views
      const recordDetailModal = document.getElementById('recordDetailModal');
      
      const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
          if (mutation.attributeName === 'class' && recordDetailModal.classList.contains('open')) {
            // Add print button if it doesn't exist
            if (!recordDetailModal.querySelector('.print-button')) {
              const printButton = document.createElement('button');
              printButton.className = 'btn ghost print-button';
              printButton.textContent = 'üñ®Ô∏è Print';
              printButton.style.marginRight = '10px';
              printButton.onclick = function() {
                window.print();
              };
              
              const closeButton = recordDetailModal.querySelector('.family-member-close');
              closeButton.parentNode.insertBefore(printButton, closeButton);
            }
          }
        });
      });
      
      observer.observe(recordDetailModal, { attributes: true });
    }
    
    // Set up print functionality
    setupPrintFunctionality();
    
    // Add print-specific CSS
    const printStyle = document.createElement('style');
    printStyle.textContent = `
      @media print {
        body * {
          visibility: hidden;
        }
        
        #recordDetailModal, #recordDetailModal * {
          visibility: visible;
        }
        
        #recordDetailModal {
          position: absolute;
          left: 0;
          top: 0;
          width: 100%;
          height: 100%;
          overflow: visible;
        }
        
        .family-member-close, .btn {
          display: none;
        }
      }
    `;
    document.head.appendChild(printStyle);
    
    // Add a function to handle data persistence
    function setupDataPersistence() {
      // In a real app, this would save data to localStorage or IndexedDB
      // For demo purposes, we'll just save some basic settings
      
      // Save user preferences
      window.addEventListener('beforeunload', function() {
        const preferences = {
          darkMode: document.body.classList.contains('dark-mode'),
          lastActiveTab: document.querySelector('.navitem.active').dataset.tab,
          fontSize: document.body.style.fontSize
        };
        
        localStorage.setItem('nabhaCarePreferences', JSON.stringify(preferences));
      });
      
      // Load user preferences
      const savedPreferences = localStorage.getItem('nabhaCarePreferences');
      if (savedPreferences) {
        try {
          const preferences = JSON.parse(savedPreferences);
          
          // Apply dark mode if saved
          if (preferences.darkMode) {
            document.body.classList.add('dark-mode');
            document.querySelector('.nav-right .btn.ghost:last-child').textContent = '‚òÄÔ∏è';
          }
          
          // Apply font size if saved
          if (preferences.fontSize) {
            document.body.style.fontSize = preferences.fontSize;
          }
          
          // Switch to last active tab if saved
          if (preferences.lastActiveTab) {
            const tabNode = document.querySelector(`.navitem[data-tab="${preferences.lastActiveTab}"]`);
            if (tabNode) {
              tabNode.click();
            }
          }
        } catch (e) {
          console.error('Error loading preferences:', e);
        }
      }
    }
    
    // Set up data persistence
    setupDataPersistence();
    
    // Add a function to handle font size adjustment
    function setupFontSizeAdjustment() {
      // Create font size controls
      const fontSizeControls = document.createElement('div');
      fontSizeControls.className = 'font-size-controls';
      fontSizeControls.style.position = 'fixed';
      fontSizeControls.style.bottom = '20px';
      fontSizeControls.style.left = '20px';
      fontSizeControls.style.display = 'flex';
      fontSizeControls.style.gap = '5px';
      fontSizeControls.style.zIndex = '100';
      
      const decreaseButton = document.createElement('button');
      decreaseButton.className = 'btn ghost';
      decreaseButton.textContent = 'A-';
      decreaseButton.onclick = function() {
        adjustFontSize(-1);
      };
      
      const increaseButton = document.createElement('button');
      increaseButton.className = 'btn ghost';
      increaseButton.textContent = 'A+';
      increaseButton.onclick = function() {
        adjustFontSize(1);
      };
      
      fontSizeControls.appendChild(decreaseButton);
      fontSizeControls.appendChild(increaseButton);
      
      document.body.appendChild(fontSizeControls);
    }
    
    // Adjust font size
    function adjustFontSize(change) {
      const currentSize = parseFloat(window.getComputedStyle(document.body).fontSize);
      const newSize = currentSize + change;
      
      if (newSize >= 12 && newSize <= 20) {
        document.body.style.fontSize = newSize + 'px';
      }
    }
    
    // Set up font size adjustment
    setupFontSizeAdjustment();
    
    // Close keyboard shortcuts help
    function closeKeyboardShortcutsHelp() {
      const modal = document.getElementById('keyboard-shortcuts-modal');
      if (modal) {
        modal.remove();
        document.body.style.overflow = '';
      }
    }
    
    // Add a function to initialize tooltips
    function initializeTooltips() {
      // Find all elements with title attributes and convert them to tooltips
      const elementsWithTitles = document.querySelectorAll('[title]');
      
      elementsWithTitles.forEach(element => {
        const title = element.getAttribute('title');
        element.removeAttribute('title');
        
        element.addEventListener('mouseenter', function(e) {
          const tooltip = document.createElement('div');
          tooltip.className = 'tooltip';
          tooltip.textContent = title;
          tooltip.style.position = 'absolute';
          tooltip.style.backgroundColor = 'rgba(0, 0, 0, 0.8)';
          tooltip.style.color = 'white';
          tooltip.style.padding = '5px 10px';
          tooltip.style.borderRadius = '4px';
          tooltip.style.fontSize = '12px';
          tooltip.style.zIndex = '1000';
          tooltip.style.pointerEvents = 'none';
          
          document.body.appendChild(tooltip);
          
          // Position tooltip
          const rect = element.getBoundingClientRect();
          tooltip.style.left = rect.left + (rect.width / 2) - (tooltip.offsetWidth / 2) + 'px';
          tooltip.style.top = rect.top - tooltip.offsetHeight - 10 + 'px';
          
          // Store reference to tooltip
          element._tooltip = tooltip;
        });
        
        element.addEventListener('mouseleave', function() {
          if (element._tooltip) {
            element._tooltip.remove();
            element._tooltip = null;
          }
        });
      });
    }
    
    // Initialize tooltips
    initializeTooltips();
    
    // Add a function to handle error logging
    function setupErrorLogging() {
      window.addEventListener('error', function(e) {
        console.error('Application error:', e.error);
        
        // In a real app, this would send error reports to a server
        // For demo purposes, we'll just log to console
      });
      
      window.addEventListener('unhandledrejection', function(e) {
        console.error('Unhandled promise rejection:', e.reason);
        
        // In a real app, this would send error reports to a server
        // For demo purposes, we'll just log to console
      });
    }
    
    // Set up error logging
    setupErrorLogging();
    
    // Final initialization
    console.log('SehatSetuNabha Patient Dashboard initialized successfully');
    
    // Add event listener for payment success modal continue button
    document.addEventListener('DOMContentLoaded', function() {
      const continueButton = document.querySelector('#paymentSuccessModal .btn');
      if (continueButton) {
        continueButton.addEventListener('click', function() {
          closePaymentSuccessModal();
          if (activeConsultation && activeConsultation.id === targetConsultationId) {
            startConsultation();
          }
        });
      }
    });
    
    /* ---------- Polling Functions ---------- */
    
    // Start polling for chat messages and consultation status
    function startPollingForUpdates(consultationId) {
      // Poll for chat messages every 5 seconds
      chatPollingInterval = setInterval(async () => {
        try {
          const response = await apiRequest(`/api/consultations/${consultationId}/chat`);
          updateChatMessages(response.messages);
        } catch (error) {
          console.error('Error polling chat messages:', error);
        }
      }, 5000);
      
      // Poll for consultation status every 5 seconds
      statusPollingInterval = setInterval(async () => {
        try {
          const response = await apiRequest(`/api/consultations/${consultationId}`);
          updateConsultationStatus(response);
        } catch (error) {
          console.error('Error polling consultation status:', error);
        }
      }, 5000);
    }
    
    // Stop polling for updates
    function stopPollingForUpdates() {
      if (chatPollingInterval) {
        clearInterval(chatPollingInterval);
        chatPollingInterval = null;
      }
      
      if (statusPollingInterval) {
        clearInterval(statusPollingInterval);
        statusPollingInterval = null;
      }
    }
    
    // Update chat messages with new messages from server
    function updateChatMessages(messages) {
      if (!activeConsultation || !messages || messages.length === 0) return;
      
      const consultationId = activeConsultation.consultationId;
      const chatContainer = document.getElementById('chatMessages');
      
      // Get current message IDs to avoid duplicates
      const existingMessageIds = chatMessages[consultationId].map(msg => msg.id);
      
      // Find new messages
      const newMessages = messages.filter(msg => !existingMessageIds.includes(msg.id));
      
      if (newMessages.length > 0) {
        // Add new messages to local storage
        chatMessages[consultationId].push(...newMessages);
        
        // Render new messages
        newMessages.forEach(msg => {
          const messageHtml = `
            <div style="margin-bottom:12px;display:flex;flex-direction:${msg.sender === 'patient' ? 'row-reverse' : 'row'}">
              <div style="max-width:70%;background:${msg.sender === 'patient' ? '#e3f2fd' : '#f5f5f5'};padding:8px 12px;border-radius:12px">
                <div style="font-weight:600;margin-bottom:4px">${msg.name}</div>
                <div>${msg.message}</div>
                <div class="small muted" style="text-align:right">${msg.time}</div>
              </div>
            </div>
          `;
          
          chatContainer.innerHTML += messageHtml;
        });
        
        // Scroll to bottom
        chatContainer.scrollTop = chatContainer.scrollHeight;
        
        // Show notification for new doctor messages
        const doctorMessages = newMessages.filter(msg => msg.sender === 'doctor');
        if (doctorMessages.length > 0) {
          showNotification('info', 'New Message', `New message from ${activeConsultation.doctor.name}`);
        }
      }
    }
    
    // Update consultation status based on server response
    function updateConsultationStatus(consultationData) {
      if (!activeConsultation) return;
      
      // Update local consultation data
      Object.assign(activeConsultation, consultationData);
      
      // Update UI based on status changes
      if (consultationData.status === 'completed') {
        // Consultation was ended by doctor
        endConsultation();
      } else if (consultationData.status === 'cancelled') {
        // Consultation was cancelled
        showNotification('warning', 'Cancelled', 'Consultation was cancelled by the doctor');
        endConsultation();
      }
    }
    
    /* ---------- Resource Cleanup ---------- */
    
    // Clean up all resources when consultation ends
    function cleanupResources() {
      // Clear intervals
      if (callTimerInterval) {
        clearInterval(callTimerInterval);
        callTimerInterval = null;
      }
      
      // Stop polling
      stopPollingForUpdates();
      
      // Clear Twilio resources
      if (twilioRoom) {
        twilioRoom.disconnect();
        twilioRoom = null;
      }
      
      if (twilioLocalTracks) {
        twilioLocalTracks.forEach(track => track.stop());
        twilioLocalTracks = null;
      }
      
      // Reset variables
      twilioToken = null;
      targetConsultationId = null;
      isAudioMuted = false;
      isVideoOff = false;
      callSeconds = 0;
    }
    
    // Add event listener for doctor joining call
    window.addEventListener('storage', function(event) {
      if (event.key === 'doctorJoinedCall') {
        const joinData = JSON.parse(event.newValue);
        
        // Check if this is for the current consultation
        if (activeConsultation && activeConsultation.id === joinData.patientId) {
          showNotification('success', 'Doctor Joined', `Dr. ${activeConsultation.doctor.name} has joined the call.`);
          
          // Update UI to show call is active
          const callStatus = document.getElementById('callStatus');
          if (callStatus) {
            callStatus.textContent = 'Connected with doctor';
          }
        }
      }
      
      // Listen for consultation updates from doctor
      if (event.key === 'consultationUpdated' && event.newValue) {
        const update = JSON.parse(event.newValue);
        
        // Find the consultation
        const consultation = alertsData.consultation.find(c => c.id === update.id);
        if (consultation) {
          // Update data
          consultation.date = update.date;
          consultation.time = update.time;
          
          // Refresh UI
          renderAlerts();
          updateUpcomingAppointmentInProfile();
          
          // Notify patient
          showNotification('success', 'Appointment Updated', 'Your appointment has been rescheduled by the doctor.');
        }
      }
    });
    
    // Initialize the app when DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
      // Initialize with the alerts tab active
      initAlerts();
      
      // Load saved profile data
      loadProfileData();
      updateUpcomingAppointmentInProfile();
      
      // Add event listener for doctor joining call
      window.addEventListener('storage', function(event) {
        if (event.key === 'doctorJoinedCall') {
          const joinData = JSON.parse(event.newValue);
          
          // Check if this is for the current consultation
          if (activeConsultation && activeConsultation.id === joinData.patientId) {
            showNotification('success', 'Doctor Joined', `Dr. ${activeConsultation.doctor.name} has joined the call.`);
            
            // Update UI to show call is active
            const callStatus = document.getElementById('callStatus');
            if (callStatus) {
              callStatus.textContent = 'Connected with doctor';
            }
          }
        }
        
        // Listen for consultation updates from doctor
        if (event.key === 'consultationUpdated' && event.newValue) {
          const update = JSON.parse(event.newValue);
          
          // Find the consultation
          const consultation = alertsData.consultation.find(c => c.id === update.id);
          if (consultation) {
            // Update data
            consultation.date = update.date;
            consultation.time = update.time;
            
            // Refresh UI
            renderAlerts();
            updateUpcomingAppointmentInProfile();
            
            // Notify patient
            showNotification('success', 'Appointment Updated', 'Your appointment has been rescheduled by the doctor.');
          }
        }
      });
      
      // ... (rest of initialization code)
    });

    // Add this to your existing JavaScript code

/* ---------- API Integration Functions ---------- */

// Function to send connection request to doctor
function sendConnectionRequest(doctorId, patientData) {
  const request = {
    id: 'req_' + Date.now(),
    doctorId: doctorId,
    patientId: patientData.id,
    patientName: patientData.name,
    timestamp: new Date().toISOString(),
    status: 'pending',
    type: 'connection_request'
  };
  
  // Store in localStorage for doctor portal to pick up
  localStorage.setItem(`doctor_request_${doctorId}`, JSON.stringify(request));
  
  // Also store in patient's requests for tracking
  const patientRequests = JSON.parse(localStorage.getItem('patient_requests') || '[]');
  patientRequests.push(request);
  localStorage.setItem('patient_requests', JSON.stringify(patientRequests));
  
  showNotification('success', 'Request Sent', 'Your connection request has been sent to the doctor.');
}

// Function to send payment confirmation to doctor
function sendPaymentConfirmation(consultationId, paymentData) {
  const confirmation = {
    id: 'pay_' + Date.now(),
    consultationId: consultationId,
    patientId: paymentData.patientId,
    amount: paymentData.amount,
    timestamp: new Date().toISOString(),
    status: 'completed',
    type: 'payment_confirmation'
  };
  
  // Store in localStorage for doctor portal to pick up
  localStorage.setItem(`payment_confirmation_${consultationId}`, JSON.stringify(confirmation));
  
  showNotification('success', 'Payment Confirmed', 'Your payment has been confirmed and the doctor has been notified.');
}

// Function to notify doctor when patient joins consultation
function notifyDoctorJoining(consultationId, patientData) {
  const notification = {
    id: 'join_' + Date.now(),
    consultationId: consultationId,
    patientId: patientData.id,
    patientName: patientData.name,
    timestamp: new Date().toISOString(),
    status: 'joined',
    type: 'patient_joined'
  };
  
  // Store in localStorage for doctor portal to pick up
  localStorage.setItem(`patient_joined_${consultationId}`, JSON.stringify(notification));
}

// Function to send chat message to doctor
function sendChatMessage(consultationId, messageData) {
  const message = {
    id: 'msg_' + Date.now(),
    consultationId: consultationId,
    sender: 'patient',
    senderName: messageData.senderName,
    content: messageData.content,
    timestamp: new Date().toISOString(),
    type: 'chat_message'
  };
  
  // Store in localStorage for doctor portal to pick up
  localStorage.setItem(`chat_message_${consultationId}_${message.id}`, JSON.stringify(message));
  
  // Also store in patient's chat history
  const chatHistory = JSON.parse(localStorage.getItem(`chat_history_${consultationId}`) || '[]');
  chatHistory.push(message);
  localStorage.setItem(`chat_history_${consultationId}`, JSON.stringify(chatHistory));
}

// Function to send reschedule request to doctor
function sendRescheduleRequest(consultationId, requestData) {
  const request = {
    id: 'resched_' + Date.now(),
    consultationId: consultationId,
    patientId: requestData.patientId,
    patientName: requestData.patientName,
    currentDateTime: requestData.currentDateTime,
    requestedDateTime: requestData.requestedDateTime,
    reason: requestData.reason,
    timestamp: new Date().toISOString(),
    status: 'pending',
    type: 'reschedule_request'
  };
  
  // Store in localStorage for doctor portal to pick up
  localStorage.setItem(`reschedule_request_${consultationId}`, JSON.stringify(request));
  
  showNotification('success', 'Request Sent', 'Your reschedule request has been sent to the doctor.');
}

// Function to listen for responses from doctor
function setupDoctorResponseListener() {
  window.addEventListener('storage', function(event) {
    if (event.key && event.key.startsWith('doctor_response_')) {
      const response = JSON.parse(event.newValue);
      handleDoctorResponse(response);
    }
  });
}

// Function to handle doctor responses
function handleDoctorResponse(response) {
  switch (response.type) {
    case 'connection_accepted':
      showNotification('success', 'Request Accepted', `Dr. ${response.doctorName} has accepted your connection request.`);
      break;
    case 'connection_rejected':
      showNotification('warning', 'Request Rejected', `Dr. ${response.doctorName} is currently unavailable.`);
      break;
    case 'reschedule_accepted':
      showNotification('success', 'Reschedule Accepted', `Your appointment has been rescheduled to ${response.newDateTime}.`);
      updateAppointmentTime(response.consultationId, response.newDateTime);
      break;
    case 'reschedule_rejected':
      showNotification('warning', 'Reschedule Rejected', `Dr. ${response.doctorName} cannot accommodate the requested time.`);
      break;
    case 'prescription_sent':
      showNotification('success', 'Prescription Received', `Dr. ${response.doctorName} has sent your prescription.`);
      break;
  }
}

// Function to update appointment time in UI
function updateAppointmentTime(consultationId, newDateTime) {
  const consultation = alertsData.consultation.find(c => c.id === consultationId);
  if (consultation) {
    const [date, time] = newDateTime.split(' at ');
    consultation.date = date;
    consultation.time = time;
    
    // Update UI
    renderAlerts();
    updateAlertCounts();
    updateUpcomingAppointmentInProfile();
  }
}

// Enhanced submitProblem function with API integration
function submitProblem() {
  const problemText = document.getElementById('problemDescription').value.trim();
  if (!problemText) {
    showNotification('warning', 'Validation', 'Please describe your problem before submitting');
    return;
  }
  
  // Get patient profile data
  const patientProfile = JSON.parse(localStorage.getItem('patientProfileData') || '{}');
  const patientId = patientProfile.patientId || 'PAT-001';
  
  // Create connection request
  const request = {
    id: patientId,
    patientId: patientId,
    patientName: patientProfile.name || 'Gurpreet Kaur',
    age: patientProfile.age || 32,
    gender: patientProfile.gender || 'female',
    status: "pending",
    cc: problemText,
    complaint: problemText,
    prescription: "",
    vitals: {pulse: 0, spo2: 0, temp: ""},
    hx: [],
    meds: [],
    lastVisit: "",
    reports: [],
    blockchain: { verified: false, hash: "" },
    isAppointmentRequest: true,
    doctorId: currentDoctorId,
    doctorName: currentDoctorName,
    problem: problemText,
    language: currentLanguage,
    timestamp: Date.now()
  };
  
  // Send request to doctor via localStorage
  sendConnectionRequest(currentDoctorId, request);
  
  // Store in patient's localStorage for tracking
  localStorage.setItem(`nabhacare_appointment_request_${patientId}`, JSON.stringify(request));
  
  const patientRequests = JSON.parse(localStorage.getItem('patientAppointmentRequests') || '[]');
  patientRequests.push({
    id: patientId,
    doctorId: currentDoctorId,
    doctorName: currentDoctorName,
    problem: problemText,
    status: 'pending',
    timestamp: Date.now()
  });
  localStorage.setItem('patientAppointmentRequests', JSON.stringify(patientRequests));
  
  showNotification('success', 'Request Sent', `Your request has been sent to ${currentDoctorName}. They will contact you soon.`);
  closeConnectModal();
}

// Enhanced processPayment function with API integration
async function processPayment() {
  const payButton = event.target;
  const consultation = alertsData.consultation.find(c => c.id === targetConsultationId);
  if (!consultation) {
    showNotification('error', 'Error', 'Consultation not found.');
    return;
  }

  // Add loading state
  payButton.classList.add('btn-loading');
  payButton.innerHTML = '<span class="loading-spinner"></span>';

  // --- DIRECTLY OPEN RAZORPAY CHECKOUT (Test Mode) ---
  const options = {
    key: "rzp_test_RDrYTwDy9w9Ysm", // Replace with your test key
    amount: consultation.doctor.fee * 100, // Amount in paise
    currency: "INR",
    name: "SehatSetuNabha",
    description: "Consultation Fee",
    handler: function (response) {
      // --- MOCK SUCCESS ---
      showNotification('success', 'Payment', 'Payment successful!');
      closePaymentModal();
      
      // Update consultation status
      consultation.paymentStatus = 'completed';
      consultation.status = 'active';
      localStorage.setItem('alertsData', JSON.stringify(alertsData));

      // Send payment confirmation to doctor
      sendPaymentConfirmation(consultation.id, {
        patientId: consultation.id,
        amount: consultation.doctor.fee,
        paymentId: response.razorpay_payment_id
      });

      // Refresh UI
      checkActiveConsultation();
      renderAlerts();
      updateAlertCounts();
      
      // Show payment success modal
      document.getElementById('paymentSuccessModal').classList.remove('hidden');

      // Start consultation after a short delay
      setTimeout(() => {
        if (activeConsultation && activeConsultation.id === targetConsultationId) {
          startConsultation();
          document.getElementById('paymentSuccessModal').classList.add('hidden');
        }
      }, 2000);

      targetConsultationId = null;
      // Revert button state
      payButton.classList.remove('btn-loading');
      payButton.textContent = 'Pay Now';
    },
    modal: {
      ondismiss: function() {
        showNotification('info', 'Cancelled', 'Payment cancelled.');
        payButton.classList.remove('btn-loading');
        payButton.textContent = 'Pay Now';
      }
    },
    theme: {
      color: "#2c6d52"
    }
  };

  const rzp = new Razorpay(options);
  rzp.open();
}

// Enhanced joinConsultation function with API integration
function joinConsultation(consultationId) {
  let consultation = activeConsultation;
  if (consultationId) {
    consultation = alertsData.consultation.find(c => c.id === consultationId);
    targetConsultationId = consultationId;
  }
  
  if (!consultation) {
    showNotification('error', 'Error', 'Consultation not found.');
    return;
  }
  
  if (consultation.paymentStatus !== 'completed') {
    openPaymentModal(consultationId);
    return;
  }
  
  activeConsultation = consultation;
  
  // Notify doctor that patient is joining
  notifyDoctorJoining(consultation.id, {
    id: consultation.id,
    name: document.getElementById('patTopName').textContent || 'Patient'
  });
  
  // Store in localStorage for doctor to receive
  localStorage.setItem('patientJoinedConsultation', JSON.stringify({
    consultationId: consultation.consultationId || consultation.id,
    patientId: consultation.id,
    timestamp: Date.now()
  }));
  
  startConsultation();
}

// Enhanced sendMessage function with API integration
async function sendMessage() {
  const input = document.getElementById('chatInput');
  const message = input.value.trim();
  
  if (message) {
    // Send message to doctor via localStorage
    sendChatMessage(activeConsultation.consultationId, {
      senderName: 'Gurpreet Kaur',
      content: message
    });
    
    // Add message to local chat
    const newMessage = {
      id: chatMessages[activeConsultation.consultationId].length + 1,
      sender: 'patient',
      name: 'Gurpreet Kaur',
      message: message,
      time: 'Now'
    };
    
    chatMessages[activeConsultation.consultationId].push(newMessage);
    
    const chatContainer = document.getElementById('chatMessages');
    const messageHtml = `
      <div style="margin-bottom:12px;display:flex;flex-direction:row-reverse">
        <div style="max-width:70%;background:#e3f2fd;padding:8px 12px;border-radius:12px">
          <div style="font-weight:600;margin-bottom:4px">${newMessage.name}</div>
          <div>${newMessage.message}</div>
          <div class="small muted" style="text-align:right">${newMessage.time}</div>
        </div>
      </div>
    `;
    
    chatContainer.innerHTML += messageHtml;
    chatContainer.scrollTop = chatContainer.scrollHeight;
    
    // Clear input
    input.value = '';
    
    // Show typing indicator
    showTypingIndicator();
  }
}

// Enhanced selectTimeSlot function with API integration
function selectTimeSlot(alertId, slot) {
  const reason = document.getElementById('rescheduleReason')?.value || 'Patient requested reschedule';
  
  const consultation = alertsData.consultation.find(a => a.id === alertId);
  if (consultation) {
    // Send reschedule request to doctor
    sendRescheduleRequest(consultation.id, {
      patientId: consultation.id,
      patientName: document.getElementById('patTopName')?.textContent || 'Patient',
      currentDateTime: `${consultation.date} at ${consultation.time}`,
      requestedDateTime: slot,
      reason: reason
    });
    
    // Store in localStorage for doctor to receive
    const request = {
      id: 'req-' + Date.now(),
      consultationId: consultation.id,
      patientId: consultation.id,
      patientName: document.getElementById('patTopName')?.textContent || 'Patient',
      doctorId: consultation.doctor.id,
      currentDate: consultation.date,
      currentTime: consultation.time,
      requestedDate: slot.split(' at ')[0],
      requestedTime: slot.split(' at ')[1],
      reason: reason,
      status: 'pending',
      timestamp: Date.now()
    };
    
    localStorage.setItem('rescheduleRequest', JSON.stringify(request));
    localStorage.setItem('newRescheduleRequest', JSON.stringify(request));
    
    closeRecordModal();
    closeAppointmentDetails();
    showNotification('info', 'Request Sent', 'Your reschedule request has been sent to the doctor.');
  }
}

// Initialize the API integration
document.addEventListener('DOMContentLoaded', function() {
  // Setup listener for doctor responses
  setupDoctorResponseListener();
  
  // Rest of your initialization code...
  initAlerts();
  loadProfileData();
  updateUpcomingAppointmentInProfile();
});
    </script>
<!-- Record Detail Modal (for rescheduling, etc.) -->
<div id="recordDetailModal" class="family-member-panel">
  <div class="family-member-content" style="max-width: 500px;">
    <div class="family-member-header">
      <h3 id="recordModalTitle">Modal Title</h3>
      <button class="family-member-close" onclick="closeRecordModal()">&times;</button>
    </div>
    <div id="recordDetailContent" style="padding: 20px;">
      <!-- Content will be injected by JavaScript -->
    </div>
  </div>
</div>
<script src="app.js"></script>
</body>
</html>
  
  